<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gibchick - Ultimate Idle Clicker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Fredoka', sans-serif;
            transition: background 1s ease, color 0.5s ease;
            overscroll-behavior: none;
            user-select: none;
        }

        /* Dynamic Background Classes */
        .bg-world-home { background: linear-gradient(135deg, #e0f7fa 0%, #80deea 100%); }
        .bg-world-spooky { background: linear-gradient(135deg, #2d1b4e 0%, #1a102e 100%); color: black; }
        .bg-world-jurassic { background: linear-gradient(135deg, #fed7aa 0%, #fb923c 100%); }
        .bg-world-frozen { background: linear-gradient(135deg, #cffafe 0%, #67e8f9 100%); }
        .bg-world-magic { background: linear-gradient(135deg, #fbcfe8 0%, #f472b6 100%); }
        .bg-world-space { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); color: #1f2937; } 
        .bg-world-divine { background: linear-gradient(135deg, #fef9c3 0%, #facc15 100%); }
        
        /* New Worlds */
        .bg-world-cyber { background: linear-gradient(135deg, #0f172a 0%, #0ea5e9 100%); color: #1f2937; }
        .bg-world-volcano { background: linear-gradient(135deg, #450a0a 0%, #ef4444 100%); color: #fecaca; }
        .bg-world-candy { background: linear-gradient(135deg, #fdf4ff 0%, #f5d0fe 100%); color: #86198f; }
        .bg-world-atlantis { background: linear-gradient(135deg, #022c22 0%, #0d9488 100%); color: #1f2937; }
        .bg-world-shadow { background: linear-gradient(135deg, #000000 0%, #581c87 100%); color: #1f2937; }
        .bg-world-celestial { background: linear-gradient(135deg, #fffbeb 0%, #fcd34d 50%, #fffbeb 100%); color: #78350f; }

        /* Chickverse Worlds */
        .bg-world-gold { background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%); color: #7c5e10; }
        .bg-world-rainbow { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 20%, #a18cd1 100%); color: #4a044e; }
        .bg-world-mecha { background: linear-gradient(135deg, #2c3e50 0%, #bdc3c7 100%); color: #1f2937; }
        .bg-world-darkmatter { background: linear-gradient(135deg, #000000 0%, #434343 100%); color: #1f2937; }

        /* General Dark Text overrides for dark backgrounds */
        .bg-world-space .bg-white, .bg-world-cyber .bg-white, 
        .bg-world-atlantis .bg-white, .bg-world-shadow .bg-white,
        .bg-world-mecha .bg-white, .bg-world-darkmatter .bg-white { 
            background-color: rgba(255,255,255,0.1); 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.2); 
            color: #fff;
        }
        
        .bg-world-space .text-gray-800, 
        .bg-world-cyber .text-gray-800, .bg-world-atlantis .text-gray-800,
        .bg-world-shadow .text-gray-800, .bg-world-mecha .text-gray-800,
        .bg-world-darkmatter .text-gray-800 { color: #f3f4f6; }

        .bg-world-space .text-gray-500,
        .bg-world-cyber .text-gray-500, .bg-world-atlantis .text-gray-500,
        .bg-world-shadow .text-gray-500, .bg-world-mecha .text-gray-500,
        .bg-world-darkmatter .text-gray-500 { color: #9ca3af; }

        .shake-animation {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0) rotate(-5deg); }
            20%, 80% { transform: translate3d(2px, 0, 0) rotate(5deg); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0) rotate(-5deg); }
            40%, 60% { transform: translate3d(4px, 0, 0) rotate(5deg); }
        }

        .pop-in {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.5); }
            100% { opacity: 1; transform: scale(1); }
        }

        .float-text {
            position: absolute;
            animation: floatUp 1s forwards;
            pointer-events: none;
            font-weight: bold;
            color: #10b981;
            text-shadow: 1px 1px 0 #fff;
            z-index: 50;
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }

        /* Rarity Gradients */
        .rarity-common { background: linear-gradient(to bottom right, #f3f4f6, #d1d5db); border: 2px solid #9ca3af; color: #1f2937; }
        .rarity-uncommon { background: linear-gradient(to bottom right, #d1fae5, #6ee7b7); border: 2px solid #10b981; color: #064e3b; }
        .rarity-rare { background: linear-gradient(to bottom right, #dbeafe, #60a5fa); border: 2px solid #2563eb; color: #1e3a8a; }
        .rarity-epic { background: linear-gradient(to bottom right, #f3e8ff, #c084fc); border: 2px solid #9333ea; color: #4c1d95; }
        .rarity-legendary { background: linear-gradient(to bottom right, #fef3c7, #fcd34d); border: 2px solid #d97706; box-shadow: 0 0 10px #fbbf24; color: #78350f; }
        .rarity-mythical { background: linear-gradient(to bottom right, #fee2e2, #f87171); border: 2px solid #dc2626; box-shadow: 0 0 15px #ef4444; animation: pulse-mythical 2s infinite; color: #7f1d1d; }
        
        .rarity-godly {
            background: linear-gradient(to bottom right, #2d2d2d, #000000);
            border: 2px solid #a8a8a8;
            box-shadow: 0 0 20px #ffffff;
            color: white;
            animation: pulse-godly 3s infinite;
        }
        .rarity-godly .text-gray-700 { color: #fff !important; }
        .rarity-godly .text-gray-500 { color: #ccc !important; }
        .rarity-godly .bg-white\/50 { background: rgba(255,255,255,0.2); }

        .rarity-transcendent {
            background: linear-gradient(to bottom right, #000000, #1a1a2e, #16213e);
            border: 3px solid #ffd700;
            box-shadow: 0 0 30px #ffd700, 0 0 60px #ffd700;
            color: #ffd700;
            animation: pulse-transcendent 2s infinite;
        }
        .rarity-transcendent .text-gray-700 { color: #ffd700 !important; }
        .rarity-transcendent .text-gray-500 { color: #ffed4e !important; }
        .rarity-transcendent .bg-white\/50 { background: rgba(255,215,0,0.3); }

        .rarity-eternal {
            background: linear-gradient(to bottom right, #0891b2, #ecfeff, #0891b2);
            border: 3px solid #22d3ee;
            box-shadow: 0 0 40px #22d3ee, 0 0 80px #67e8f9;
            color: #0e7490;
            animation: pulse-eternal 4s infinite;
        }
        .rarity-eternal .text-gray-700 { color: #164e63 !important; }
        .rarity-eternal .text-gray-500 { color: #155e75 !important; }
        
        .rarity-special {
            background: linear-gradient(to bottom right, #ffafbd, #ffc3a0);
            border: 3px solid #ff6b6b;
            box-shadow: 0 0 20px #ff6b6b;
            color: #881337;
        }

        @keyframes pulse-godly {
            0% { box-shadow: 0 0 10px #ffffff; }
            50% { box-shadow: 0 0 30px #888, 0 0 50px #fff; }
            100% { box-shadow: 0 0 10px #ffffff; }
        }

        @keyframes pulse-mythical {
            0% { box-shadow: 0 0 10px #ef4444; }
            50% { box-shadow: 0 0 20px #f87171, 0 0 40px #fca5a5; }
            100% { box-shadow: 0 0 10px #ef4444; }
        }

        @keyframes pulse-transcendent {
            0% { box-shadow: 0 0 20px #ffd700, 0 0 40px #ffd700; }
            50% { box-shadow: 0 0 40px #ffd700, 0 0 80px #ffed4e, 0 0 120px #ffd700; }
            100% { box-shadow: 0 0 20px #ffd700, 0 0 40px #ffd700; }
        }

        @keyframes pulse-eternal {
            0% { background-position: 0% 50%; box-shadow: 0 0 30px #22d3ee; }
            50% { background-position: 100% 50%; box-shadow: 0 0 60px #67e8f9, 0 0 90px #a5f3fc; }
            100% { background-position: 0% 50%; box-shadow: 0 0 30px #22d3ee; }
        }

        /* Styles */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); }
        
        .pet-silhouette { filter: brightness(0) opacity(0.2); }
        .pet-locked-text { color: transparent; text-shadow: 0 0 8px rgba(0,0,0,0.5); }
    </style>
</head>
<body id="game-body" class="h-screen flex flex-col overflow-hidden text-gray-800 bg-world-home">

    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-md shadow-md p-4 flex justify-between items-center z-10 shrink-0">
        <div class="flex items-center gap-3">
            <div class="text-3xl">üê£</div>
            <div>
                <h1 class="font-bold text-xl leading-none text-purple-600">Gibchick</h1>
                <span class="text-xs text-gray-500">Collect 'em all!</span>
            </div>
            <!-- Admin Button -->
            <button onclick="openAdminModal()" class="ml-2 text-gray-400 hover:text-red-500 transition text-sm" title="Admin">
                <i class="fas fa-user-shield"></i>
            </button>
            <!-- Rebirth Button -->
            <button onclick="openRebirthModal()" class="ml-2 text-purple-500 hover:text-purple-700 transition text-sm animate-pulse" title="Rebirth">
                <i class="fas fa-sync-alt text-xl"></i>
            </button>
            <button onclick="openIndexModal()" class="ml-2 text-blue-400 hover:text-blue-600 transition text-sm" title="Pet Index">
                <i class="fas fa-book-open text-xl"></i>
            </button>
            <button onclick="openResetModal()" class="ml-2 text-gray-300 hover:text-red-500 transition text-sm" title="Reset Progress">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>
        
        <div class="flex gap-6 text-right">
            <div>
                <div class="text-xs text-gray-500 font-bold uppercase">Cash</div>
                <div class="text-2xl font-bold text-green-600 flex items-center gap-1 justify-end">
                    $<span id="money-display">0</span>
                </div>
            </div>
            <div>
                <div class="text-xs text-gray-500 font-bold uppercase">Income</div>
                <div class="text-xl font-bold text-blue-500 flex items-center gap-1 justify-end">
                    $<span id="income-display">0</span><span class="text-sm text-gray-400">/s</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
        
        <!-- Left Panel -->
        <section class="flex-1 p-4 overflow-y-auto flex flex-col gap-6 relative" id="click-area">
            
            <div class="bg-white/90 backdrop-blur rounded-2xl shadow-lg p-6 text-center transform hover:scale-[1.02] transition-transform cursor-pointer active:scale-95 select-none text-gray-800" onclick="manualClick(event)">
                <div class="text-6xl mb-2">üê•</div>
                <h2 class="font-bold text-xl mb-1">Click for Cash!</h2>
                <p class="text-gray-500 text-sm">Get quick money to buy eggs</p>
                <div id="rebirth-multiplier-display" class="text-xs text-purple-600 font-bold mt-2 hidden">Rebirth Multiplier: x1</div>
            </div>

            <!-- World Selector & Egg Shop -->
            <div>
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-lg flex items-center gap-2">
                        <i class="fas fa-globe text-blue-500"></i> Worlds
                    </h3>
                    <div class="text-xs text-gray-500" id="world-status">Home Village</div>
                </div>
                
                <!-- Galaxy Navigation -->
                <div class="flex gap-2 overflow-x-auto pb-2 mb-2 scrollbar-hide border-b border-gray-200/20" id="galaxy-nav-container"></div>
                <!-- World Navigation Scroll -->
                <div class="flex gap-2 overflow-x-auto pb-4 mb-2 scrollbar-hide" id="world-nav-container"></div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4" id="egg-shop-container"></div>
             </div>

             <!-- Upgrades -->
             <div>
                 <h3 class="font-bold text-lg mb-3 flex items-center gap-2">
                     <i class="fas fa-arrow-up text-purple-500"></i> Upgrades
                 </h3>
                 <div id="upgrades-container" class="grid grid-cols-1 gap-3"></div>
             </div>

             <!-- Achievements -->
             <div>
                 <h3 class="font-bold text-lg mb-3 flex items-center gap-2">
                     <i class="fas fa-trophy text-yellow-500"></i> Achievements
                     <span id="achievement-count" class="bg-yellow-100 text-yellow-600 px-2 py-0.5 rounded-full text-xs">0/14</span>
                 </h3>
                 <div id="achievements-container" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto"></div>
             </div>
         </section>

         <!-- Right Panel -->
        <section class="flex-1 bg-white/50 backdrop-blur-sm border-l border-white/20 p-4 overflow-y-auto flex flex-col">
            <div class="flex justify-between items-center mb-4 gap-2 flex-wrap">
                <h3 class="font-bold text-lg flex items-center gap-2">
                    <i class="fas fa-paw text-purple-500"></i> My Pets
                    <span id="pet-count" class="bg-purple-100 text-purple-600 px-2 py-0.5 rounded-full text-xs">0</span>
                </h3>
                <div class="flex gap-2">
                    <select id="sort-inventory" onchange="updateSortSetting(this.value)" class="bg-white border border-gray-300 text-gray-700 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5">
                        <option value="rarity_desc">Rarity (High)</option>
                        <option value="rarity_asc">Rarity (Low)</option>
                        <option value="power_desc">Power (High)</option>
                        <option value="newest">Newest</option>
                        <option value="name">Name</option>
                    </select>
                    <button onclick="openMergeModal()" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded-full transition shadow-sm flex items-center gap-1">
                        <i class="fas fa-random"></i> Merge
                    </button>
                </div>
            </div>
            
            <div class="relative flex-1 overflow-y-auto pr-1">
                <div id="empty-inventory" class="text-center py-10 text-gray-400 italic">
                    You have no pets yet. Buy an egg to start!
                </div>
                
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 gap-3 content-start pb-4" id="inventory-container"></div>
            </div>
        </section>

    </main>

    <!-- Overlays -->
    <div id="admin-modal" class="fixed inset-0 bg-black/90 z-[100] hidden flex items-center justify-center backdrop-blur-sm p-4 text-gray-800">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 relative">
            <button onclick="closeAdminModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-4 text-center text-red-600"><i class="fas fa-user-shield"></i> Admin Panel</h2>
            <div id="admin-login-view">
                <p class="text-sm text-gray-600 mb-4 text-center">Enter Access Code</p>
                <input type="password" id="admin-password-input" class="w-full border p-2 rounded mb-4 text-center text-xl tracking-widest" placeholder="----">
                <button onclick="checkAdminPassword()" class="w-full bg-red-600 text-white font-bold py-2 rounded hover:bg-red-700 transition">Unlock</button>
            </div>
            <div id="admin-dashboard-view" class="hidden space-y-4">
                <div class="bg-gray-100 p-3 rounded">
                    <label class="block text-xs font-bold text-gray-500 mb-1">ADD CASH</label>
                    <div class="flex gap-2">
                        <input type="number" id="admin-money-input" class="flex-1 border p-2 rounded text-sm" placeholder="Amount">
                        <button onclick="adminAddMoney()" class="bg-green-500 text-white px-3 rounded font-bold hover:bg-green-600">+</button>
                    </div>
                </div>
                <div class="bg-gray-100 p-3 rounded">
                    <label class="block text-xs font-bold text-gray-500 mb-1">GIVE PET</label>
                    <div class="flex gap-2">
                        <select id="admin-pet-select" class="flex-1 border p-2 rounded text-sm bg-white"></select>
                        <button onclick="adminAddPet()" class="bg-blue-500 text-white px-3 rounded font-bold hover:bg-blue-600">+</button>
                    </div>
                </div>
                <div class="bg-gray-100 p-3 rounded">
                    <label class="block text-xs font-bold text-gray-500 mb-1">SET REBIRTH LEVEL</label>
                    <div class="flex gap-2">
                        <input type="number" id="admin-rebirth-input" class="flex-1 border p-2 rounded text-sm" placeholder="Level (0-1000)">
                        <button onclick="adminSetRebirth()" class="bg-purple-600 text-white px-3 rounded font-bold hover:bg-purple-700">SET</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="hatch-overlay" class="fixed inset-0 bg-black/80 z-50 hidden flex flex-col items-center justify-center backdrop-blur-sm p-4 overflow-y-auto">
        <div class="relative flex flex-col items-center justify-center w-full min-h-[50vh]">
            <div id="hatch-egg-display" class="transition-all duration-300 cursor-pointer relative z-10"></div>
            <div id="hatch-rays" class="absolute inset-0 bg-yellow-400 rounded-full blur-3xl opacity-0 transition-opacity duration-500 -z-10 animate-pulse pointer-events-none"></div>
            <div id="hatch-message" class="text-white text-2xl font-bold mt-8 text-center h-8 z-20">Tap to Hatch!</div>
            <div id="new-pet-card" class="hidden transform transition-all duration-500 z-30">
                <div class="bg-white p-6 rounded-2xl shadow-2xl text-center w-64 border-4" id="reveal-card-bg">
                    <div class="text-sm font-bold uppercase tracking-wider mb-2" id="reveal-rarity">Common</div>
                    <div class="text-8xl mb-4 pop-in" id="reveal-icon">üê•</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-1" id="reveal-name">Baby Chick</h2>
                    <div class="text-green-600 font-bold text-lg mb-4">+$<span id="reveal-rate">1</span>/s</div>
                    <button onclick="closeHatchModal()" class="bg-gray-800 text-white px-6 py-2 rounded-full font-bold hover:bg-gray-700 transition w-full">Awesome!</button>
                </div>
            </div>
            <div id="multi-pet-grid" class="hidden grid grid-cols-2 sm:grid-cols-3 gap-4 max-w-3xl w-full z-30 mt-4"></div>
            <button id="multi-hatch-close-btn" onclick="closeHatchModal()" class="hidden mt-8 bg-gray-800 text-white px-8 py-3 rounded-full font-bold hover:bg-gray-700 transition shadow-lg z-40 animate-bounce">Awesome!</button>
        </div>
    </div>

    <div id="egg-info-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden text-gray-800">
            <div id="egg-info-header" class="p-4 bg-gray-100 border-b flex justify-between items-center">
                <h2 class="font-bold text-xl flex items-center gap-2" id="egg-info-title">Egg Info</h2>
                <button onclick="closeEggInfo()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 max-h-[60vh] overflow-y-auto">
                <div id="egg-info-list" class="space-y-2"></div>
            </div>
            <div class="p-4 bg-gray-50 border-t text-center text-xs text-gray-500">Good luck!</div>
        </div>
    </div>

    <div id="merge-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[80vh] text-gray-800">
            <div class="p-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white flex justify-between items-center shrink-0">
                <div>
                    <h2 class="font-bold text-xl"><i class="fas fa-flask"></i> Merge Chamber</h2>
                    <p class="text-xs opacity-90">Fuse 3 identical pets to upgrade!</p>
                </div>
                <button onclick="closeMergeModal()" class="text-white/80 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 overflow-y-auto flex-1 bg-gray-50">
                <div id="merge-list" class="space-y-3"></div>
                <div id="no-merge-msg" class="hidden text-center py-8 text-gray-400">
                    <div class="text-4xl mb-2">üß¨</div>
                    <p>You need 3 of the same pet to merge.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="index-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[90vh] overflow-hidden flex flex-col text-gray-800">
            <div class="p-4 bg-blue-600 text-white flex justify-between items-center shrink-0">
                <div>
                    <h2 class="font-bold text-2xl flex items-center gap-2"><i class="fas fa-book-open"></i> Pet Index</h2>
                    <p class="text-sm opacity-90" id="index-progress-text">Collected: 0/0</p>
                </div>
                <button onclick="closeIndexModal()" class="text-white/80 hover:text-white text-2xl"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 bg-gray-100">
                <div id="index-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4"></div>
            </div>
            <div class="p-4 bg-white border-t flex flex-col sm:flex-row items-center justify-between gap-4">
                <div>
                    <h3 class="font-bold text-lg text-gray-800">Completion Reward</h3>
                    <p class="text-xs text-gray-500">Collect all standard pets to unlock the Guardian Griffin!</p>
                </div>
                <button id="claim-reward-btn" onclick="claimIndexReward()" disabled class="bg-gray-300 text-gray-500 font-bold py-3 px-8 rounded-full transition cursor-not-allowed flex items-center gap-2">
                    <span>Locked</span> <i class="fas fa-lock"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="rebirth-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-gray-900 border border-purple-500 rounded-2xl shadow-2xl w-full max-w-md p-6 text-center text-white relative overflow-hidden">
            <div class="absolute inset-0 bg-purple-600 opacity-10 animate-pulse pointer-events-none"></div>
            <div class="relative z-10">
                <div class="text-5xl mb-4">üåÄ</div>
                <h2 class="text-3xl font-bold mb-2 text-purple-300">Rebirth</h2>
                <div id="rebirth-info" class="mb-6">
                    <p class="text-gray-300 mb-2">Current Multiplier: <span id="rebirth-current-mult" class="text-green-400 font-bold">x1</span></p>
                    <p class="text-gray-300 mb-4">Rebirth Level: <span id="rebirth-current-level" class="text-blue-400 font-bold">0</span></p>
                    <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                        <div class="text-sm font-bold uppercase text-gray-500 mb-2">Next Rebirth Requirements</div>
                        <div id="rebirth-reqs" class="text-xl font-bold flex justify-center items-center gap-2 mb-2"></div>
                        <div class="text-xs text-gray-400 italic">Sacrifice these pets to ascend.</div>
                        <div class="mt-3 pt-3 border-t border-gray-700">
                            <div class="text-sm">New Multiplier: <span id="rebirth-next-mult" class="text-purple-400 font-bold text-lg">x1.5</span></div>
                            <div class="text-sm text-yellow-300 mt-1" id="rebirth-unlock-msg"></div>
                        </div>
                    </div>
                </div>
                <p class="text-red-400 text-xs mb-6">Warning: Rebirthing resets your Money, Inventory, and Upgrades. Achievements and Index are saved.</p>
                <div class="flex gap-3 justify-center">
                    <button onclick="closeRebirthModal()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full transition">Cancel</button>
                    <button onclick="performRebirth()" id="rebirth-confirm-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-8 rounded-full transition shadow-lg shadow-purple-500/30 disabled:opacity-50 disabled:cursor-not-allowed">Rebirth</button>
                </div>
            </div>
        </div>
    </div>

    <div id="reset-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center text-gray-800">
            <div class="text-red-500 text-5xl mb-4"><i class="fas fa-exclamation-triangle"></i></div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Reset Account?</h2>
            <p class="text-gray-600 mb-6">Are you sure you want to wipe all your progress? This cannot be undone.</p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeResetModal()" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-full hover:bg-gray-300 transition">Cancel</button>
                <button onclick="confirmReset()" class="bg-red-500 text-white font-bold py-2 px-6 rounded-full hover:bg-red-600 transition">Reset</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-[60] text-sm font-bold text-center">Notification</div>
    <div id="pet-tooltip" class="fixed bg-white rounded-lg shadow-xl border-2 border-gray-200 p-3 opacity-0 transition-opacity duration-200 pointer-events-none z-[70] text-sm max-w-xs text-gray-800"><div id="pet-tooltip-content"></div></div>

    <script>
        // --- DATA ---
        const GALAXIES = [
            { id: 'origin', name: 'Origin System', icon: 'üåå', minRebirth: 0, worlds: ['home', 'spooky', 'jurassic', 'frozen', 'magic'] },
            { id: 'astral', name: 'Astral Sector', icon: 'ü™ê', minRebirth: 5, worlds: ['space', 'divine', 'cyber', 'volcano'] },
            { id: 'mystic', name: 'Mystic Reach', icon: '‚ú®', minRebirth: 11, worlds: ['candy', 'atlantis', 'shadow', 'celestial'] },
            { id: 'chickverse', name: 'Chickverse', icon: 'üê£', minRebirth: 20, worlds: ['gold', 'rainbow', 'mecha', 'darkmatter'] }
        ];

        const WORLDS = [
            { id: 'home', name: 'Home Village', minRebirth: 0, bgClass: 'bg-world-home', eggIds: ['starter', 'farm', 'aqua', 'desert'] },
            { id: 'spooky', name: 'Haunted Forest', minRebirth: 1, bgClass: 'bg-world-spooky', eggIds: ['spooky', 'forest'] },
            { id: 'jurassic', name: 'Jurassic Isle', minRebirth: 2, bgClass: 'bg-world-jurassic', eggIds: ['prehistoric', 'jungle'] },
            { id: 'frozen', name: 'Frozen Tundra', minRebirth: 3, bgClass: 'bg-world-frozen', eggIds: ['arctic'] },
            { id: 'magic', name: 'Magic Realm', minRebirth: 4, bgClass: 'bg-world-magic', eggIds: ['fantasy', 'mystery'] },
            { id: 'space', name: 'Deep Space', minRebirth: 5, bgClass: 'bg-world-space', eggIds: ['cosmic', 'void'] },
            { id: 'divine', name: 'Divine Plane', minRebirth: 6, bgClass: 'bg-world-divine', eggIds: ['divine'] },
            { id: 'cyber', name: 'Cyber City', minRebirth: 9, bgClass: 'bg-world-cyber', eggIds: ['cyber'] },
            { id: 'volcano', name: 'Volcanic Core', minRebirth: 10, bgClass: 'bg-world-volcano', eggIds: ['magma'] },
            { id: 'candy', name: 'Candy Land', minRebirth: 11, bgClass: 'bg-world-candy', eggIds: ['sugar'] },
            { id: 'atlantis', name: 'Atlantis', minRebirth: 12, bgClass: 'bg-world-atlantis', eggIds: ['abyssal'] },
            { id: 'shadow', name: 'Shadow Realm', minRebirth: 13, bgClass: 'bg-world-shadow', eggIds: ['eclipse'] },
            { id: 'celestial', name: 'Celestial Haven', minRebirth: 14, bgClass: 'bg-world-celestial', eggIds: ['ether', 'infinity'] },
            { id: 'gold', name: 'Gilded Coop', minRebirth: 20, bgClass: 'bg-world-gold', eggIds: ['treasury'] },
            { id: 'rainbow', name: 'Prismatic Fields', minRebirth: 25, bgClass: 'bg-world-rainbow', eggIds: ['spectrum'] },
            { id: 'mecha', name: 'Mecha Base', minRebirth: 30, bgClass: 'bg-world-mecha', eggIds: ['machinery'] },
            { id: 'darkmatter', name: 'Void Nexus', minRebirth: 35, bgClass: 'bg-world-darkmatter', eggIds: ['singularity'] }
        ];

        const PETS = {
            'ant': { id: 'ant', name: 'Worker Ant', icon: 'üêú', rate: 1, rarity: 'Common', next: 'chick' },
            'chick': { id: 'chick', name: 'Baby Chick', icon: 'üê•', rate: 2, rarity: 'Common', next: 'mouse' },
            'mouse': { id: 'mouse', name: 'Field Mouse', icon: 'üêÅ', rate: 3, rarity: 'Common', next: 'fish' },
            'fish': { id: 'fish', name: 'Goldfish', icon: 'üê†', rate: 5, rarity: 'Common', next: 'beetle' },
            'beetle': { id: 'beetle', name: 'Beetle', icon: 'üêû', rate: 8, rarity: 'Common', next: 'spider' },
            'spider': { id: 'spider', name: 'Spider', icon: 'üï∑Ô∏è', rate: 12, rarity: 'Common', next: 'bee' },
            'bee': { id: 'bee', name: 'Honey Bee', icon: 'üêù', rate: 16, rarity: 'Common', next: 'cat' },
            'cat': { id: 'cat', name: 'Stray Cat', icon: 'üêà', rate: 20, rarity: 'Uncommon', next: 'dog' },
            'dog': { id: 'dog', name: 'Good Boy', icon: 'üêï', rate: 30, rarity: 'Uncommon', next: 'pig' },
            'pig': { id: 'pig', name: 'Piggy', icon: 'üêñ', rate: 45, rarity: 'Uncommon', next: 'sheep' },
            'sheep': { id: 'sheep', name: 'Sheep', icon: 'üêë', rate: 60, rarity: 'Uncommon', next: 'snake' },
            'snake': { id: 'snake', name: 'Snake', icon: 'üêç', rate: 80, rarity: 'Uncommon', next: 'crab' },
            'crab': { id: 'crab', name: 'Crab', icon: 'ü¶Ä', rate: 100, rarity: 'Uncommon', next: 'frog' },
            'frog': { id: 'frog', name: 'Frog', icon: 'üê∏', rate: 125, rarity: 'Uncommon', next: 'fox' },
            'fox': { id: 'fox', name: 'Sly Fox', icon: 'ü¶ä', rate: 150, rarity: 'Rare', next: 'monkey' },
            'monkey': { id: 'monkey', name: 'Monkey', icon: 'üêí', rate: 200, rarity: 'Rare', next: 'penguin' },
            'penguin': { id: 'penguin', name: 'Penguin', icon: 'üêß', rate: 300, rarity: 'Rare', next: 'owl' },
            'owl': { id: 'owl', name: 'Wise Owl', icon: 'ü¶â', rate: 400, rarity: 'Rare', next: 'camel' },
            'camel': { id: 'camel', name: 'Camel', icon: 'üê´', rate: 500, rarity: 'Rare', next: 'turtle' },
            'turtle': { id: 'turtle', name: 'Turtle', icon: 'üê¢', rate: 650, rarity: 'Rare', next: 'wolf' },
            'wolf': { id: 'wolf', name: 'Wolf', icon: 'üê∫', rate: 800, rarity: 'Rare', next: 'vulture' },
            'vulture': { id: 'vulture', name: 'Vulture', icon: 'ü¶Ö', rate: 1000, rarity: 'Rare', next: 't-rex' },
            't-rex': { id: 't-rex', name: 'T-Rex', icon: 'ü¶ñ', rate: 1500, rarity: 'Epic', next: 'shark' },
            'shark': { id: 'shark', name: 'Great White', icon: 'ü¶à', rate: 1800, rarity: 'Epic', next: 'alien' },
            'alien': { id: 'alien', name: 'Martian', icon: 'üëΩ', rate: 2100, rarity: 'Epic', next: 'robot' },
            'robot': { id: 'robot', name: 'Bot-X', icon: 'ü§ñ', rate: 2500, rarity: 'Epic', next: 'tiger' },
            'tiger': { id: 'tiger', name: 'Bengal Tiger', icon: 'üêÖ', rate: 2900, rarity: 'Epic', next: 'bear' },
            'bear': { id: 'bear', name: 'Grizzly', icon: 'üêª', rate: 3300, rarity: 'Epic', next: 'triceratops' },
            'triceratops': { id: 'triceratops', name: 'Triceratops', icon: 'ü¶ï', rate: 3700, rarity: 'Epic', next: 'pterodactyl' },
            'pterodactyl': { id: 'pterodactyl', name: 'Pterodactyl', icon: 'ü¶á', rate: 4100, rarity: 'Epic', next: 'skeleton' },
            'skeleton': { id: 'skeleton', name: 'Skeleton', icon: 'üíÄ', rate: 4500, rarity: 'Epic', next: 'unicorn' },
            'unicorn': { id: 'unicorn', name: 'Unicorn', icon: 'ü¶Ñ', rate: 5000, rarity: 'Legendary', next: 'dragon' },
            'dragon': { id: 'dragon', name: 'Red Dragon', icon: 'üêâ', rate: 6000, rarity: 'Legendary', next: 'yeti' },
            'yeti': { id: 'yeti', name: 'Abominable', icon: 'ü¶ç', rate: 7500, rarity: 'Legendary', next: 'mammoth' },
            'mammoth': { id: 'mammoth', name: 'Mammoth', icon: 'ü¶£', rate: 10000, rarity: 'Legendary', next: 'reaper' },
            'reaper': { id: 'reaper', name: 'Grim Reaper', icon: 'üïØÔ∏è', rate: 15000, rarity: 'Legendary', next: 'griffin' },
            'griffin': { id: 'griffin', name: 'Chimera', icon: 'ü¶Å', rate: 25000, rarity: 'Legendary', next: 'phoenix' },
            'phoenix': { id: 'phoenix', name: 'Phoenix', icon: 'üî•', rate: 50000, rarity: 'Mythical', next: 'kraken' },
            'kraken': { id: 'kraken', name: 'The Kraken', icon: 'üêô', rate: 100000, rarity: 'Mythical', next: 'hydra' },
            'hydra': { id: 'hydra', name: 'Hydra', icon: 'üêç', rate: 250000, rarity: 'Mythical', next: 'titan' },
            'titan': { id: 'titan', name: 'Titan', icon: 'üóø', rate: 500000, rarity: 'Mythical', next: 'void' },
            'void': { id: 'void', name: 'The Void', icon: 'üåå', rate: 1000000, rarity: 'Godly', next: 'cosmos' },
            'cosmos': { id: 'cosmos', name: 'The Cosmos', icon: 'üåå', rate: 5000000, rarity: 'Transcendent', next: 'cyborg' },
            'cyborg': { id: 'cyborg', name: 'Cyborg', icon: 'ü§ñ', rate: 25000000, rarity: 'Godly', next: 'magma_lord' },
            'magma_lord': { id: 'magma_lord', name: 'Magma Lord', icon: 'üëπ', rate: 100000000, rarity: 'Godly', next: 'candy_king' },
            'candy_king': { id: 'candy_king', name: 'Candy King', icon: 'üç¨', rate: 500000000, rarity: 'Godly', next: 'leviathan' },
            'leviathan': { id: 'leviathan', name: 'Leviathan', icon: 'üêã', rate: 2000000000, rarity: 'Transcendent', next: 'nightmare' },
            'nightmare': { id: 'nightmare', name: 'Nightmare', icon: 'üåö', rate: 10000000000, rarity: 'Transcendent', next: 'archangel' },
            'archangel': { id: 'archangel', name: 'Archangel', icon: 'üëº', rate: 50000000000, rarity: 'Transcendent', next: 'chronos' },
            'chronos': { id: 'chronos', name: 'Chronos', icon: '‚è≥', rate: 250000000000, rarity: 'Eternal', next: 'golden_chick' },
            'drone': { id: 'drone', name: 'Drone', icon: 'üöÅ', rate: 150000, rarity: 'Epic', next: 'cyborg' },
            'magma_golem': { id: 'magma_golem', name: 'Magma Golem', icon: 'üåã', rate: 2000000, rarity: 'Legendary', next: 'magma_lord' },
            'gummy_bear': { id: 'gummy_bear', name: 'Gummy Bear', icon: 'üß∏', rate: 5000, rarity: 'Rare', next: 'candy_king' },
            'mermaid': { id: 'mermaid', name: 'Mermaid', icon: 'üßú‚Äç‚ôÄÔ∏è', rate: 5000000, rarity: 'Legendary', next: 'leviathan' },
            'wraith': { id: 'wraith', name: 'Wraith', icon: 'üëª', rate: 8000000, rarity: 'Legendary', next: 'nightmare' },
            'cherub': { id: 'cherub', name: 'Cherub', icon: 'üèπ', rate: 12000000, rarity: 'Mythical', next: 'archangel' },
            'golden_chick': { id: 'golden_chick', name: 'Golden Chick', icon: 'üèÜ', rate: 1000000000000, rarity: 'Legendary', next: 'rainbow_chick' },
            'rainbow_chick': { id: 'rainbow_chick', name: 'Rainbow Chick', icon: 'üåà', rate: 5000000000000, rarity: 'Mythical', next: 'mecha_chick' },
            'mecha_chick': { id: 'mecha_chick', name: 'Mecha Chick', icon: 'ü§ñ', rate: 25000000000000, rarity: 'Godly', next: 'darkmatter_chick' },
            'darkmatter_chick': { id: 'darkmatter_chick', name: 'Dark Matter Chick', icon: 'üåë', rate: 100000000000000, rarity: 'Transcendent', next: null },
            'reward_griffin': { id: 'reward_griffin', name: 'Guardian Griffin', icon: 'ü¶Ö', rate: 2000000000000, rarity: 'Special', next: null, hidden: true }
        };

        const EGGS = [
            { id: 'starter', name: 'Starter Egg', cost: 50, icon: 'ü•ö', colorClass: 'bg-orange-100 border-orange-200', pool: { 'ant': 0.45, 'chick': 0.40, 'mouse': 0.15 } },
            { id: 'farm', name: 'Farm Egg', cost: 200, icon: 'üè°', colorClass: 'bg-yellow-100 border-yellow-200', pool: { 'mouse': 0.3, 'beetle': 0.2, 'cat': 0.25, 'dog': 0.15, 'pig': 0.08, 'sheep': 0.02 } },
            { id: 'aqua', name: 'Aqua Egg', cost: 750, icon: 'üåä', colorClass: 'bg-blue-100 border-blue-200', pool: { 'fish': 0.35, 'crab': 0.3, 'turtle': 0.2, 'shark': 0.1, 'kraken': 0.005 } },
            { id: 'desert', name: 'Desert Egg', cost: 2500, icon: 'üåµ', colorClass: 'bg-amber-100 border-amber-200', pool: { 'snake': 0.4, 'camel': 0.3, 'vulture': 0.2, 'fox': 0.1 } },
            { id: 'spooky', name: 'Spooky Egg', cost: 7500, icon: 'üëª', colorClass: 'bg-purple-100 border-purple-200', pool: { 'spider': 0.3, 'owl': 0.3, 'wolf': 0.25, 'skeleton': 0.1, 'reaper': 0.05 } },
            { id: 'forest', name: 'Forest Egg', cost: 20000, icon: 'üå≤', colorClass: 'bg-green-100 border-green-200', pool: { 'fox': 0.3, 'monkey': 0.3, 'owl': 0.2, 'wolf': 0.15, 'bear': 0.05 } },
            { id: 'prehistoric', name: 'Dino Egg', cost: 75000, icon: 'üåã', colorClass: 'bg-red-100 border-red-200', pool: { 't-rex': 0.4, 'triceratops': 0.3, 'pterodactyl': 0.2, 'mammoth': 0.1 } },
            { id: 'jungle', name: 'Jungle Egg', cost: 250000, icon: 'üå¥', colorClass: 'bg-emerald-100 border-emerald-200', pool: { 'monkey': 0.3, 'snake': 0.3, 'tiger': 0.2, 'bear': 0.15, 'hydra': 0.005 } },
            { id: 'arctic', name: 'Arctic Egg', cost: 750000, icon: '‚ùÑÔ∏è', colorClass: 'bg-cyan-100 border-cyan-200', pool: { 'penguin': 0.4, 'bear': 0.3, 'yeti': 0.2, 'mammoth': 0.1 } },
            { id: 'cosmic', name: 'Cosmic Egg', cost: 2500000, icon: 'ü™ê', colorClass: 'bg-indigo-100 border-indigo-200', pool: { 'alien': 0.4, 'robot': 0.4, 'titan': 0.15, 'void': 0.005 } },
            { id: 'fantasy', name: 'Fantasy Egg', cost: 10000000, icon: 'üè∞', colorClass: 'bg-pink-100 border-pink-200', pool: { 'unicorn': 0.35, 'griffin': 0.3, 'dragon': 0.2, 'phoenix': 0.1, 'titan': 0.05 } },
            { id: 'divine', name: 'Divine Egg', cost: 50000000, icon: 'üëë', colorClass: 'bg-yellow-50 border-yellow-300', pool: { 'phoenix': 0.4, 'kraken': 0.25, 'hydra': 0.2, 'titan': 0.1, 'void': 0.05 } },
            { id: 'void', name: 'Void Egg', cost: 250000000, icon: 'üï≥Ô∏è', colorClass: 'bg-gray-900 border-gray-600', pool: { 'void': 0.6, 'cosmos': 0.4 } },
            { id: 'mystery', name: 'Mystery Egg', cost: 25000, icon: '‚ùì', colorClass: 'bg-purple-100 border-purple-300', pool: { 'spider': 0.2, 'bee': 0.2, 'frog': 0.2, 'turtle': 0.15, 'penguin': 0.15, 'camel': 0.1 } },
            { id: 'cyber', name: 'Cyber Egg', cost: 1000000000, icon: 'üíæ', colorClass: 'bg-blue-900 border-blue-500 text-blue-200', pool: { 'drone': 0.6, 'alien': 0.3, 'cyborg': 0.1 } },
            { id: 'magma', name: 'Magma Egg', cost: 5000000000, icon: '‚òÑÔ∏è', colorClass: 'bg-red-900 border-red-500 text-red-200', pool: { 'magma_golem': 0.6, 'dragon': 0.3, 'magma_lord': 0.1 } },
            { id: 'sugar', name: 'Sugar Egg', cost: 25000000000, icon: 'üç≠', colorClass: 'bg-pink-200 border-pink-400 text-pink-800', pool: { 'gummy_bear': 0.6, 'unicorn': 0.3, 'candy_king': 0.1 } },
            { id: 'abyssal', name: 'Abyssal Egg', cost: 100000000000, icon: 'üî±', colorClass: 'bg-teal-900 border-teal-500 text-teal-200', pool: { 'kraken': 0.5, 'mermaid': 0.4, 'leviathan': 0.1 } },
            { id: 'eclipse', name: 'Eclipse Egg', cost: 500000000000, icon: 'üåë', colorClass: 'bg-purple-900 border-purple-600 text-purple-200', pool: { 'wraith': 0.5, 'void': 0.4, 'nightmare': 0.1 } },
            { id: 'ether', name: 'Ether Egg', cost: 2500000000000, icon: 'üå§Ô∏è', colorClass: 'bg-yellow-100 border-yellow-400 text-yellow-800', pool: { 'cherub': 0.5, 'cosmos': 0.4, 'archangel': 0.1 } },
            { id: 'infinity', name: 'Infinity Egg', cost: 10000000000000, icon: '‚ôæÔ∏è', colorClass: 'bg-gray-100 border-black text-black', pool: { 'chronos': 0.05, 'archangel': 0.2, 'nightmare': 0.25, 'leviathan': 0.5 } },
            { id: 'treasury', name: 'Treasury Egg', cost: 50000000000000, icon: 'üèÜ', colorClass: 'bg-yellow-200 border-yellow-500 text-yellow-900', pool: { 'golden_chick': 0.1, 'dragon': 0.4, 'unicorn': 0.5 } },
            { id: 'spectrum', name: 'Spectrum Egg', cost: 100000000000000, icon: 'üåà', colorClass: 'bg-pink-100 border-purple-400 text-purple-900', pool: { 'rainbow_chick': 0.1, 'phoenix': 0.4, 'kraken': 0.5 } },
            { id: 'machinery', name: 'Mecha Egg', cost: 500000000000000, icon: '‚öôÔ∏è', colorClass: 'bg-gray-300 border-gray-600 text-gray-900', pool: { 'mecha_chick': 0.1, 'cyborg': 0.4, 'robot': 0.5 } },
            { id: 'singularity', name: 'Singularity Egg', cost: 1000000000000000, icon: 'üåå', colorClass: 'bg-black border-white text-white', pool: { 'darkmatter_chick': 0.05, 'void': 0.4, 'cosmos': 0.55 } }
        ];

        const UPGRADES = {
            luck: { name: 'Luck', description: 'Increases merge success rate', icon: 'üçÄ', baseCost: 1000, costMultiplier: 2.5, maxLevel: 10, getEffect: (level) => level * 0.05 },
            income: { name: 'Income', description: 'Multiplies all pet income', icon: 'üí∞', baseCost: 5000, costMultiplier: 3, maxLevel: 10, getEffect: (level) => level * 0.1 },
            clickPower: { name: 'Click', description: 'Increases click earnings', icon: 'üëÜ', baseCost: 500, costMultiplier: 2, maxLevel: 20, getEffect: (level) => level * 2 },
            autoClicker: { name: 'Auto-Click', description: 'Automatically clicks for you', icon: 'ü§ñ', baseCost: 10000, costMultiplier: 4, maxLevel: 10, getEffect: (level) => level * 4 }, // Buffed to 4 clicks/sec
            criticalClicks: { name: 'Critical', description: 'Chance for 5x click earnings', icon: 'üí•', baseCost: 2500, costMultiplier: 2.8, maxLevel: 15, getEffect: (level) => level * 0.02 },
            eggDiscount: { name: 'Discount', description: 'Reduces egg costs', icon: 'üè∑Ô∏è', baseCost: 7500, costMultiplier: 3.5, maxLevel: 8, getEffect: (level) => level * 0.05 },
            petBonus: { name: 'Pet Boost', description: 'Increases pet income rates', icon: '‚≠ê', baseCost: 15000, costMultiplier: 3.2, maxLevel: 12, getEffect: (level) => level * 0.08 },
            multiHatch: { name: 'Multi-Hatch', description: 'Max eggs hatched at once', icon: 'ü•ö', baseCost: 50000, costMultiplier: 5, maxLevel: 5, getEffect: (level) => level + 1 } // Level 0-5 (1-6 eggs)
        };

        const ACHIEVEMENTS = {
            firstClick: { id: 'firstClick', name: 'First Steps', description: 'Click for the first time', icon: 'üëÜ', condition: (state) => state.stats.totalClicks >= 1 },
            hundredClicks: { id: 'hundredClicks', name: 'Click Master', description: 'Click 100 times', icon: 'üíØ', condition: (state) => state.stats.totalClicks >= 100 },
            firstEgg: { id: 'firstEgg', name: 'Egg Hunter', description: 'Buy your first egg', icon: 'ü•ö', condition: (state) => state.stats.totalEggs >= 1 },
            tenEggs: { id: 'tenEggs', name: 'Egg Collector', description: 'Buy 10 eggs', icon: 'ü•ö', condition: (state) => state.stats.totalEggs >= 10 },
            firstMerge: { id: 'firstMerge', name: 'Alchemist', description: 'Successfully merge pets', icon: 'üß¨', condition: (state) => state.stats.totalMerges >= 1 },
            millionaire: { id: 'millionaire', name: 'Millionaire', description: 'Earn $1,000,000 total', icon: 'üí∞', condition: (state) => state.stats.totalMoney >= 1000000 },
            billionaire: { id: 'billionaire', name: 'Billionaire', description: 'Earn $1,000,000,000 total', icon: 'üíé', condition: (state) => state.stats.totalMoney >= 1000000000 },
            firstRare: { id: 'firstRare', name: 'Rare Find', description: 'Get a Rare pet', icon: '‚≠ê', condition: (state) => state.inventory.some(id => PETS[id] && PETS[id].rarity === 'Rare') },
            firstEpic: { id: 'firstEpic', name: 'Epic Hunter', description: 'Get an Epic pet', icon: 'üåü', condition: (state) => state.inventory.some(id => PETS[id] && PETS[id].rarity === 'Epic') },
            firstLegendary: { id: 'firstLegendary', name: 'Legendary', description: 'Get a Legendary pet', icon: 'üëë', condition: (state) => state.inventory.some(id => PETS[id] && PETS[id].rarity === 'Legendary') },
            firstMythical: { id: 'firstMythical', name: 'Mythical', description: 'Get a Mythical pet', icon: 'üî•', condition: (state) => state.inventory.some(id => PETS[id] && PETS[id].rarity === 'Mythical') },
            firstGodly: { id: 'firstGodly', name: 'Godly', description: 'Get a Godly pet', icon: '‚ú®', condition: (state) => state.inventory.some(id => PETS[id] && PETS[id].rarity === 'Godly') },
            firstTranscendent: { id: 'firstTranscendent', name: 'Transcendent', description: 'Get a Transcendent pet', icon: 'üåå', condition: (state) => state.inventory.some(id => PETS[id] && PETS[id].rarity === 'Transcendent') }
        };

        // --- STATE ---
        let state = {
            money: 0,
            inventory: [],
            collection: [],
            upgrades: { luck: 0, income: 0, clickPower: 0, autoClicker: 0, criticalClicks: 0, eggDiscount: 0, petBonus: 0, multiHatch: 0 },
            rebirth: { level: 0, multiplier: 1 },
            achievements: [],
            currentWorld: 'home',
            currentGalaxy: 'origin',
            settings: { hatchAmount: 1, sortMode: 'rarity_desc' },
            stats: { totalClicks: 0, totalEggs: 0, totalMerges: 0, totalMoney: 0 },
            lastSave: Date.now()
        };

        let autoClickerInterval = null;
        let hatchQueue = [];
        let isHatching = false;

        // --- CORE FUNCTIONS ---
        window.onload = function() {
            loadGame();
            renderShop();
            renderUpgrades();
            renderAchievements();
            renderInventory();
            updateAutoClicker();
            checkAchievements();
            updateUI();

            setInterval(() => {
                const income = calculateIncome();
                if (income > 0) addMoney(income);
            }, 1000);

            setInterval(saveGame, 10000);
        };

        function calculateIncome() {
            const baseIncome = state.inventory.reduce((total, petId) => {
                const pet = PETS[petId];
                return total + (pet ? pet.rate : 0);
            }, 0);
            const incomeMultiplier = 1 + UPGRADES.income.getEffect(state.upgrades.income);
            const petBonus = 1 + UPGRADES.petBonus.getEffect(state.upgrades.petBonus);
            const rebirthMult = state.rebirth.multiplier || 1;
            return Math.floor(baseIncome * incomeMultiplier * petBonus * rebirthMult);
        }

        function addMoney(amount) {
            state.money += amount;
            state.stats.totalMoney += amount;
            updateUI();
            checkAchievements();
        }

        function manualClick(e, isAuto = false) {
            const baseClick = 1;
            const incomeBonus = Math.floor(calculateIncome() * 0.05);
            const upgradeBonus = UPGRADES.clickPower.getEffect(state.upgrades.clickPower);
            const rebirthMult = state.rebirth.multiplier || 1;
            let total = (baseClick + incomeBonus + upgradeBonus) * rebirthMult;

            const critChance = UPGRADES.criticalClicks.getEffect(state.upgrades.criticalClicks);
            if (Math.random() < critChance) total *= 5;

            addMoney(total);

            if (!isAuto) {
                state.stats.totalClicks++;
                checkAchievements();
            }

            if (!isAuto && e) {
                const critText = total > ((baseClick + incomeBonus + upgradeBonus) * rebirthMult) ? 'CRIT! ' : '';
                createFloatingText(e.clientX, e.clientY, `${critText}+$${formatCompact(total)}`);
            }
        }

        function updateHatchSetting(val) {
             state.settings.hatchAmount = parseInt(val);
             document.getElementById('hatch-amount-display').innerText = state.settings.hatchAmount + 'x';
             renderShop();
        }
        
        function updateSortSetting(val) {
            state.settings.sortMode = val;
            renderInventory();
        }

        function buyEgg(eggId) {
            const egg = EGGS.find(e => e.id === eggId);
            if (!egg) return;

            const discount = UPGRADES.eggDiscount.getEffect(state.upgrades.eggDiscount);
            const discountedCost = Math.floor(egg.cost * (1 - discount));
            const hatchCount = state.settings.hatchAmount || 1;
            const totalCost = discountedCost * hatchCount;

            if (state.money >= totalCost) {
                state.money -= totalCost;
                state.stats.totalEggs += hatchCount;
                updateUI();
                startHatchingSequence(egg, hatchCount);
                checkAchievements();
            } else {
                showToast("Not enough money!");
            }
        }

        function switchWorld(worldId) {
            const world = WORLDS.find(w => w.id === worldId);
            if (!world) return;
            
            if (state.rebirth.level < world.minRebirth) {
                showToast(`Requires Rebirth Level ${world.minRebirth}!`);
                return;
            }

            state.currentWorld = worldId;
            saveGame();
            renderShop();
            updateUI();
        }

        function switchGalaxy(galaxyId) {
            const galaxy = GALAXIES.find(g => g.id === galaxyId);
            if(!galaxy) return;

            if (state.rebirth.level < galaxy.minRebirth) {
                showToast(`Galaxy requires Rebirth ${galaxy.minRebirth}!`);
                return;
            }

            state.currentGalaxy = galaxyId;
            const firstWorldId = galaxy.worlds[0];
            const world = WORLDS.find(w => w.id === firstWorldId);
            if (world && state.rebirth.level >= world.minRebirth) {
                state.currentWorld = firstWorldId;
            }
            
            saveGame();
            renderShop();
            updateUI();
        }

        // --- REBIRTH SYSTEM (DYNAMIC) ---
        function getRebirthLevelData(level) {
            if (level === 1) return { level: 1, req: { 'mouse': 5 }, multiplier: 1.5, unlockMsg: "Unlocks: Haunted Forest" };
            if (level === 2) return { level: 2, req: { 'cat': 3 }, multiplier: 2.0, unlockMsg: "Unlocks: Jurassic Isle" };
            if (level === 3) return { level: 3, req: { 'fox': 2 }, multiplier: 2.5, unlockMsg: "Unlocks: Frozen Tundra" };
            if (level === 4) return { level: 4, req: { 't-rex': 1 }, multiplier: 3.0, unlockMsg: "Unlocks: Magic Realm" };
            if (level === 5) return { level: 5, req: { 'unicorn': 1 }, multiplier: 3.5, unlockMsg: "Unlocks: Deep Space (Astral Sector)" };
            if (level === 6) return { level: 6, req: { 'phoenix': 1 }, multiplier: 4.0, unlockMsg: "Unlocks: Divine Plane" };
            if (level === 7) return { level: 7, req: { 'void': 1 }, multiplier: 4.5, unlockMsg: "Unlocks: Cyber City" };
            if (level === 8) return { level: 8, req: { 'cosmos': 1 }, multiplier: 5.0, unlockMsg: "Unlocks: Volcanic Core" };
            if (level === 9) return { level: 9, req: { 'cyborg': 1 }, multiplier: 5.5, unlockMsg: "Unlocks: Candy Land" };
            if (level === 10) return { level: 10, req: { 'magma_lord': 1 }, multiplier: 6.0, unlockMsg: "Unlocks: Atlantis" };
            if (level === 11) return { level: 11, req: { 'candy_king': 1 }, multiplier: 6.5, unlockMsg: "Unlocks: Shadow Realm (Mystic Reach)" };
            if (level === 12) return { level: 12, req: { 'leviathan': 1 }, multiplier: 7.0, unlockMsg: "Unlocks: Celestial Haven" };
            if (level === 13) return { level: 13, req: { 'nightmare': 1 }, multiplier: 7.5, unlockMsg: "" };
            if (level === 14) return { level: 14, req: { 'archangel': 1 }, multiplier: 8.0, unlockMsg: "" };
            
            if (level === 20) return { level: 20, req: { 'golden_chick': 1 }, multiplier: 15.0, unlockMsg: "Unlocks: Chickverse Galaxy (Gilded Coop)" };
            if (level === 25) return { level: 25, req: { 'rainbow_chick': 1 }, multiplier: 25.0, unlockMsg: "Unlocks: Prismatic Fields" };
            if (level === 30) return { level: 30, req: { 'mecha_chick': 1 }, multiplier: 50.0, unlockMsg: "Unlocks: Mecha Base" };
            if (level === 35) return { level: 35, req: { 'darkmatter_chick': 1 }, multiplier: 100.0, unlockMsg: "Unlocks: Void Nexus" };

            if (level <= 1000) {
                const multiplier = 1 + (level * 0.5); 
                const highTierPets = ['magma_lord', 'candy_king', 'leviathan', 'nightmare', 'archangel', 'chronos', 'golden_chick', 'rainbow_chick', 'mecha_chick', 'darkmatter_chick'];
                const index = (level - 15) % highTierPets.length;
                const petId = highTierPets[index];
                const count = 1 + Math.floor((level - 15) / highTierPets.length);
                
                const req = {};
                req[petId] = count;
                
                return { level: level, req: req, multiplier: parseFloat(multiplier.toFixed(1)), unlockMsg: "" };
            }
            return null;
        }

        function openRebirthModal() {
            const modal = document.getElementById('rebirth-modal');
            const currentLevelDisplay = document.getElementById('rebirth-current-level');
            const currentMultDisplay = document.getElementById('rebirth-current-mult');
            const reqsDisplay = document.getElementById('rebirth-reqs');
            const nextMultDisplay = document.getElementById('rebirth-next-mult');
            const unlockMsg = document.getElementById('rebirth-unlock-msg');
            const confirmBtn = document.getElementById('rebirth-confirm-btn');

            const currentLvl = state.rebirth.level;
            const nextRebirth = getRebirthLevelData(currentLvl + 1);

            currentLevelDisplay.innerText = currentLvl;
            currentMultDisplay.innerText = 'x' + state.rebirth.multiplier;
            modal.classList.remove('hidden');

            if (!nextRebirth) {
                reqsDisplay.innerHTML = '<span class="text-green-400">Max Rebirth Level Reached!</span>';
                nextMultDisplay.innerText = "MAX";
                unlockMsg.innerText = "";
                confirmBtn.disabled = true;
                return;
            }

            nextMultDisplay.innerText = 'x' + nextRebirth.multiplier;
            unlockMsg.innerText = nextRebirth.unlockMsg || "";

            const petCounts = {};
            state.inventory.forEach(id => petCounts[id] = (petCounts[id] || 0) + 1);

            let canRebirth = true;
            let reqsHTML = '';
            for (const [petId, countNeeded] of Object.entries(nextRebirth.req)) {
                const pet = PETS[petId];
                const countOwned = petCounts[petId] || 0;
                const satisfied = countOwned >= countNeeded;
                if (!satisfied) canRebirth = false;

                reqsHTML += `
                    <div class="flex flex-col items-center p-2 rounded ${satisfied ? 'bg-green-900/30' : 'bg-red-900/30'} border ${satisfied ? 'border-green-500' : 'border-red-500'}">
                        <div class="text-2xl">${pet.icon}</div>
                        <div class="text-xs font-bold">${pet.name}</div>
                        <div class="text-sm ${satisfied ? 'text-green-400' : 'text-red-400'}">${countOwned}/${countNeeded}</div>
                    </div>
                `;
            }
            reqsDisplay.innerHTML = reqsHTML;
            confirmBtn.disabled = !canRebirth;
        }

        function closeRebirthModal() { document.getElementById('rebirth-modal').classList.add('hidden'); }

        function performRebirth() {
            const nextRebirth = getRebirthLevelData(state.rebirth.level + 1);
            if (!nextRebirth) return;

            state.inventory = []; 
            state.money = 0;
            state.upgrades = { luck: 0, income: 0, clickPower: 0, autoClicker: 0, criticalClicks: 0, eggDiscount: 0, petBonus: 0, multiHatch: 0 };
            
            state.rebirth.level = nextRebirth.level;
            state.rebirth.multiplier = nextRebirth.multiplier;
            
            const newWorld = WORLDS.find(w => w.minRebirth === state.rebirth.level);
            if(newWorld) state.currentWorld = newWorld.id;

            saveGame();
            closeRebirthModal();
            renderInventory();
            renderUpgrades();
            renderShop();
            updateUI();
            updateAutoClicker();
            showToast(`Rebirth Successful! Multiplier: x${state.rebirth.multiplier}`);
        }

        // --- ACHIEVEMENTS ---
        function checkAchievements() {
            if (!state.achievements) state.achievements = [];
            let newAchievements = [];
            Object.values(ACHIEVEMENTS).forEach(achievement => {
                if (!state.achievements.includes(achievement.id) && achievement.condition(state)) {
                    state.achievements.push(achievement.id);
                    newAchievements.push(achievement);
                }
            });
            if (newAchievements.length > 0) {
                newAchievements.forEach(a => showToast(`Achievement: ${a.name}!`));
                renderAchievements();
                saveGame();
            }
        }

        function renderAchievements() {
            const container = document.getElementById('achievements-container');
            const totalAchievements = Object.keys(ACHIEVEMENTS).length;
            const unlockedCount = state.achievements.length;
            document.getElementById('achievement-count').textContent = `${unlockedCount}/${totalAchievements}`;
            container.innerHTML = Object.values(ACHIEVEMENTS).map(a => {
                const unlocked = state.achievements.includes(a.id);
                return `<div class="bg-white/80 rounded-lg p-2 shadow-sm transition-all ${unlocked ? 'border-2 border-yellow-400' : 'opacity-50'} text-gray-800"><div class="text-center"><div class="text-lg mb-1">${a.icon}</div><div class="text-xs font-bold ${unlocked ? 'text-yellow-600' : 'text-gray-400'}">${a.name}</div></div></div>`;
            }).join('');
        }

        // --- HATCHING & MERGE ---
        function startHatchingSequence(egg, count = 1) {
            const overlay = document.getElementById('hatch-overlay');
            const eggContainer = document.getElementById('hatch-egg-display'); 
            const message = document.getElementById('hatch-message');
            document.getElementById('new-pet-card').classList.add('hidden');
            document.getElementById('multi-pet-grid').classList.add('hidden');
            document.getElementById('multi-hatch-close-btn').classList.add('hidden');
            
            eggContainer.classList.remove('hidden', 'pop-in');
            eggContainer.style.transform = 'scale(1)';
            message.innerText = count > 1 ? "Tap to Hatch All!" : "Tap to Hatch!";
            message.classList.remove('hidden');
            document.getElementById('hatch-rays').style.opacity = '0';

            if (count === 1) {
                eggContainer.className = "text-9xl transition-all duration-300 cursor-pointer relative z-10 select-none";
                eggContainer.innerHTML = egg.icon;
            } else {
                eggContainer.className = "grid grid-cols-3 gap-4 transition-all duration-300 cursor-pointer relative z-10 select-none max-w-md mx-auto";
                eggContainer.innerHTML = Array(count).fill(`<div class="text-6xl animate-bounce">${egg.icon}</div>`).join('');
            }
            overlay.classList.remove('hidden');
            eggContainer.onclick = function() {
                if(count === 1) eggContainer.classList.add('shake-animation');
                else Array.from(eggContainer.children).forEach((child, i) => child.style.animation = `shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite ${i * 0.05}s`);
                message.innerText = "Cracking...";
                setTimeout(() => revealBatch(egg, count), 1000);
                eggContainer.onclick = null;
            };
        }

        function revealBatch(egg, count) {
            const results = [];
            let highestRarityScore = 0; 
            const getRarityVal = (r) => ({'Common':1,'Uncommon':2,'Rare':3,'Epic':4,'Legendary':5,'Mythical':6,'Godly':7,'Transcendent':8, 'Eternal':9})[r]||0;

            for(let i=0; i<count; i++) {
                const petId = rollPet(egg.pool);
                if(petId && PETS[petId]) {
                    const pet = PETS[petId];
                    state.inventory.push(petId);
                    if (!state.collection.includes(petId)) state.collection.push(petId);
                    results.push(pet);
                    const score = getRarityVal(pet.rarity);
                    if(score > highestRarityScore) highestRarityScore = score;
                }
            }

            document.getElementById('hatch-egg-display').classList.add('hidden');
            document.getElementById('hatch-egg-display').classList.remove('shake-animation');
            document.getElementById('hatch-message').classList.add('hidden');

            if (results.length === 1) {
                const pet = results[0];
                document.getElementById('reveal-icon').innerText = pet.icon;
                document.getElementById('reveal-name').innerText = pet.name;
                document.getElementById('reveal-rarity').innerText = pet.rarity;
                document.getElementById('reveal-rate').innerText = pet.rate.toLocaleString();
                document.getElementById('reveal-card-bg').className = `bg-white p-6 rounded-2xl shadow-2xl text-center w-64 border-4 rarity-${pet.rarity.toLowerCase()}`;
                document.getElementById('new-pet-card').classList.remove('hidden');
                document.getElementById('new-pet-card').classList.add('pop-in');
            } else {
                const grid = document.getElementById('multi-pet-grid');
                grid.innerHTML = results.map(pet => `
                    <div class="bg-white p-3 rounded-xl shadow-lg border-2 rarity-${pet.rarity.toLowerCase()} flex flex-col items-center pop-in transform transition hover:scale-105">
                        <div class="text-[10px] font-bold uppercase mb-1 opacity-70 text-gray-600">${pet.rarity}</div>
                        <div class="text-5xl mb-2">${pet.icon}</div>
                        <div class="font-bold text-sm text-gray-800 text-center leading-tight truncate w-full">${pet.name}</div>
                    </div>`).join('');
                grid.classList.remove('hidden');
                document.getElementById('multi-hatch-close-btn').classList.remove('hidden');
                Array.from(grid.children).forEach((el, i) => el.style.animationDelay = `${i * 0.05}s`);
            }

            if(highestRarityScore >= 4) document.getElementById('hatch-rays').style.opacity = '0.5';
            saveGame(); renderInventory(); updateUI(); checkAchievements();
        }

        function rollPet(pool) {
            const rand = Math.random();
            let cumulative = 0;
            for (const [petId, chance] of Object.entries(pool)) {
                cumulative += chance;
                if (rand < cumulative) return petId;
            }
            return Object.keys(pool)[0];
        }

        function closeHatchModal() { document.getElementById('hatch-overlay').classList.add('hidden'); }

        function openMergeModal() {
            const modal = document.getElementById('merge-modal');
            modal.classList.remove('hidden');
            const counts = {};
            state.inventory.forEach(id => counts[id] = (counts[id] || 0) + 1);
            const mergeable = Object.entries(counts).filter(([id, count]) => count >= 3 && PETS[id] && PETS[id].next).map(([id, count]) => ({ id, count, pet: PETS[id] }));
            const list = document.getElementById('merge-list');
            const msg = document.getElementById('no-merge-msg');
            
            if (mergeable.length === 0) {
                list.innerHTML = ''; msg.classList.remove('hidden'); return;
            }
            msg.classList.add('hidden');
            list.innerHTML = mergeable.map(m => {
                const nextPet = PETS[m.pet.next];
                return `<div class="bg-white border-2 border-blue-100 p-4 rounded-xl flex items-center justify-between shadow-sm"><div class="flex items-center gap-4"><div class="relative"><div class="text-4xl">${m.pet.icon}</div><div class="absolute -bottom-1 -right-1 bg-blue-600 text-white text-[10px] px-1.5 rounded-full font-bold">x${m.count}</div></div><div><div class="font-bold text-gray-800">${m.pet.name}</div><div class="text-xs text-blue-500 flex items-center gap-1">Merge 3 <i class="fas fa-arrow-right text-[10px]"></i> ${nextPet.icon} ?</div></div></div><button onclick="performMerge('${m.id}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition active:scale-95">Merge</button></div>`;
            }).join('');
        }
        function closeMergeModal() { document.getElementById('merge-modal').classList.add('hidden'); }
        function performMerge(petId) {
            const count = state.inventory.filter(id => id === petId).length;
            if (count < 3) { showToast("Not enough pets!"); openMergeModal(); return; }
            const currentPet = PETS[petId];
            const nextPetId = currentPet.next;
            const nextPet = PETS[nextPetId];
            let removed = 0;
            const newInventory = [];
            for (let item of state.inventory) {
                if (item === petId && removed < 3) removed++; else newInventory.push(item);
            }
            state.inventory = newInventory;
            const baseChance = 0.75;
            const luckBonus = UPGRADES.luck.getEffect(state.upgrades.luck);
            const totalChance = Math.min(baseChance + luckBonus, 1);
            if (Math.random() < totalChance) {
                state.inventory.push(nextPetId);
                if (!state.collection.includes(nextPetId)) state.collection.push(nextPetId);
                state.stats.totalMerges++;
                showToast(`Success! Merged into ${nextPet.name}!`);
                checkAchievements();
            } else {
                showToast(`Failed! The fusion unstable...`);
            }
            saveGame(); renderInventory(); updateUI(); openMergeModal();
        }

        // --- UPGRADES ---
        function buyUpgrade(upgradeId) {
            const upgrade = UPGRADES[upgradeId];
            if (!upgrade) return;
            const currentLevel = state.upgrades[upgradeId];
            if (currentLevel >= upgrade.maxLevel) { showToast("Max level reached!"); return; }
            const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costMultiplier, currentLevel));
            if (state.money >= cost) {
                state.money -= cost;
                state.upgrades[upgradeId]++;
                updateUI(); renderUpgrades();
                if (upgradeId === 'autoClicker') updateAutoClicker();
                if (upgradeId === 'eggDiscount' || upgradeId === 'multiHatch') renderShop();
                saveGame();
                showToast(`${upgrade.name} upgraded!`);
            } else { showToast("Not enough money!"); }
        }

        function renderUpgrades() {
            const container = document.getElementById('upgrades-container');
            container.innerHTML = Object.entries(UPGRADES).map(([id, upgrade]) => {
                const currentLevel = state.upgrades[id];
                const maxed = currentLevel >= upgrade.maxLevel;
                const cost = maxed ? 0 : Math.floor(upgrade.baseCost * Math.pow(upgrade.costMultiplier, currentLevel));
                let effectText = '';
                if (id === 'luck') effectText = `${(Math.min(0.75 + upgrade.getEffect(currentLevel), 1) * 100).toFixed(0)}% chance`;
                else if (id === 'income') effectText = `${(1 + upgrade.getEffect(currentLevel)).toFixed(1)}x income`;
                else if (id === 'clickPower') effectText = `+$${upgrade.getEffect(currentLevel)} click`;
                else if (id === 'autoClicker') effectText = `${upgrade.getEffect(currentLevel)}/s`;
                else if (id === 'criticalClicks') effectText = `${(upgrade.getEffect(currentLevel) * 100).toFixed(1)}% crit`;
                else if (id === 'eggDiscount') effectText = `${(upgrade.getEffect(currentLevel) * 100).toFixed(1)}% off`;
                else if (id === 'petBonus') effectText = `+${(upgrade.getEffect(currentLevel) * 100).toFixed(1)}% pet`;
                else if (id === 'multiHatch') effectText = `Max ${1 + upgrade.getEffect(currentLevel)} eggs`;

                // Slider Injection for MultiHatch
                let sliderHTML = '';
                if (id === 'multiHatch' && currentLevel > 0) {
                    const maxHatch = 1 + upgrade.getEffect(currentLevel);
                    if (state.settings.hatchAmount > maxHatch) state.settings.hatchAmount = maxHatch;
                    
                    sliderHTML = `
                        <div class="mt-2 mb-2 p-2 bg-gray-100/80 rounded">
                            <div class="flex justify-between text-xs font-bold mb-1 text-gray-600">
                                <span>Hatch Amount</span>
                                <span id="hatch-amount-display">${state.settings.hatchAmount}x</span>
                            </div>
                            <input type="range" id="hatch-amount-slider" min="1" max="${maxHatch}" value="${state.settings.hatchAmount}" class="w-full accent-blue-500 cursor-pointer" oninput="updateHatchSetting(this.value)">
                        </div>
                    `;
                }

                return `<div class="bg-white/90 backdrop-blur rounded-xl p-3 shadow-md transition-all hover:shadow-lg ${maxed ? 'opacity-60' : ''} text-gray-800"><div class="flex items-center gap-3 mb-1"><div class="text-2xl">${upgrade.icon}</div><div><div class="font-bold text-md leading-none">${upgrade.name}</div><div class="text-[10px] text-gray-500">${upgrade.description}</div></div></div><div class="text-xs text-green-600 font-bold mb-2">${effectText}</div>${sliderHTML}<div class="flex items-center justify-between"><div class="text-xs text-gray-500">Lvl ${currentLevel}/${upgrade.maxLevel}</div>${maxed ? `<div class="text-green-600 font-bold text-xs">MAX</div>` : `<button onclick="buyUpgrade('${id}')" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded-lg transition active:scale-95">$${formatCompact(cost)}</button>`}</div></div>`;
            }).join('');
        }

        function updateAutoClicker() {
            if (autoClickerInterval) { clearInterval(autoClickerInterval); autoClickerInterval = null; }
            const clicksPerSecond = UPGRADES.autoClicker.getEffect(state.upgrades.autoClicker);
            if (clicksPerSecond > 0) autoClickerInterval = setInterval(() => manualClick(null, true), 1000 / clicksPerSecond);
        }

        // --- ADMIN SYSTEM ---
        function openAdminModal() {
            document.getElementById('admin-modal').classList.remove('hidden');
            document.getElementById('admin-login-view').classList.remove('hidden');
            document.getElementById('admin-dashboard-view').classList.add('hidden');
            document.getElementById('admin-password-input').value = '';
        }
        function closeAdminModal() { document.getElementById('admin-modal').classList.add('hidden'); }
        function checkAdminPassword() {
            const input = document.getElementById('admin-password-input').value;
            if (input === '7450') {
                document.getElementById('admin-login-view').classList.add('hidden');
                document.getElementById('admin-dashboard-view').classList.remove('hidden');
                populateAdminPetList();
                showToast("Admin Access Granted!");
            } else { showToast("Incorrect Password!"); }
        }
        function populateAdminPetList() {
            const select = document.getElementById('admin-pet-select');
            select.innerHTML = Object.values(PETS).map(pet => `<option value="${pet.id}">[${pet.rarity}] ${pet.name}</option>`).join('');
        }
        function adminAddMoney() {
            const amount = parseInt(document.getElementById('admin-money-input').value);
            if (amount && amount > 0) { addMoney(amount); showToast(`Added $${amount.toLocaleString()}!`); }
        }
        function adminAddPet() {
            const petId = document.getElementById('admin-pet-select').value;
            if (petId && PETS[petId]) {
                state.inventory.push(petId);
                if (!state.collection.includes(petId)) state.collection.push(petId);
                renderInventory(); saveGame(); showToast(`Added ${PETS[petId].name}!`);
            }
        }
        function adminSetRebirth() {
            const level = parseInt(document.getElementById('admin-rebirth-input').value);
            if (!isNaN(level) && level >= 0) {
                state.rebirth.level = level;
                if (level === 0) state.rebirth.multiplier = 1;
                else {
                    const data = getRebirthLevelData(level);
                    state.rebirth.multiplier = data ? data.multiplier : 1 + (level * 0.5);
                }
                saveGame(); renderShop(); updateUI(); showToast(`Rebirth set to Level ${level} (x${state.rebirth.multiplier})`);
            }
        }

        // --- INDEX ---
        function openIndexModal() {
            const modal = document.getElementById('index-modal');
            modal.classList.remove('hidden');
            const allPets = Object.values(PETS).filter(p => !p.hidden);
            const collectedCount = allPets.filter(p => state.collection.includes(p.id)).length;
            document.getElementById('index-progress-text').innerText = `Collected: ${collectedCount}/${allPets.length}`;
            document.getElementById('index-grid').innerHTML = allPets.map(pet => {
                const isCollected = state.collection.includes(pet.id);
                return `<div class="aspect-square rounded-xl flex flex-col items-center justify-center p-2 border-2 ${isCollected ? `bg-white ${getRarityBorder(pet.rarity)}` : 'bg-gray-200 border-gray-300'}"><div class="text-4xl mb-2 ${isCollected ? '' : 'pet-silhouette'}">${pet.icon}</div><div class="text-xs font-bold text-center w-full truncate ${isCollected ? 'text-gray-800' : 'pet-locked-text'}">${pet.name}</div></div>`;
            }).join('');
            
            const btn = document.getElementById('claim-reward-btn');
            if (state.collection.includes('reward_griffin')) {
                btn.innerHTML = `<span>Claimed</span> <i class="fas fa-check"></i>`; btn.className = "bg-green-100 text-green-600 font-bold py-3 px-8 rounded-full cursor-default flex items-center gap-2 border-2 border-green-500"; btn.disabled = true;
            } else if (collectedCount >= allPets.length) {
                btn.innerHTML = `<span>Claim Reward</span> <i class="fas fa-gift"></i>`; btn.className = "bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full transition shadow-lg flex items-center gap-2 animate-bounce cursor-pointer"; btn.disabled = false; btn.onclick = claimIndexReward;
            } else {
                btn.innerHTML = `<span>Locked</span> <i class="fas fa-lock"></i>`; btn.className = "bg-gray-300 text-gray-500 font-bold py-3 px-8 rounded-full transition cursor-not-allowed flex items-center gap-2"; btn.disabled = true;
            }
        }
        function closeIndexModal() { document.getElementById('index-modal').classList.add('hidden'); }
        function claimIndexReward() { if(state.collection.includes('reward_griffin')) return; state.inventory.push('reward_griffin'); state.collection.push('reward_griffin'); renderInventory(); updateUI(); saveGame(); openIndexModal(); showToast("Guardian Griffin Acquired!"); }
        function getRarityBorder(rarity) { return {'Common':'border-gray-400','Uncommon':'border-green-400','Rare':'border-blue-500','Epic':'border-purple-500','Legendary':'border-yellow-500','Mythical':'border-red-500','Godly':'border-gray-800','Transcendent':'border-yellow-300', 'Eternal':'border-cyan-300'}[rarity] || 'border-gray-200'; }

        // --- UI ---
        function renderShop() {
            const navContainer = document.getElementById('world-nav-container');
            const galaxyNavContainer = document.getElementById('galaxy-nav-container');
            
            const currentGalaxy = GALAXIES.find(g => g.id === state.currentGalaxy) || GALAXIES[0];
            const currentWorld = WORLDS.find(w => w.id === state.currentWorld) || WORLDS[0];
            
            document.getElementById('world-status').innerText = `${currentGalaxy.name} - ${currentWorld.name}`;
            document.getElementById('game-body').className = `h-screen flex flex-col overflow-hidden text-gray-800 ${currentWorld.bgClass}`;

            galaxyNavContainer.innerHTML = GALAXIES.map(g => {
                const locked = state.rebirth.level < g.minRebirth;
                const active = state.currentGalaxy === g.id;
                return `<button onclick="switchGalaxy('${g.id}')" class="flex-shrink-0 px-4 py-1.5 rounded-full text-xs font-bold border transition flex items-center gap-1 ${active ? 'bg-purple-600 text-white border-purple-600' : (locked ? 'bg-gray-200 text-gray-400 border-gray-300 cursor-not-allowed' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50')}"><span>${g.icon}</span> ${locked ? '<i class="fas fa-lock text-[10px] ml-1"></i>' : g.name}</button>`;
            }).join('');

            const worldsInGalaxy = WORLDS.filter(w => currentGalaxy.worlds.includes(w.id));
            
            navContainer.innerHTML = worldsInGalaxy.map(w => {
                const locked = state.rebirth.level < w.minRebirth;
                const active = state.currentWorld === w.id;
                return `<button onclick="switchWorld('${w.id}')" class="flex-shrink-0 px-4 py-2 rounded-full text-xs font-bold border transition ${active ? 'bg-blue-600 text-white border-blue-600' : (locked ? 'bg-gray-200 text-gray-400 border-gray-300 cursor-not-allowed' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50')}">${locked ? '<i class="fas fa-lock mr-1"></i>' : ''}${w.name}</button>`;
            }).join('');

            const eggsToRender = EGGS.filter(egg => currentWorld.eggIds.includes(egg.id));
            const container = document.getElementById('egg-shop-container');
            const discount = UPGRADES.eggDiscount.getEffect(state.upgrades.eggDiscount);
            const hatchCount = state.settings.hatchAmount || 1;

            container.innerHTML = eggsToRender.map(egg => {
                const discountedCost = Math.floor(egg.cost * (1 - discount));
                const totalCost = discountedCost * hatchCount;
                const hasDiscount = discount > 0;
                const hasMultiHatch = hatchCount > 1;
                return `
                    <div class="rounded-xl p-4 shadow-md bg-white/90 backdrop-blur transition-all hover:-translate-y-1 hover:shadow-lg flex flex-col items-center ${egg.colorClass} text-gray-800">
                        <div class="cursor-pointer transition-transform hover:scale-110 active:scale-95 text-center w-full" onclick="showEggInfo('${egg.id}')" title="Click for Drop Rates">
                            <div class="text-4xl mb-2">${egg.icon}</div>
                            <div class="font-bold text-lg leading-tight mb-1 flex items-center justify-center gap-1">${egg.name} <i class="fas fa-info-circle text-gray-400 text-xs"></i></div>
                            <div class="text-xs text-gray-500 text-center mb-3 h-8 overflow-hidden">${getRarePreview(egg.pool)}</div>
                        </div>
                        <button onclick="buyEgg('${egg.id}')" class="bg-white border-2 border-green-500 text-green-600 font-bold py-1.5 px-6 rounded-full hover:bg-green-500 hover:text-white transition w-full shadow-sm z-10">
                            $${formatCompact(totalCost)}${hasMultiHatch ? ` (${hatchCount}x)` : ''}${hasDiscount ? ` <span class="line-through text-red-400 text-xs">$${formatCompact(egg.cost)}</span>` : ''}
                        </button>
                    </div>
                `;
            }).join('');
        }

        function getRarePreview(pool) {
            const sorted = Object.entries(pool).filter(([id]) => PETS[id]).sort((a,b) => a[1] - b[1]); 
            return "Contains: " + sorted.slice(0, 2).map(([id]) => PETS[id].icon).join(' ');
        }

        function formatCompact(num) { return Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 1 }).format(num); }

        function renderInventory() {
            const container = document.getElementById('inventory-container');
            let list = [...state.inventory];
            
            // Sorting Logic
            const mode = state.settings.sortMode || 'newest';
            const getVal = (id) => PETS[id] ? PETS[id].rate : 0;
            const getRarityVal = (id) => {
               const r = PETS[id] ? PETS[id].rarity : 'Common';
               const map = {'Common':1,'Uncommon':2,'Rare':3,'Epic':4,'Legendary':5,'Mythical':6,'Godly':7,'Transcendent':8, 'Eternal':9, 'Special':10};
               return map[r] || 0;
            };

            if (mode === 'newest') list.reverse();
            else if (mode === 'rarity_desc') list.sort((a,b) => getRarityVal(b) - getRarityVal(a));
            else if (mode === 'rarity_asc') list.sort((a,b) => getRarityVal(a) - getRarityVal(b));
            else if (mode === 'power_desc') list.sort((a,b) => getVal(b) - getVal(a));
            else if (mode === 'name') list.sort((a,b) => (PETS[a]?.name || '').localeCompare(PETS[b]?.name || ''));

            const petCounts = {};
            state.inventory.forEach(id => { petCounts[id] = (petCounts[id] || 0) + 1; });
            
            if (list.length === 0) {
                document.getElementById('empty-inventory').style.display = 'block';
                container.innerHTML = '';
            } else {
                document.getElementById('empty-inventory').style.display = 'none';
                container.innerHTML = list.map(petId => {
                    const pet = PETS[petId];
                    if (!pet) return '';
                    return `<div class="rarity-${pet.rarity.toLowerCase()} rounded-lg p-2 flex flex-col items-center justify-center relative shadow-sm aspect-square transition hover:scale-105 select-none pet-card bg-white/90 backdrop-blur" onmouseenter="showPetTooltip('${petId}', ${petCounts[petId] || 1}, event)" onmouseleave="hidePetTooltip()"><div class="text-3xl mb-1">${pet.icon}</div><div class="text-xs font-bold text-gray-700 truncate w-full text-center">${pet.name}</div><div class="text-[10px] text-gray-500 font-mono bg-white/50 px-1 rounded">+$${formatCompact(pet.rate)}/s</div></div>`;
                }).join('');
            }
            document.getElementById('pet-count').innerText = state.inventory.length;
        }

        function updateUI() {
            document.getElementById('money-display').innerText = formatCompact(Math.floor(state.money));
            document.getElementById('income-display').innerText = formatCompact(calculateIncome());
            const rDisplay = document.getElementById('rebirth-multiplier-display');
            if(state.rebirth && state.rebirth.multiplier > 1) { rDisplay.innerText = `Rebirth Multiplier: x${state.rebirth.multiplier}`; rDisplay.classList.remove('hidden'); } 
            else { rDisplay.classList.add('hidden'); }
        }

        function createFloatingText(x, y, text) {
            const el = document.createElement('div');
            el.className = 'float-text'; el.style.left = x + 'px'; el.style.top = y + 'px'; el.innerText = text;
            document.body.appendChild(el); setTimeout(() => el.remove(), 1000);
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg; toast.style.opacity = '1'; setTimeout(() => toast.style.opacity = '0', 3000);
        }

        function showEggInfo(eggId) {
            const egg = EGGS.find(e => e.id === eggId);
            if(!egg) return;
            const hatchCount = state.settings.hatchAmount || 1;
            document.getElementById('egg-info-title').innerHTML = `${egg.icon} ${egg.name} Rates${hatchCount > 1 ? ` (x${hatchCount})` : ''}`;
            const list = document.getElementById('egg-info-list');
            list.innerHTML = Object.entries(egg.pool).map(([id, chance]) => ({pet: PETS[id], chance})).filter(d=>d.pet).sort((a,b)=>a.chance-b.chance).map(d => {
                let color = d.chance < 0.05 ? 'text-red-500 font-bold' : (d.chance < 0.15 ? 'text-orange-500 font-bold' : 'text-gray-600');
                return `<div class="flex items-center justify-between p-2 rounded bg-gray-50 border border-gray-100"><div class="flex items-center gap-3"><div class="text-2xl">${d.pet.icon}</div><div><div class="font-bold text-sm text-gray-800">${d.pet.name}</div><div class="text-[10px] uppercase font-bold text-gray-400">${d.pet.rarity}</div></div></div><div class="${color}">${(d.chance*100).toFixed(1)}%</div></div>`;
            }).join('');
            document.getElementById('egg-info-modal').classList.remove('hidden');
        }
        function closeEggInfo() { document.getElementById('egg-info-modal').classList.add('hidden'); }

        function showPetTooltip(petId, count, event) {
            const pet = PETS[petId];
            if (!pet) return;
            const tooltip = document.getElementById('pet-tooltip');
            const content = document.getElementById('pet-tooltip-content');
            const mult = 1 + UPGRADES.income.getEffect(state.upgrades.income);
            const bonus = 1 + UPGRADES.petBonus.getEffect(state.upgrades.petBonus);
            const rMult = state.rebirth.multiplier || 1;
            const effectiveRate = Math.floor(pet.rate * mult * bonus * rMult);
            content.innerHTML = `<div class="font-bold text-lg mb-2 flex items-center gap-2"><span class="text-2xl">${pet.icon}</span><span>${pet.name}</span></div><div class="space-y-1 text-xs"><div><strong>Rarity:</strong> <span class="capitalize">${pet.rarity}</span></div><div><strong>Owned:</strong> ${count}</div><div><strong>Base Income:</strong> $${formatCompact(pet.rate)}/s</div><div><strong>Effective:</strong> $${formatCompact(effectiveRate)}/s</div>${pet.next ? `<div><strong>Next:</strong> ${PETS[pet.next].icon} ${PETS[pet.next].name}</div>` : '<div><strong>Max Tier</strong></div>'}</div>`;
            const rect = event.target.getBoundingClientRect();
            tooltip.style.left = (rect.left + rect.width / 2) + 'px'; tooltip.style.top = (rect.top - 10) + 'px'; tooltip.style.transform = 'translate(-50%, -100%)'; tooltip.style.opacity = '1';
        }
        function hidePetTooltip() { document.getElementById('pet-tooltip').style.opacity = '0'; }

        // --- RESET & SAVE ---
        function openResetModal() { document.getElementById('reset-modal').classList.remove('hidden'); }
        function closeResetModal() { document.getElementById('reset-modal').classList.add('hidden'); }
        function confirmReset() {
            localStorage.removeItem('gibchick_save');
            state = { money: 0, inventory: [], collection: [], upgrades: { luck: 0, income: 0, clickPower: 0, autoClicker: 0, criticalClicks: 0, eggDiscount: 0, petBonus: 0, multiHatch: 0 }, rebirth: { level: 0, multiplier: 1 }, achievements: [], currentWorld: 'home', currentGalaxy: 'origin', settings: { hatchAmount: 1, sortMode: 'rarity_desc' }, stats: { totalClicks: 0, totalEggs: 0, totalMerges: 0, totalMoney: 0 }, lastSave: Date.now() };
            renderInventory(); renderUpgrades(); renderShop(); renderAchievements(); updateUI(); updateAutoClicker(); closeResetModal(); showToast("Account Reset!");
        }
        function saveGame() { try { localStorage.setItem('gibchick_save', JSON.stringify(state)); } catch (e) { console.warn(e); } }
        function loadGame() {
            const saved = localStorage.getItem('gibchick_save');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if(parsed.money !== undefined) state.money = parsed.money;
                    if(parsed.inventory) state.inventory = parsed.inventory;
                    if(parsed.collection) state.collection = parsed.collection; else state.collection = [...new Set(state.inventory)];
                    if(parsed.upgrades) state.upgrades = { ...state.upgrades, ...parsed.upgrades };
                    if(parsed.rebirth) state.rebirth = parsed.rebirth; else state.rebirth = { level: 0, multiplier: 1 };
                    if(parsed.achievements) state.achievements = parsed.achievements;
                    if(parsed.stats) state.stats = { ...state.stats, ...parsed.stats };
                    if(parsed.currentWorld) state.currentWorld = parsed.currentWorld; else state.currentWorld = 'home';
                    if(parsed.currentGalaxy) state.currentGalaxy = parsed.currentGalaxy; else state.currentGalaxy = 'origin';
                    if(parsed.settings) state.settings = parsed.settings; else state.settings = { hatchAmount: 1, sortMode: 'rarity_desc' };
                } catch (e) { console.error("Save corrupted"); }
            } else { state.money = 0; state.collection = []; }
        }
    </script>
</body>
</html>
