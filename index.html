<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gibchick - Ultimate Idle Clicker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Fredoka', sans-serif;
            transition: background 1s ease, color 0.5s ease;
            overscroll-behavior: none;
            user-select: none;
        }

        /* --- WORLD THEMES --- */
        .bg-world-home { background: linear-gradient(135deg, #e0f7fa 0%, #80deea 100%); }
        .bg-world-spooky { background: linear-gradient(135deg, #2d1b4e 0%, #1a102e 100%); color: black; }
        .bg-world-jurassic { background: linear-gradient(135deg, #fed7aa 0%, #fb923c 100%); }
        .bg-world-frozen { background: linear-gradient(135deg, #cffafe 0%, #67e8f9 100%); }
        .bg-world-magic { background: linear-gradient(135deg, #fbcfe8 0%, #f472b6 100%); }
        .bg-world-space { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); color: #1f2937; } 
        .bg-world-divine { background: linear-gradient(135deg, #fef9c3 0%, #facc15 100%); }
        
        .bg-world-cyber { background: linear-gradient(135deg, #0f172a 0%, #0ea5e9 100%); color: #1f2937; }
        .bg-world-volcano { background: linear-gradient(135deg, #450a0a 0%, #ef4444 100%); color: #fecaca; }
        .bg-world-candy { background: linear-gradient(135deg, #fdf4ff 0%, #f5d0fe 100%); color: #86198f; }
        .bg-world-atlantis { background: linear-gradient(135deg, #022c22 0%, #0d9488 100%); color: #1f2937; }
        .bg-world-shadow { background: linear-gradient(135deg, #000000 0%, #581c87 100%); color: #1f2937; }
        .bg-world-celestial { background: linear-gradient(135deg, #fffbeb 0%, #fcd34d 50%, #fffbeb 100%); color: #78350f; }
        .bg-world-radioactive { background: linear-gradient(135deg, #14532d 0%, #4ade80 100%); color: #064e3b; }

        .bg-world-gold { background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%); color: #7c5e10; }
        .bg-world-rainbow { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 20%, #a18cd1 100%); color: #4a044e; }
        .bg-world-mecha { background: linear-gradient(135deg, #2c3e50 0%, #bdc3c7 100%); color: #1f2937; }
        .bg-world-darkmatter { background: linear-gradient(135deg, #000000 0%, #434343 100%); color: #1f2937; }

        /* Forced Dark Text for White Cards */
        .bg-white, .bg-white\/90 { color: #1f2937; }

        .shake-animation { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite; }
        @keyframes shake { 10%,90%{transform:translate3d(-1px,0,0) rotate(-5deg)} 20%,80%{transform:translate3d(2px,0,0) rotate(5deg)} 30%,50%,70%{transform:translate3d(-4px,0,0) rotate(-5deg)} 40%,60%{transform:translate3d(4px,0,0) rotate(5deg)} }
        
        .pop-in { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { 0%{opacity:0;transform:scale(0.5)} 100%{opacity:1;transform:scale(1)} }
        
        .float-text { position: absolute; animation: floatUp 1s forwards; pointer-events: none; font-weight: bold; color: #10b981; text-shadow: 1px 1px 0 #fff; z-index: 50; }
        @keyframes floatUp { 0%{opacity:1;transform:translateY(0)} 100%{opacity:0;transform:translateY(-50px)} }

        /* Rarity & Mutation Styles */
        .rarity-common { background: linear-gradient(to bottom right, #f3f4f6, #d1d5db); border: 2px solid #9ca3af; }
        .rarity-uncommon { background: linear-gradient(to bottom right, #d1fae5, #6ee7b7); border: 2px solid #10b981; }
        .rarity-rare { background: linear-gradient(to bottom right, #dbeafe, #60a5fa); border: 2px solid #2563eb; }
        .rarity-epic { background: linear-gradient(to bottom right, #f3e8ff, #c084fc); border: 2px solid #9333ea; }
        .rarity-legendary { background: linear-gradient(to bottom right, #fef3c7, #fcd34d); border: 2px solid #d97706; box-shadow: 0 0 10px #fbbf24; }
        .rarity-mythical { background: linear-gradient(to bottom right, #fee2e2, #f87171); border: 2px solid #dc2626; box-shadow: 0 0 15px #ef4444; animation: pulse-mythical 2s infinite; }
        .rarity-godly { background: linear-gradient(to bottom right, #2d2d2d, #000000); border: 2px solid #a8a8a8; box-shadow: 0 0 20px #ffffff; color: white; animation: pulse-godly 3s infinite; }
        .rarity-transcendent { background: linear-gradient(to bottom right, #000000, #1a1a2e, #16213e); border: 3px solid #ffd700; box-shadow: 0 0 30px #ffd700, 0 0 60px #ffd700; color: #ffd700; animation: pulse-transcendent 2s infinite; }
        .rarity-eternal { background: linear-gradient(to bottom right, #0891b2, #ecfeff, #0891b2); border: 3px solid #22d3ee; box-shadow: 0 0 40px #22d3ee, 0 0 80px #67e8f9; color: #0e7490; animation: pulse-eternal 4s infinite; }
        .rarity-special { background: linear-gradient(124deg, #ff2400, #e81d1d, #e8b71d, #e3e81d, #1de840, #1ddde8, #2b1de8, #dd00f3, #dd00f3); background-size: 400% 400%; border: 3px solid white; box-shadow: 0 0 20px #ffffff; color: white; text-shadow: 1px 1px 2px black; animation: rainbow 6s ease infinite; }

        /* Mutation Badges */
        .mutation-badge { position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; border-radius: 50%; display: flex; items-center; justify-content: center; font-size: 12px; border: 1px solid white; z-index: 10; }
        .mut-gold { background: #ffd700; color: #b45309; box-shadow: 0 0 5px #ffd700; }
        .mut-rainbow { background: linear-gradient(124deg, #ff2400, #e81d1d, #e8b71d, #e3e81d, #1de840, #1ddde8, #2b1de8, #dd00f3); color: white; }
        .mut-darkmatter { background: black; color: #00ffcc; border-color: #00ffcc; }
        .mut-radioactive { background: #4ade80; color: #14532d; }
        .mut-revival { background: #f472b6; color: white; }
        .mut-chaos { background: #dc2626; color: white; }

        .rarity-godly .text-gray-700, .rarity-transcendent .text-gray-700, .rarity-eternal .text-gray-700, .rarity-special .text-gray-700 { color: inherit !important; }
        .rarity-godly .text-gray-500, .rarity-transcendent .text-gray-500, .rarity-eternal .text-gray-500, .rarity-special .text-gray-500 { color: rgba(255,255,255,0.7) !important; }

        @keyframes pulse-godly { 0%{box-shadow:0 0 10px #ffffff} 50%{box-shadow:0 0 30px #888,0 0 50px #fff} 100%{box-shadow:0 0 10px #ffffff} }
        @keyframes pulse-mythical { 0%{box-shadow:0 0 10px #ef4444} 50%{box-shadow:0 0 20px #f87171,0 0 40px #fca5a5} 100%{box-shadow:0 0 10px #ef4444} }
        @keyframes pulse-transcendent { 0%{box-shadow:0 0 20px #ffd700,0 0 40px #ffd700} 50%{box-shadow:0 0 40px #ffd700,0 0 80px #ffed4e,0 0 120px #ffd700} 100%{box-shadow:0 0 20px #ffd700,0 0 40px #ffd700} }
        @keyframes pulse-eternal { 0%{background-position:0% 50%;box-shadow:0 0 30px #22d3ee} 50%{background-position:100% 50%;box-shadow:0 0 60px #67e8f9,0 0 90px #a5f3fc} 100%{background-position:0% 50%;box-shadow:0 0 30px #22d3ee} }
        @keyframes rainbow { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); }
        .pet-silhouette { filter: brightness(0) opacity(0.2); }
        .pet-locked-text { color: transparent; text-shadow: 0 0 8px rgba(0,0,0,0.5); }
    </style>
</head>
<body id="game-body" class="h-screen flex flex-col overflow-hidden text-gray-800 bg-world-home">

    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-md shadow-md p-4 flex justify-between items-center z-10 shrink-0">
        <div class="flex items-center gap-3">
            <div class="text-3xl">ğŸ£</div>
            <div>
                <h1 class="font-bold text-xl leading-none text-purple-600">Gibchick</h1>
                <span class="text-xs text-gray-500">Collect 'em all!</span>
            </div>
            <button onclick="openAdminModal()" class="ml-2 text-gray-400 hover:text-red-500 transition text-sm" title="Admin"><i class="fas fa-user-shield"></i></button>
            <button onclick="openRebirthModal()" class="ml-2 text-purple-500 hover:text-purple-700 transition text-sm animate-pulse" title="Rebirth"><i class="fas fa-sync-alt text-xl"></i></button>
            <button onclick="openKitchenModal()" class="ml-2 text-green-500 hover:text-green-700 transition text-sm" title="Kitchen Cosmos"><i class="fas fa-atom text-xl"></i></button>
            <button onclick="openIndexModal()" class="ml-2 text-blue-400 hover:text-blue-600 transition text-sm" title="Pet Index"><i class="fas fa-book-open text-xl"></i></button>
            <button onclick="openResetModal()" class="ml-2 text-gray-300 hover:text-red-500 transition text-sm" title="Reset Progress"><i class="fas fa-trash-alt"></i></button>
        </div>
        
        <div class="flex gap-6 text-right">
            <div>
                <div class="text-xs text-gray-500 font-bold uppercase">Cash</div>
                <div class="text-2xl font-bold text-green-600 flex items-center gap-1 justify-end">$<span id="money-display">0</span></div>
            </div>
            <div>
                <div class="text-xs text-gray-500 font-bold uppercase">Income</div>
                <div class="text-xl font-bold text-blue-500 flex items-center gap-1 justify-end">$<span id="income-display">0</span><span class="text-sm text-gray-400">/s</span></div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
        
        <!-- Left Panel -->
        <section class="flex-1 p-4 overflow-y-auto flex flex-col gap-6 relative" id="click-area">
            
            <div class="bg-white/90 backdrop-blur rounded-2xl shadow-lg p-6 text-center transform hover:scale-[1.02] transition-transform cursor-pointer active:scale-95 select-none text-gray-800" onclick="manualClick(event)">
                <div class="text-6xl mb-2">ğŸ¥</div>
                <h2 class="font-bold text-xl mb-1">Click for Cash!</h2>
                <p class="text-gray-500 text-sm">Get quick money to buy eggs</p>
                <div id="rebirth-multiplier-display" class="text-xs text-purple-600 font-bold mt-2 hidden">Rebirth Multiplier: x1</div>
            </div>

            <!-- World Selector & Egg Shop -->
            <div>
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-lg flex items-center gap-2"><i class="fas fa-globe text-blue-500"></i> Worlds</h3>
                    <div class="text-xs opacity-80" id="world-status">Home Village</div>
                </div>
                
                <!-- Galaxy Navigation -->
                <div class="flex gap-2 overflow-x-auto pb-2 mb-2 scrollbar-hide border-b border-gray-200/20" id="galaxy-nav-container"></div>
                <!-- World Navigation Scroll -->
                <div class="flex gap-2 overflow-x-auto pb-4 mb-2 scrollbar-hide" id="world-nav-container"></div>
                
                <!-- Hatch Slider -->
                <div class="mb-4 px-2" id="hatch-slider-container" style="display:none;">
                     <div class="flex justify-between text-xs font-bold mb-1 opacity-90">
                         <span>Hatch Amount</span>
                         <span id="hatch-amount-display">1x</span>
                     </div>
                     <input type="range" id="hatch-amount-slider" min="1" max="1" value="1" class="w-full accent-blue-500" oninput="updateHatchSetting(this.value)">
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4" id="egg-shop-container"></div>
             </div>

             <!-- Upgrades -->
             <div>
                 <h3 class="font-bold text-lg mb-3 flex items-center gap-2"><i class="fas fa-arrow-up text-purple-500"></i> Upgrades</h3>
                 <div id="upgrades-container" class="grid grid-cols-1 gap-3"></div>
             </div>

             <!-- Achievements -->
             <div>
                 <h3 class="font-bold text-lg mb-3 flex items-center gap-2"><i class="fas fa-trophy text-yellow-500"></i> Achievements <span id="achievement-count" class="bg-yellow-100 text-yellow-600 px-2 py-0.5 rounded-full text-xs">0/14</span></h3>
                 <div id="achievements-container" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto"></div>
             </div>
         </section>

         <!-- Right Panel -->
        <section class="flex-1 bg-white/50 backdrop-blur-sm border-l border-white/20 p-4 overflow-y-auto flex flex-col">
            <div class="flex justify-between items-center mb-4 gap-2 flex-wrap text-gray-800">
                <h3 class="font-bold text-lg flex items-center gap-2"><i class="fas fa-paw text-purple-500"></i> My Pets <span id="pet-count" class="bg-purple-100 text-purple-600 px-2 py-0.5 rounded-full text-xs">0</span></h3>
                <div class="flex gap-2">
                    <select id="sort-inventory" onchange="updateSortSetting(this.value)" class="bg-white border border-gray-300 text-gray-700 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5">
                        <option value="rarity_desc">Rarity (High)</option>
                        <option value="rarity_asc">Rarity (Low)</option>
                        <option value="power_desc">Power (High)</option>
                        <option value="newest">Newest</option>
                        <option value="name">Name</option>
                    </select>
                    <button onclick="openMergeModal()" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded-full transition shadow-sm flex items-center gap-1"><i class="fas fa-random"></i> Merge</button>
                </div>
            </div>
            <div class="relative flex-1 overflow-y-auto pr-1">
                <div id="empty-inventory" class="text-center py-10 text-gray-400 italic">You have no pets yet. Buy an egg to start!</div>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 gap-3 content-start pb-4" id="inventory-container"></div>
            </div>
        </section>

    </main>

    <!-- Overlays -->
    <div id="kitchen-modal" class="fixed inset-0 bg-black/90 z-[80] hidden flex items-center justify-center backdrop-blur-sm p-4 text-gray-800">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 relative h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <div>
                    <h2 class="text-2xl font-bold text-green-600 flex items-center gap-2"><i class="fas fa-atom"></i> Kitchen Cosmos</h2>
                    <p class="text-xs text-gray-500">Mutate your pets... or destroy them.</p>
                </div>
                <button onclick="closeKitchenModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-2xl"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto bg-gray-50 rounded-lg p-4 mb-4">
                <div id="cosmos-grid" class="grid grid-cols-4 gap-3"></div>
                <div class="mt-4 text-xs text-gray-500">
                    <h4 class="font-bold text-gray-700">Mutation Chances (Per tick):</h4>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1 mt-1">
                        <div class="flex items-center gap-1"><div class="w-2 h-2 bg-yellow-400 rounded-full"></div> Gold (x2): 50%</div>
                        <div class="flex items-center gap-1"><div class="w-2 h-2 bg-gradient-to-r from-red-500 to-blue-500 rounded-full"></div> Rainbow (x4): 10%</div>
                        <div class="flex items-center gap-1"><div class="w-2 h-2 bg-black rounded-full"></div> Dark Matter (x10): 10%</div>
                        <div class="flex items-center gap-1"><div class="w-2 h-2 bg-green-500 rounded-full"></div> Radioactive: 5%</div>
                        <div class="flex items-center gap-1"><div class="w-2 h-2 bg-pink-400 rounded-full"></div> Revival: 1%</div>
                        <div class="flex items-center gap-1"><div class="w-2 h-2 bg-red-600 rounded-full"></div> Chaos (+25% Type): 4%</div>
                        <div class="flex items-center gap-1 col-span-2 font-bold text-red-600"><i class="fas fa-skull"></i> Destruction: 20% + Time</div>
                    </div>
                </div>
            </div>
            
            <div class="border-t pt-4">
                <h3 class="font-bold text-sm mb-2">Add from Inventory</h3>
                <div id="cosmos-inventory" class="flex gap-2 overflow-x-auto pb-2 h-20"></div>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="fixed inset-0 bg-black/90 z-[100] hidden flex items-center justify-center backdrop-blur-sm p-4 text-gray-800">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 relative">
            <button onclick="closeAdminModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-4 text-center text-red-600"><i class="fas fa-user-shield"></i> Admin Panel</h2>
            <div id="admin-login-view">
                <p class="text-sm text-gray-600 mb-4 text-center">Enter Access Code</p>
                <input type="password" id="admin-password-input" class="w-full border p-2 rounded mb-4 text-center text-xl tracking-widest text-gray-800" placeholder="----">
                <button onclick="checkAdminPassword()" class="w-full bg-red-600 text-white font-bold py-2 rounded hover:bg-red-700 transition">Unlock</button>
            </div>
            <div id="admin-dashboard-view" class="hidden space-y-4">
                <div class="bg-gray-100 p-3 rounded">
                    <label class="block text-xs font-bold text-gray-500 mb-1">ADD CASH</label>
                    <div class="flex gap-2">
                        <input type="number" id="admin-money-input" class="flex-1 border p-2 rounded text-sm text-gray-800" placeholder="Amount">
                        <button onclick="adminAddMoney()" class="bg-green-500 text-white px-3 rounded font-bold hover:bg-green-600">+</button>
                    </div>
                </div>
                <div class="bg-gray-100 p-3 rounded">
                    <label class="block text-xs font-bold text-gray-500 mb-1">GIVE PET</label>
                    <div class="flex gap-2">
                        <select id="admin-pet-select" class="flex-1 border p-2 rounded text-sm bg-white text-gray-800"></select>
                        <button onclick="adminAddPet()" class="bg-blue-500 text-white px-3 rounded font-bold hover:bg-blue-600">+</button>
                    </div>
                </div>
                <div class="bg-gray-100 p-3 rounded">
                    <label class="block text-xs font-bold text-gray-500 mb-1">SET REBIRTH LEVEL</label>
                    <div class="flex gap-2">
                        <input type="number" id="admin-rebirth-input" class="flex-1 border p-2 rounded text-sm text-gray-800" placeholder="Level (0-1000)">
                        <button onclick="adminSetRebirth()" class="bg-purple-600 text-white px-3 rounded font-bold hover:bg-purple-700">SET</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="hatch-overlay" class="fixed inset-0 bg-black/80 z-50 hidden flex flex-col items-center justify-center backdrop-blur-sm p-4 overflow-y-auto">
        <div class="relative flex flex-col items-center justify-center w-full min-h-[50vh]">
            <div id="hatch-egg-display" class="transition-all duration-300 cursor-pointer relative z-10"></div>
            <div id="hatch-rays" class="absolute inset-0 bg-yellow-400 rounded-full blur-3xl opacity-0 transition-opacity duration-500 -z-10 animate-pulse pointer-events-none"></div>
            <div id="hatch-message" class="text-white text-2xl font-bold mt-8 text-center h-8 z-20">Tap to Hatch!</div>
            <div id="new-pet-card" class="hidden transform transition-all duration-500 z-30">
                <div class="bg-white p-6 rounded-2xl shadow-2xl text-center w-64 border-4 text-gray-800" id="reveal-card-bg">
                    <div class="text-sm font-bold uppercase tracking-wider mb-2" id="reveal-rarity">Common</div>
                    <div class="text-8xl mb-4 pop-in" id="reveal-icon">ğŸ¥</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-1" id="reveal-name">Baby Chick</h2>
                    <div class="text-green-600 font-bold text-lg mb-4">+$<span id="reveal-rate">1</span>/s</div>
                    <button onclick="closeHatchModal()" class="bg-gray-800 text-white px-6 py-2 rounded-full font-bold hover:bg-gray-700 transition w-full">Awesome!</button>
                </div>
            </div>
            <div id="multi-pet-grid" class="hidden grid grid-cols-2 sm:grid-cols-3 gap-4 max-w-3xl w-full z-30 mt-4"></div>
            <button id="multi-hatch-close-btn" onclick="closeHatchModal()" class="hidden mt-8 bg-gray-800 text-white px-8 py-3 rounded-full font-bold hover:bg-gray-700 transition shadow-lg z-40 animate-bounce">Awesome!</button>
        </div>
    </div>

    <div id="egg-info-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden text-gray-800">
            <div id="egg-info-header" class="p-4 bg-gray-100 border-b flex justify-between items-center">
                <h2 class="font-bold text-xl flex items-center gap-2" id="egg-info-title">Egg Info</h2>
                <button onclick="closeEggInfo()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 max-h-[60vh] overflow-y-auto">
                <div id="egg-info-list" class="space-y-2"></div>
            </div>
            <div class="p-4 bg-gray-50 border-t text-center text-xs text-gray-500">Good luck!</div>
        </div>
    </div>

    <div id="merge-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[80vh] text-gray-800">
            <div class="p-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white flex justify-between items-center shrink-0">
                <div>
                    <h2 class="font-bold text-xl"><i class="fas fa-flask"></i> Merge Chamber</h2>
                    <p class="text-xs opacity-90">Fuse 3 identical pets to upgrade!</p>
                </div>
                <button onclick="closeMergeModal()" class="text-white/80 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 overflow-y-auto flex-1 bg-gray-50">
                <div id="merge-list" class="space-y-3"></div>
                <div id="no-merge-msg" class="hidden text-center py-8 text-gray-400">
                    <div class="text-4xl mb-2">ğŸ§¬</div>
                    <p>You need 3 of the same pet to merge.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="index-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[90vh] overflow-hidden flex flex-col text-gray-800">
            <div class="p-4 bg-blue-600 text-white flex justify-between items-center shrink-0">
                <div>
                    <h2 class="font-bold text-2xl flex items-center gap-2"><i class="fas fa-book-open"></i> Pet Index</h2>
                    <p class="text-sm opacity-90" id="index-progress-text">Collected: 0/0</p>
                </div>
                <button onclick="closeIndexModal()" class="text-white/80 hover:text-white text-2xl"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 bg-gray-100">
                <div id="index-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4"></div>
            </div>
            <div class="p-4 bg-white border-t flex flex-col sm:flex-row items-center justify-between gap-4">
                <div>
                    <h3 class="font-bold text-lg text-gray-800">Completion Reward</h3>
                    <p class="text-xs text-gray-500">Collect all standard pets to unlock the Guardian Griffin!</p>
                </div>
                <button id="claim-reward-btn" onclick="claimIndexReward()" disabled class="bg-gray-300 text-gray-500 font-bold py-3 px-8 rounded-full transition cursor-not-allowed flex items-center gap-2">
                    <span>Locked</span> <i class="fas fa-lock"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="rebirth-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-gray-900 border border-purple-500 rounded-2xl shadow-2xl w-full max-w-md p-6 text-center text-white relative overflow-hidden">
            <div class="absolute inset-0 bg-purple-600 opacity-10 animate-pulse pointer-events-none"></div>
            <div class="relative z-10">
                <div class="text-5xl mb-4">ğŸŒ€</div>
                <h2 class="text-3xl font-bold mb-2 text-purple-300">Rebirth</h2>
                <div id="rebirth-info" class="mb-6">
                    <p class="text-gray-300 mb-2">Current Multiplier: <span id="rebirth-current-mult" class="text-green-400 font-bold">x1</span></p>
                    <p class="text-gray-300 mb-4">Rebirth Level: <span id="rebirth-current-level" class="text-blue-400 font-bold">0</span></p>
                    <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                        <div class="text-sm font-bold uppercase text-gray-500 mb-2">Next Rebirth Requirements</div>
                        <div id="rebirth-reqs" class="text-xl font-bold flex justify-center items-center gap-2 mb-2"></div>
                        <div class="text-xs text-gray-400 italic">Sacrifice these pets to ascend.</div>
                        <div class="mt-3 pt-3 border-t border-gray-700">
                            <div class="text-sm">New Multiplier: <span id="rebirth-next-mult" class="text-purple-400 font-bold text-lg">x1.5</span></div>
                            <div class="text-sm text-yellow-300 mt-1" id="rebirth-unlock-msg"></div>
                        </div>
                    </div>
                </div>
                <p class="text-red-400 text-xs mb-6">Warning: Rebirthing resets your Money, Inventory, and Upgrades. Achievements and Index are saved.</p>
                <div class="flex gap-3 justify-center">
                    <button onclick="closeRebirthModal()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full transition">Cancel</button>
                    <button onclick="performRebirth()" id="rebirth-confirm-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-8 rounded-full transition shadow-lg shadow-purple-500/30 disabled:opacity-50 disabled:cursor-not-allowed">Rebirth</button>
                </div>
            </div>
        </div>
    </div>

    <div id="reset-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center text-gray-800">
            <div class="text-red-500 text-5xl mb-4"><i class="fas fa-exclamation-triangle"></i></div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Reset Account?</h2>
            <p class="text-gray-600 mb-6">Are you sure you want to wipe all your progress? This cannot be undone.</p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeResetModal()" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-full hover:bg-gray-300 transition">Cancel</button>
                <button onclick="confirmReset()" class="bg-red-500 text-white font-bold py-2 px-6 rounded-full hover:bg-red-600 transition">Reset</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-[60] text-sm font-bold text-center">Notification</div>
    <div id="pet-tooltip" class="fixed bg-white rounded-lg shadow-xl border-2 border-gray-200 p-3 opacity-0 transition-opacity duration-200 pointer-events-none z-[70] text-sm max-w-xs text-gray-800"><div id="pet-tooltip-content"></div></div>

    <script>
        // --- DATA ---
        const GALAXIES = [
            { id: 'origin', name: 'Origin System', icon: 'ğŸŒŒ', minRebirth: 0, worlds: ['home', 'spooky', 'jurassic', 'frozen', 'magic'] },
            { id: 'astral', name: 'Astral Sector', icon: 'ğŸª', minRebirth: 5, worlds: ['space', 'divine', 'cyber', 'volcano'] },
            { id: 'mystic', name: 'Mystic Reach', icon: 'âœ¨', minRebirth: 11, worlds: ['candy', 'atlantis', 'shadow', 'celestial'] },
            { id: 'chickverse', name: 'Chickverse', icon: 'ğŸ£', minRebirth: 20, worlds: ['gold', 'rainbow', 'mecha', 'darkmatter'] },
            { id: 'apocalypse', name: 'Apocalypse', icon: 'â˜¢ï¸', minRebirth: 2, worlds: ['radioactive'] }
        ];

        const WORLDS = [
            { id: 'home', name: 'Home Village', minRebirth: 0, bgClass: 'bg-world-home', eggIds: ['starter', 'farm', 'aqua', 'desert'] },
            { id: 'spooky', name: 'Haunted Forest', minRebirth: 1, bgClass: 'bg-world-spooky', eggIds: ['spooky', 'forest'] },
            { id: 'jurassic', name: 'Jurassic Isle', minRebirth: 2, bgClass: 'bg-world-jurassic', eggIds: ['prehistoric', 'jungle'] },
            { id: 'frozen', name: 'Frozen Tundra', minRebirth: 3, bgClass: 'bg-world-frozen', eggIds: ['arctic'] },
            { id: 'magic', name: 'Magic Realm', minRebirth: 4, bgClass: 'bg-world-magic', eggIds: ['fantasy', 'mystery'] },
            { id: 'space', name: 'Deep Space', minRebirth: 5, bgClass: 'bg-world-space', eggIds: ['cosmic', 'void'] },
            { id: 'divine', name: 'Divine Plane', minRebirth: 6, bgClass: 'bg-world-divine', eggIds: ['divine'] },
            { id: 'cyber', name: 'Cyber City', minRebirth: 9, bgClass: 'bg-world-cyber', eggIds: ['cyber'] },
            { id: 'volcano', name: 'Volcanic Core', minRebirth: 10, bgClass: 'bg-world-volcano', eggIds: ['magma'] },
            { id: 'candy', name: 'Candy Land', minRebirth: 11, bgClass: 'bg-world-candy', eggIds: ['sugar'] },
            { id: 'atlantis', name: 'Atlantis', minRebirth: 12, bgClass: 'bg-world-atlantis', eggIds: ['abyssal'] },
            { id: 'shadow', name: 'Shadow Realm', minRebirth: 13, bgClass: 'bg-world-shadow', eggIds: ['eclipse'] },
            { id: 'celestial', name: 'Celestial Haven', minRebirth: 14, bgClass: 'bg-world-celestial', eggIds: ['ether', 'infinity'] },
            { id: 'gold', name: 'Gilded Coop', minRebirth: 20, bgClass: 'bg-world-gold', eggIds: ['treasury'] },
            { id: 'rainbow', name: 'Prismatic Fields', minRebirth: 25, bgClass: 'bg-world-rainbow', eggIds: ['spectrum'] },
            { id: 'mecha', name: 'Mecha Base', minRebirth: 30, bgClass: 'bg-world-mecha', eggIds: ['machinery'] },
            { id: 'darkmatter', name: 'Void Nexus', minRebirth: 35, bgClass: 'bg-world-darkmatter', eggIds: ['singularity'] },
            { id: 'radioactive', name: 'Radioactive Wasteland', minRebirth: 0, bgClass: 'bg-world-radioactive', eggIds: ['toxic'], hidden: true }
        ];

        const PETS = {
            'ant': { id: 'ant', name: 'Worker Ant', icon: 'ğŸœ', rate: 1, rarity: 'Common', next: 'chick' },
            'chick': { id: 'chick', name: 'Baby Chick', icon: 'ğŸ¥', rate: 2, rarity: 'Common', next: 'mouse' },
            'mouse': { id: 'mouse', name: 'Field Mouse', icon: 'ğŸ', rate: 3, rarity: 'Common', next: 'fish' },
            'fish': { id: 'fish', name: 'Goldfish', icon: 'ğŸ ', rate: 5, rarity: 'Common', next: 'beetle' },
            'beetle': { id: 'beetle', name: 'Beetle', icon: 'ğŸ', rate: 8, rarity: 'Common', next: 'spider' },
            'spider': { id: 'spider', name: 'Spider', icon: 'ğŸ•·ï¸', rate: 12, rarity: 'Common', next: 'bee' },
            'bee': { id: 'bee', name: 'Honey Bee', icon: 'ğŸ', rate: 16, rarity: 'Common', next: 'cat' },
            'cat': { id: 'cat', name: 'Stray Cat', icon: 'ğŸˆ', rate: 20, rarity: 'Uncommon', next: 'dog' },
            'dog': { id: 'dog', name: 'Good Boy', icon: 'ğŸ•', rate: 30, rarity: 'Uncommon', next: 'pig' },
            'pig': { id: 'pig', name: 'Piggy', icon: 'ğŸ–', rate: 45, rarity: 'Uncommon', next: 'sheep' },
            'sheep': { id: 'sheep', name: 'Sheep', icon: 'ğŸ‘', rate: 60, rarity: 'Uncommon', next: 'snake' },
            'snake': { id: 'snake', name: 'Snake', icon: 'ğŸ', rate: 80, rarity: 'Uncommon', next: 'crab' },
            'crab': { id: 'crab', name: 'Crab', icon: 'ğŸ¦€', rate: 100, rarity: 'Uncommon', next: 'frog' },
            'frog': { id: 'frog', name: 'Frog', icon: 'ğŸ¸', rate: 125, rarity: 'Uncommon', next: 'fox' },
            'fox': { id: 'fox', name: 'Sly Fox', icon: 'ğŸ¦Š', rate: 150, rarity: 'Rare', next: 'monkey' },
            'monkey': { id: 'monkey', name: 'Monkey', icon: 'ğŸ’', rate: 200, rarity: 'Rare', next: 'penguin' },
            'penguin': { id: 'penguin', name: 'Penguin', icon: 'ğŸ§', rate: 300, rarity: 'Rare', next: 'owl' },
            'owl': { id: 'owl', name: 'Wise Owl', icon: 'ğŸ¦‰', rate: 400, rarity: 'Rare', next: 'camel' },
            'camel': { id: 'camel', name: 'Camel', icon: 'ğŸ«', rate: 500, rarity: 'Rare', next: 'turtle' },
            'turtle': { id: 'turtle', name: 'Turtle', icon: 'ğŸ¢', rate: 650, rarity: 'Rare', next: 'wolf' },
            'wolf': { id: 'wolf', name: 'Wolf', icon: 'ğŸº', rate: 800, rarity: 'Rare', next: 'vulture' },
            'vulture': { id: 'vulture', name: 'Vulture', icon: 'ğŸ¦…', rate: 1000, rarity: 'Rare', next: 't-rex' },
            't-rex': { id: 't-rex', name: 'T-Rex', icon: 'ğŸ¦–', rate: 1500, rarity: 'Epic', next: 'shark' },
            'shark': { id: 'shark', name: 'Great White', icon: 'ğŸ¦ˆ', rate: 1800, rarity: 'Epic', next: 'alien' },
            'alien': { id: 'alien', name: 'Martian', icon: 'ğŸ‘½', rate: 2100, rarity: 'Epic', next: 'robot' },
            'robot': { id: 'robot', name: 'Bot-X', icon: 'ğŸ¤–', rate: 2500, rarity: 'Epic', next: 'tiger' },
            'tiger': { id: 'tiger', name: 'Bengal Tiger', icon: 'ğŸ…', rate: 2900, rarity: 'Epic', next: 'bear' },
            'bear': { id: 'bear', name: 'Grizzly', icon: 'ğŸ»', rate: 3300, rarity: 'Epic', next: 'triceratops' },
            'triceratops': { id: 'triceratops', name: 'Triceratops', icon: 'ğŸ¦•', rate: 3700, rarity: 'Epic', next: 'pterodactyl' },
            'pterodactyl': { id: 'pterodactyl', name: 'Pterodactyl', icon: 'ğŸ¦‡', rate: 4100, rarity: 'Epic', next: 'skeleton' },
            'skeleton': { id: 'skeleton', name: 'Skeleton', icon: 'ğŸ’€', rate: 4500, rarity: 'Epic', next: 'unicorn' },
            'unicorn': { id: 'unicorn', name: 'Unicorn', icon: 'ğŸ¦„', rate: 5000, rarity: 'Legendary', next: 'dragon' },
            'dragon': { id: 'dragon', name: 'Red Dragon', icon: 'ğŸ‰', rate: 6000, rarity: 'Legendary', next: 'yeti' },
            'yeti': { id: 'yeti', name: 'Abominable', icon: 'ğŸ¦', rate: 7500, rarity: 'Legendary', next: 'mammoth' },
            'mammoth': { id: 'mammoth', name: 'Mammoth', icon: 'ğŸ¦£', rate: 10000, rarity: 'Legendary', next: 'reaper' },
            'reaper': { id: 'reaper', name: 'Grim Reaper', icon: 'ğŸ•¯ï¸', rate: 15000, rarity: 'Legendary', next: 'griffin' },
            'griffin': { id: 'griffin', name: 'Chimera', icon: 'ğŸ¦', rate: 25000, rarity: 'Legendary', next: 'phoenix' },
            'phoenix': { id: 'phoenix', name: 'Phoenix', icon: 'ğŸ”¥', rate: 50000, rarity: 'Mythical', next: 'kraken' },
            'kraken': { id: 'kraken', name: 'The Kraken', icon: 'ğŸ™', rate: 100000, rarity: 'Mythical', next: 'hydra' },
            'hydra': { id: 'hydra', name: 'Hydra', icon: 'ğŸ', rate: 250000, rarity: 'Mythical', next: 'titan' },
            'titan': { id: 'titan', name: 'Titan', icon: 'ğŸ—¿', rate: 500000, rarity: 'Mythical', next: 'void' },
            'void': { id: 'void', name: 'The Void', icon: 'ğŸŒŒ', rate: 1000000, rarity: 'Godly', next: 'cosmos' },
            'cosmos': { id: 'cosmos', name: 'The Cosmos', icon: 'ğŸŒŒ', rate: 5000000, rarity: 'Transcendent', next: 'cyborg' },
            'cyborg': { id: 'cyborg', name: 'Cyborg', icon: 'ğŸ¤–', rate: 25000000, rarity: 'Godly', next: 'magma_lord' },
            'magma_lord': { id: 'magma_lord', name: 'Magma Lord', icon: 'ğŸ‘¹', rate: 100000000, rarity: 'Godly', next: 'candy_king' },
            'candy_king': { id: 'candy_king', name: 'Candy King', icon: 'ğŸ¬', rate: 500000000, rarity: 'Godly', next: 'leviathan' },
            'leviathan': { id: 'leviathan', name: 'Leviathan', icon: 'ğŸ‹', rate: 2000000000, rarity: 'Transcendent', next: 'nightmare' },
            'nightmare': { id: 'nightmare', name: 'Nightmare', icon: 'ğŸŒš', rate: 10000000000, rarity: 'Transcendent', next: 'archangel' },
            'archangel': { id: 'archangel', name: 'Archangel', icon: 'ğŸ‘¼', rate: 50000000000, rarity: 'Transcendent', next: 'chronos' },
            'chronos': { id: 'chronos', name: 'Chronos', icon: 'â³', rate: 250000000000, rarity: 'Eternal', next: 'golden_chick' },
            'drone': { id: 'drone', name: 'Drone', icon: 'ğŸš', rate: 150000, rarity: 'Epic', next: 'cyborg' },
            'magma_golem': { id: 'magma_golem', name: 'Magma Golem', icon: 'ğŸŒ‹', rate: 2000000, rarity: 'Legendary', next: 'magma_lord' },
            'gummy_bear': { id: 'gummy_bear', name: 'Gummy Bear', icon: 'ğŸ§¸', rate: 5000, rarity: 'Rare', next: 'candy_king' },
            'mermaid': { id: 'mermaid', name: 'Mermaid', icon: 'ğŸ§œâ€â™€ï¸', rate: 5000000, rarity: 'Legendary', next: 'leviathan' },
            'wraith': { id: 'wraith', name: 'Wraith', icon: 'ğŸ‘»', rate: 8000000, rarity: 'Legendary', next: 'nightmare' },
            'cherub': { id: 'cherub', name: 'Cherub', icon: 'ğŸ¹', rate: 12000000, rarity: 'Mythical', next: 'archangel' },
            'golden_chick': { id: 'golden_chick', name: 'Golden Chick', icon: 'ğŸ†', rate: 1000000000000, rarity: 'Legendary', next: 'rainbow_chick' },
            'rainbow_chick': { id: 'rainbow_chick', name: 'Rainbow Chick', icon: 'ğŸŒˆ', rate: 5000000000000, rarity: 'Mythical', next: 'mecha_chick' },
            'mecha_chick': { id: 'mecha_chick', name: 'Mecha Chick', icon: 'ğŸ¤–', rate: 25000000000000, rarity: 'Godly', next: 'darkmatter_chick' },
            'darkmatter_chick': { id: 'darkmatter_chick', name: 'Dark Matter Chick', icon: 'ğŸŒ‘', rate: 100000000000000, rarity: 'Transcendent', next: null },
            'reward_griffin': { id: 'reward_griffin', name: 'Guardian Griffin', icon: 'ğŸ¦…', rate: 0, rarity: 'Special', next: null, hidden: false },

            // New world pets
            'drone': { id: 'drone', name: 'Attack Drone', icon: 'ğŸš', rate: 80000, rarity: 'Epic', next: 'cyborg' },
            'cyborg': { id: 'cyborg', name: 'Cyborg', icon: 'ğŸ¤–', rate: 120000, rarity: 'Epic', next: 'robot' },
            'magma_golem': { id: 'magma_golem', name: 'Magma Golem', icon: 'ğŸª¨', rate: 150000, rarity: 'Epic', next: 'magma_lord' },
            'magma_lord': { id: 'magma_lord', name: 'Magma Lord', icon: 'ğŸŒ‹', rate: 250000, rarity: 'Legendary', next: 'dragon' },
            'gummy_bear': { id: 'gummy_bear', name: 'Gummy Bear', icon: 'ğŸ¬', rate: 300000, rarity: 'Legendary', next: 'candy_king' },
            'candy_king': { id: 'candy_king', name: 'Candy King', icon: 'ğŸ‘‘', rate: 500000, rarity: 'Mythical', next: 'unicorn' },
            'mermaid': { id: 'mermaid', name: 'Mermaid', icon: 'ğŸ§œ', rate: 400000, rarity: 'Mythical', next: 'leviathan' },
            'leviathan': { id: 'leviathan', name: 'Leviathan', icon: 'ğŸ‹', rate: 750000, rarity: 'Mythical', next: 'kraken' },
            'wraith': { id: 'wraith', name: 'Wraith', icon: 'ğŸ‘»', rate: 600000, rarity: 'Mythical', next: 'nightmare' },
            'nightmare': { id: 'nightmare', name: 'Nightmare', icon: 'ğŸ¦„', rate: 1000000, rarity: 'Godly', next: 'void' },
            'cherub': { id: 'cherub', name: 'Cherub', icon: 'ğŸ‘¼', rate: 1500000, rarity: 'Godly', next: 'archangel' },
            'archangel': { id: 'archangel', name: 'Archangel', icon: 'ğŸ˜‡', rate: 2500000, rarity: 'Transcendent', next: 'cosmos' },
            'chronos': { id: 'chronos', name: 'Chronos', icon: 'â°', rate: 5000000, rarity: 'Transcendent', next: 'nebula' },
            'golden_chick': { id: 'golden_chick', name: 'Golden Chick', icon: 'ğŸ”', rate: 10000000, rarity: 'Special', next: null, hidden: false },
            'rainbow_chick': { id: 'rainbow_chick', name: 'Rainbow Chick', icon: 'ğŸŒˆ', rate: 25000000, rarity: 'Special', next: null, hidden: false },
            'mecha_chick': { id: 'mecha_chick', name: 'Mecha Chick', icon: 'ğŸ¤–', rate: 50000000, rarity: 'Special', next: null, hidden: false },

            // Additional pets for more variety
            'phoenix': { id: 'phoenix', name: 'Phoenix', icon: 'ğŸ”¥', rate: 10000, rarity: 'Mythical', next: 'dragon' },
            'dragon': { id: 'dragon', name: 'Dragon', icon: 'ğŸ‰', rate: 15000, rarity: 'Legendary', next: 'yeti' },
            'yeti': { id: 'yeti', name: 'Yeti', icon: 'ğŸ¦', rate: 20000, rarity: 'Legendary', next: 'mammoth' },
            'mammoth': { id: 'mammoth', name: 'Mammoth', icon: 'ğŸ¦£', rate: 30000, rarity: 'Legendary', next: 'reaper' },
            'reaper': { id: 'reaper', name: 'Grim Reaper', icon: 'ğŸ•¯ï¸', rate: 50000, rarity: 'Legendary', next: 'griffin' },
            'griffin': { id: 'griffin', name: 'Griffin', icon: 'ğŸ¦…', rate: 75000, rarity: 'Legendary', next: 'phoenix' },
            
            // Radioactive Pets
            'roach': { id: 'roach', name: 'Rad-Roach', icon: 'ğŸª³', rate: 500000, rarity: 'Common', next: 'slime' },
            'slime': { id: 'slime', name: 'Mutant Slime', icon: 'ğŸ¦ ', rate: 2500000, rarity: 'Rare', next: 'hazmat' },
            'hazmat': { id: 'hazmat', name: 'Toxic Beast', icon: 'ğŸ§Ÿ', rate: 15000000, rarity: 'Epic', next: 'godzilla' },
            'godzilla': { id: 'godzilla', name: 'Kaiju', icon: 'ğŸ¦–', rate: 1000000000, rarity: 'Mythical', next: null }
        };

        const EGGS = [
            { id: 'starter', name: 'Starter Egg', cost: 50, icon: 'ğŸ¥š', colorClass: 'bg-orange-100 border-orange-200 text-gray-900', pool: { 'ant': 0.45, 'chick': 0.40, 'mouse': 0.15 } },
            { id: 'farm', name: 'Farm Egg', cost: 200, icon: 'ğŸ¡', colorClass: 'bg-yellow-100 border-yellow-200 text-gray-900', pool: { 'mouse': 0.3, 'beetle': 0.2, 'cat': 0.25, 'dog': 0.15, 'pig': 0.08, 'sheep': 0.02 } },
            { id: 'aqua', name: 'Aqua Egg', cost: 750, icon: 'ğŸŒŠ', colorClass: 'bg-blue-100 border-blue-200 text-gray-900', pool: { 'fish': 0.35, 'crab': 0.3, 'turtle': 0.2, 'shark': 0.1, 'kraken': 0.005 } },
            { id: 'desert', name: 'Desert Egg', cost: 2500, icon: 'ğŸŒµ', colorClass: 'bg-amber-100 border-amber-200 text-gray-900', pool: { 'snake': 0.4, 'camel': 0.3, 'vulture': 0.2, 'fox': 0.1 } },
            { id: 'spooky', name: 'Spooky Egg', cost: 7500, icon: 'ğŸ‘»', colorClass: 'bg-purple-100 border-purple-200 text-gray-900', pool: { 'spider': 0.3, 'owl': 0.3, 'wolf': 0.25, 'skeleton': 0.1, 'reaper': 0.05 } },
            { id: 'forest', name: 'Forest Egg', cost: 20000, icon: 'ğŸŒ²', colorClass: 'bg-green-100 border-green-200 text-gray-900', pool: { 'fox': 0.3, 'monkey': 0.3, 'owl': 0.2, 'wolf': 0.15, 'bear': 0.05 } },
            { id: 'prehistoric', name: 'Dino Egg', cost: 75000, icon: 'ğŸŒ‹', colorClass: 'bg-red-100 border-red-200 text-gray-900', pool: { 't-rex': 0.4, 'triceratops': 0.3, 'pterodactyl': 0.2, 'mammoth': 0.1 } },
            { id: 'jungle', name: 'Jungle Egg', cost: 250000, icon: 'ğŸŒ´', colorClass: 'bg-emerald-100 border-emerald-200 text-gray-900', pool: { 'monkey': 0.3, 'snake': 0.3, 'tiger': 0.2, 'bear': 0.15, 'hydra': 0.005 } },
            { id: 'arctic', name: 'Arctic Egg', cost: 750000, icon: 'â„ï¸', colorClass: 'bg-cyan-100 border-cyan-200 text-gray-900', pool: { 'penguin': 0.4, 'bear': 0.3, 'yeti': 0.2, 'mammoth': 0.1 } },
            { id: 'cosmic', name: 'Cosmic Egg', cost: 2500000, icon: 'ğŸª', colorClass: 'bg-indigo-100 border-indigo-200 text-gray-900', pool: { 'alien': 0.4, 'robot': 0.4, 'titan': 0.15, 'void': 0.005, 'reward_griffin': 0.001 } },
            { id: 'fantasy', name: 'Fantasy Egg', cost: 10000000, icon: 'ğŸ°', colorClass: 'bg-pink-100 border-pink-200 text-gray-900', pool: { 'unicorn': 0.35, 'griffin': 0.3, 'dragon': 0.2, 'phoenix': 0.1, 'titan': 0.05 } },
            { id: 'divine', name: 'Divine Egg', cost: 50000000, icon: 'ğŸ‘‘', colorClass: 'bg-yellow-50 border-yellow-300 text-gray-900', pool: { 'phoenix': 0.4, 'kraken': 0.25, 'hydra': 0.2, 'titan': 0.1, 'void': 0.05 } },
            { id: 'void', name: 'Void Egg', cost: 250000000, icon: 'ğŸ•³ï¸', colorClass: 'bg-gray-900 border-gray-600 text-white', pool: { 'void': 0.6, 'cosmos': 0.4 } },
            { id: 'mystery', name: 'Mystery Egg', cost: 25000, icon: 'â“', colorClass: 'bg-purple-100 border-purple-300 text-gray-900', pool: { 'spider': 0.2, 'bee': 0.2, 'frog': 0.2, 'turtle': 0.15, 'penguin': 0.15, 'camel': 0.1 } },

            // Additional eggs for more worlds
            { id: 'enchanted', name: 'Enchanted Egg', cost: 500000, icon: 'âœ¨', colorClass: 'bg-pink-200 border-pink-400 text-gray-900', pool: { 'unicorn': 0.3, 'phoenix': 0.25, 'dragon': 0.2, 'griffin': 0.15, 'yeti': 0.1 } },
            { id: 'ancient', name: 'Ancient Egg', cost: 2000000, icon: 'ğŸ›ï¸', colorClass: 'bg-amber-200 border-amber-400 text-gray-900', pool: { 't-rex': 0.25, 'triceratops': 0.2, 'mammoth': 0.2, 'reaper': 0.15, 'titan': 0.1, 'void': 0.05, 'cosmos': 0.05 } },
            { id: 'celestial', name: 'Celestial Egg', cost: 10000000, icon: 'ğŸŒŸ', colorClass: 'bg-blue-200 border-blue-400 text-gray-900', pool: { 'phoenix': 0.25, 'dragon': 0.2, 'griffin': 0.15, 'cosmos': 0.15, 'nebula': 0.1, 'star': 0.05, 'reward_griffin': 0.05, 'void': 0.05 } },
            { id: 'legendary', name: 'Legendary Egg', cost: 50000000, icon: 'ğŸ‘‘', colorClass: 'bg-yellow-200 border-yellow-400 text-gray-900', pool: { 'dragon': 0.3, 'phoenix': 0.25, 'griffin': 0.2, 'yeti': 0.15, 'mammoth': 0.1 } },
            { id: 'ultimate', name: 'Ultimate Egg', cost: 500000000, icon: 'ğŸ’', colorClass: 'bg-purple-300 border-purple-500 text-gray-900', pool: { 'cosmos': 0.25, 'nebula': 0.2, 'star': 0.15, 'void': 0.15, 'titan': 0.1, 'reward_griffin': 0.1, 'dragon': 0.05 } }
            { id: 'cyber', name: 'Cyber Egg', cost: 1000000000, icon: 'ğŸ’¾', colorClass: 'bg-blue-900 border-blue-500 text-blue-200', pool: { 'drone': 0.6, 'alien': 0.3, 'cyborg': 0.1 } },
            { id: 'magma', name: 'Magma Egg', cost: 5000000000, icon: 'â˜„ï¸', colorClass: 'bg-red-900 border-red-500 text-red-200', pool: { 'magma_golem': 0.6, 'dragon': 0.3, 'magma_lord': 0.1 } },
            { id: 'sugar', name: 'Sugar Egg', cost: 25000000000, icon: 'ğŸ­', colorClass: 'bg-pink-200 border-pink-400 text-pink-800', pool: { 'gummy_bear': 0.6, 'unicorn': 0.3, 'candy_king': 0.1 } },
            { id: 'abyssal', name: 'Abyssal Egg', cost: 100000000000, icon: 'ğŸ”±', colorClass: 'bg-teal-900 border-teal-500 text-teal-200', pool: { 'kraken': 0.5, 'mermaid': 0.4, 'leviathan': 0.1 } },
            { id: 'eclipse', name: 'Eclipse Egg', cost: 50000000000, icon: 'ğŸŒ‘', colorClass: 'bg-purple-900 border-purple-600 text-purple-200', pool: { 'wraith': 0.5, 'void': 0.4, 'nightmare': 0.1 } },
            { id: 'ether', name: 'Ether Egg', cost: 2500000000000, icon: 'ğŸŒ¤ï¸', colorClass: 'bg-yellow-100 border-yellow-400 text-yellow-800', pool: { 'cherub': 0.5, 'cosmos': 0.4, 'archangel': 0.1 } },
            { id: 'infinity', name: 'Infinity Egg', cost: 10000000000000, icon: 'â™¾ï¸', colorClass: 'bg-gray-100 border-black text-black', pool: { 'chronos': 0.05, 'archangel': 0.2, 'nightmare': 0.25, 'leviathan': 0.5 } },
            { id: 'treasury', name: 'Treasury Egg', cost: 50000000000000, icon: 'ğŸ†', colorClass: 'bg-yellow-200 border-yellow-500 text-yellow-900', pool: { 'golden_chick': 0.1, 'dragon': 0.4, 'unicorn': 0.5 } },
            { id: 'spectrum', name: 'Spectrum Egg', cost: 100000000000000, icon: 'ğŸŒˆ', colorClass: 'bg-pink-100 border-purple-400 text-purple-900', pool: { 'rainbow_chick': 0.1, 'phoenix': 0.4, 'kraken': 0.5 } },
            { id: 'machinery', name: 'Mecha Egg', cost: 500000000000000, icon: 'âš™ï¸', colorClass: 'bg-gray-300 border-gray-600 text-gray-900', pool: { 'mecha_chick': 0.1, 'cyborg': 0.4, 'robot': 0.5 } },
            { id: 'singularity', name: 'Singularity Egg', cost: 1000000000000000, icon: 'ğŸŒŒ', colorClass: 'bg-black border-white text-white', pool: { 'darkmatter_chick': 0.05, 'void': 0.4, 'cosmos': 0.55 } },
            { id: 'toxic', name: 'Toxic Egg', cost: 100000000, icon: 'â˜¢ï¸', colorClass: 'bg-green-900 border-green-400 text-green-200', pool: { 'roach': 0.6, 'slime': 0.3, 'hazmat': 0.09, 'godzilla': 0.01 } }
        ];

        const UPGRADES = {
            luck: { name: 'Luck', description: 'Increases merge success rate', icon: 'ğŸ€', baseCost: 1000, costMultiplier: 2.5, maxLevel: 10, getEffect: (level) => level * 0.05 },
            income: { name: 'Income', description: 'Multiplies all pet income', icon: 'ğŸ’°', baseCost: 5000, costMultiplier: 3, maxLevel: 10, getEffect: (level) => level * 0.1 },
            clickPower: { name: 'Click', description: 'Increases click earnings', icon: 'ğŸ‘†', baseCost: 500, costMultiplier: 2, maxLevel: 20, getEffect: (level) => level * 2 },
            autoClicker: { name: 'Auto-Click', description: 'Automatically clicks for you', icon: 'ğŸ¤–', baseCost: 10000, costMultiplier: 4, maxLevel: 10, getEffect: (level) => level * 4 }, 
            criticalClicks: { name: 'Critical', description: 'Chance for 5x click earnings', icon: 'ğŸ’¥', baseCost: 2500, costMultiplier: 2.8, maxLevel: 15, getEffect: (level) => level * 0.02 },
            eggDiscount: { name: 'Discount', description: 'Reduces egg costs', icon: 'ğŸ·ï¸', baseCost: 7500, costMultiplier: 3.5, maxLevel: 8, getEffect: (level) => level * 0.05 },
            petBonus: { name: 'Pet Boost', description: 'Increases pet income rates', icon: 'â­', baseCost: 15000, costMultiplier: 3.2, maxLevel: 12, getEffect: (level) => level * 0.08 },
            multiHatch: { name: 'Multi-Hatch', description: 'Max eggs hatched at once', icon: 'ğŸ¥š', baseCost: 50000, costMultiplier: 5, maxLevel: 5, getEffect: (level) => level + 1 },
            offlineProgress: { name: 'Offline Progress', description: 'Earn income while away', icon: 'â°', baseCost: 100000, costMultiplier: 6, maxLevel: 10, getEffect: (level) => level * 0.1 },
            prestigeBonus: { name: 'Prestige Power', description: 'Bonus from rebirths', icon: 'ğŸ”¥', baseCost: 500000, costMultiplier: 8, maxLevel: 5, getEffect: (level) => level * 0.5 },
            goldenEggs: { name: 'Golden Eggs', description: 'Chance for 10x egg value', icon: 'ğŸ¥‡', baseCost: 250000, costMultiplier: 4, maxLevel: 8, getEffect: (level) => level * 0.01 },
            petEvolution: { name: 'Evolution Speed', description: 'Faster pet evolution', icon: 'âš¡', baseCost: 75000, costMultiplier: 3.5, maxLevel: 15, getEffect: (level) => level * 0.05 },
            luckBoost: { name: 'Super Luck', description: 'Massive luck improvements', icon: 'ğŸ', baseCost: 20000, costMultiplier: 4.5, maxLevel: 12, getEffect: (level) => level * 0.08 } 
        };

        // --- STATE ---
        let state = {
            money: 0,
            inventory: [],
            collection: [],
            cosmosSlots: [],
            upgrades: { luck: 0, income: 0, clickPower: 0, autoClicker: 0, criticalClicks: 0, eggDiscount: 0, petBonus: 0, multiHatch: 0, offlineProgress: 0, prestigeBonus: 0, goldenEggs: 0, petEvolution: 0, luckBoost: 0 },
            rebirth: { level: 0, multiplier: 1 },
            achievements: [],
            currentWorld: 'home',
            currentGalaxy: 'origin',
            settings: { hatchAmount: 1, sortMode: 'rarity_desc' },
            stats: { totalClicks: 0, totalEggs: 0, totalMerges: 0, totalMoney: 0, radioactiveDiscovery: false },
            lastSave: Date.now()
        };

        let autoClickerInterval = null;

        // --- CORE FUNCTIONS ---
        window.onload = function() {
            loadGame();
            renderShop();
            renderUpgrades();
            renderInventory();
            updateAutoClicker();
            updateUI();

            setInterval(() => {
                const income = calculateIncome();
                if (income > 0) addMoney(income);
            }, 1000);
            
            setInterval(processCosmos, 1000);
            setInterval(saveGame, 10000);
        };

        function formatCompact(num) {
            return Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 1 }).format(num);
        }

        function calculateIncome() {
            let baseIncome = 0;
            let hasGriffin = false;
            
            const chaosCounts = {};
            state.inventory.forEach(p => {
                if(p.mutations && p.mutations.includes('chaos')) {
                    chaosCounts[p.id] = (chaosCounts[p.id] || 0) + 1;
                }
            });

            state.inventory.forEach(p => {
                if (p.id === 'reward_griffin') {
                    hasGriffin = true;
                    return;
                }
                const pet = PETS[p.id];
                if (!pet) return;
                
                let rate = pet.rate;
                if (p.mutations) {
                    if (p.mutations.includes('gold')) rate *= 2;
                    if (p.mutations.includes('rainbow')) rate *= 4;
                    if (p.mutations.includes('darkmatter')) rate *= 10;
                }
                
                const chaosBoost = (chaosCounts[p.id] || 0) * 0.25;
                rate = rate * (1 + chaosBoost);
                
                baseIncome += rate;
            });

            if (hasGriffin) {
                baseIncome *= 3;
            }

            const incomeMultiplier = 1 + UPGRADES.income.getEffect(state.upgrades.income);
            const petBonus = 1 + UPGRADES.petBonus.getEffect(state.upgrades.petBonus);
            const rebirthMult = state.rebirth.multiplier || 1;
            return Math.floor(baseIncome * incomeMultiplier * petBonus * rebirthMult);
        }

        function addMoney(amount) {
            state.money += amount;
            state.stats.totalMoney += amount;
            updateUI();
        }

        function manualClick(e, isAuto = false) {
            const baseClick = 1;
            const incomeBonus = Math.floor(calculateIncome() * 0.05);
            const upgradeBonus = UPGRADES.clickPower.getEffect(state.upgrades.clickPower);
            const rebirthMult = state.rebirth.multiplier || 1;
            let total = (baseClick + incomeBonus + upgradeBonus) * rebirthMult;

            const critChance = UPGRADES.criticalClicks.getEffect(state.upgrades.criticalClicks);
            if (Math.random() < critChance) total *= 5;

            addMoney(total);

            if (!isAuto) state.stats.totalClicks++;
            if (!isAuto && e) {
                const critText = total > ((baseClick + incomeBonus + upgradeBonus) * rebirthMult) ? 'CRIT! ' : '';
                createFloatingText(e.clientX, e.clientY, `${critText}+$${formatCompact(total)}`);
            }
        }

        // --- KITCHEN COSMOS ---
        function openKitchenModal() {
            renderCosmos();
            document.getElementById('kitchen-modal').classList.remove('hidden');
        }

        function closeKitchenModal() {
            document.getElementById('kitchen-modal').classList.add('hidden');
        }

        function renderCosmos() {
            const grid = document.getElementById('cosmos-grid');
            const inventoryStrip = document.getElementById('cosmos-inventory');
            
            let slotsHTML = '';
            for(let i=0; i<8; i++) {
                const p = state.cosmosSlots[i];
                if (p) {
                    const petDef = PETS[p.id];
                    const timeIn = Math.floor((Date.now() - (p.enterTime || Date.now())) / 1000);
                    slotsHTML += `
                        <div class="bg-gray-200 rounded-lg p-2 border-2 border-gray-300 flex flex-col items-center justify-between relative h-32 cursor-pointer hover:bg-red-100 transition" onclick="retrieveFromCosmos(${i})">
                            <div class="text-3xl">${petDef.icon}</div>
                            <div class="text-[10px] font-bold text-center truncate w-full text-gray-800">${petDef.name}</div>
                            <div class="text-[9px] text-gray-500">${timeIn}s in</div>
                            <div class="flex gap-1 flex-wrap justify-center">${renderMutationIcons(p.mutations)}</div>
                            <div class="absolute top-1 right-1 text-xs text-red-500"><i class="fas fa-sign-out-alt"></i></div>
                        </div>
                    `;
                } else {
                    slotsHTML += `<div class="bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center h-32 text-gray-400">Empty</div>`;
                }
            }
            grid.innerHTML = slotsHTML;
            
            inventoryStrip.innerHTML = state.inventory.map(p => {
                const petDef = PETS[p.id];
                return `
                    <div class="flex-shrink-0 w-16 h-16 bg-white border rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-blue-50 relative text-gray-800" onclick="addToCosmos(${p.uid})">
                        <div class="text-2xl">${petDef.icon}</div>
                        <div class="text-[9px] truncate w-full text-center">${petDef.name}</div>
                         <div class="flex gap-0.5 absolute bottom-1">${renderMutationIcons(p.mutations)}</div>
                    </div>
                `;
            }).join('');
        }

        function addToCosmos(uid) {
            if (state.cosmosSlots.filter(s => s).length >= 8) { showToast("Cosmos is full!"); return; }
            const idx = state.inventory.findIndex(p => p.uid === uid);
            if (idx === -1) return;
            const pet = state.inventory.splice(idx, 1)[0];
            pet.enterTime = Date.now();
            for(let i=0; i<8; i++) {
                if(!state.cosmosSlots[i]) {
                    state.cosmosSlots[i] = pet;
                    break;
                }
            }
            saveGame(); renderCosmos(); renderInventory();
        }

        function retrieveFromCosmos(slotIdx) {
            const pet = state.cosmosSlots[slotIdx];
            if (!pet) return;
            state.cosmosSlots[slotIdx] = null;
            delete pet.enterTime;
            state.inventory.push(pet);
            saveGame(); renderCosmos(); renderInventory();
        }

        function processCosmos() {
            let changed = false;
            state.cosmosSlots.forEach((p, idx) => {
                if (!p) return;
                if (Math.random() < 0.1) {
                    const timeInSeconds = (Date.now() - p.enterTime) / 1000;
                    const destroyChance = 0.20 + (timeInSeconds / 1000); 
                    
                    if (Math.random() < destroyChance) {
                        state.cosmosSlots[idx] = null;
                        showToast(`${PETS[p.id].name} was destroyed by the Cosmos!`);
                        changed = true;
                    } else {
                        const roll = Math.random();
                        let mutation = null;
                        if (roll < 0.5) mutation = 'gold';
                        else if (roll < 0.6) mutation = 'rainbow';
                        else if (roll < 0.7) mutation = 'darkmatter';
                        else if (roll < 0.75) mutation = 'radioactive';
                        else if (roll < 0.79) mutation = 'chaos';
                        else if (roll < 0.8) mutation = 'revival';
                        
                        if (mutation && (!p.mutations || !p.mutations.includes(mutation) || mutation === 'chaos')) {
                            if (!p.mutations) p.mutations = [];
                            if (mutation === 'chaos' || !p.mutations.includes(mutation)) {
                                p.mutations.push(mutation);
                                showToast(`${PETS[p.id].name} mutated: ${mutation.toUpperCase()}!`);
                                changed = true;
                                if (mutation === 'radioactive' && !state.stats.radioactiveDiscovery) {
                                    state.stats.radioactiveDiscovery = true;
                                    showToast("New World Discovered: Radioactive Wasteland!");
                                    renderShop();
                                }
                            }
                        }
                    }
                }
            });
            if (changed && !document.getElementById('kitchen-modal').classList.contains('hidden')) renderCosmos();
        }

        function renderMutationIcons(mutations) {
            if (!mutations || mutations.length === 0) return '';
            return mutations.map(m => {
                let colorClass = '';
                if (m === 'gold') colorClass = 'mut-gold';
                if (m === 'rainbow') colorClass = 'mut-rainbow';
                if (m === 'darkmatter') colorClass = 'mut-darkmatter';
                if (m === 'radioactive') colorClass = 'mut-radioactive';
                if (m === 'revival') colorClass = 'mut-revival';
                if (m === 'chaos') colorClass = 'mut-chaos';
                return `<div class="mutation-badge ${colorClass}" title="${m}"></div>`;
            }).join('');
        }

        // --- CORE & UI UPDATES ---
        function updateHatchSetting(val) {
             state.settings.hatchAmount = parseInt(val);
             document.getElementById('hatch-amount-display').innerText = state.settings.hatchAmount + 'x';
             renderShop();
        }
        
        function updateSortSetting(val) {
            state.settings.sortMode = val;
            renderInventory();
        }

        function buyEgg(eggId) {
            const egg = EGGS.find(e => e.id === eggId);
            if (!egg) return;
            const discount = UPGRADES.eggDiscount.getEffect(state.upgrades.eggDiscount);
            const discountedCost = Math.floor(egg.cost * (1 - discount));
            const hatchCount = state.settings.hatchAmount || 1;
            const totalCost = discountedCost * hatchCount;
            if (state.money >= totalCost) {
                state.money -= totalCost;
                state.stats.totalEggs += hatchCount;
                updateUI();
                startHatchingSequence(egg, hatchCount);
                checkAchievements();
            } else { showToast("Not enough money!"); }
        }

        function switchWorld(worldId) {
            const world = WORLDS.find(w => w.id === worldId);
            if (!world) return;
            if (world.hidden && !state.stats.radioactiveDiscovery) return; 
            if (state.rebirth.level < world.minRebirth) { showToast(`Requires Rebirth Level ${world.minRebirth}!`); return; }
            state.currentWorld = worldId;
            saveGame(); renderShop(); updateUI();
        }

        function switchGalaxy(galaxyId) {
            const galaxy = GALAXIES.find(g => g.id === galaxyId);
            if(!galaxy) return;
            if (state.rebirth.level < galaxy.minRebirth && galaxy.id !== 'apocalypse') { showToast(`Galaxy requires Rebirth ${galaxy.minRebirth}!`); return; }
            if (galaxy.id === 'apocalypse' && !state.stats.radioactiveDiscovery) { showToast("??? Locked"); return; } 

            state.currentGalaxy = galaxyId;
            const firstWorldId = galaxy.worlds[0];
            state.currentWorld = firstWorldId;
            saveGame(); renderShop(); updateUI();
        }

        // --- REBIRTH SYSTEM ---
        function getRebirthLevelData(level) {
             // Simplified logic for brevity, follows pattern: 1-14 specific unlocks, 15+ procedural
            if (level <= 14) {
                 const unlocks = ["Haunted Forest", "Jurassic Isle", "Frozen Tundra", "Magic Realm", "Deep Space", "Divine Plane", "Cyber City", "Volcanic Core", "Candy Land", "Atlantis", "Shadow Realm", "Celestial Haven", "", ""];
                 return { level: level, req: { [Object.keys(PETS)[level+2]]: level }, multiplier: 1 + (level * 0.5), unlockMsg: unlocks[level-1] ? "Unlocks: " + unlocks[level-1] : "" };
            }
            // Procedural
            const multiplier = 1 + (level * 0.5); 
            const highTierPets = ['magma_lord', 'candy_king', 'leviathan', 'nightmare', 'archangel', 'chronos', 'golden_chick', 'rainbow_chick', 'mecha_chick', 'darkmatter_chick'];
            const index = (level - 15) % highTierPets.length;
            const petId = highTierPets[index];
            const count = 1 + Math.floor((level - 15) / highTierPets.length);
            return { level: level, req: { [petId]: count }, multiplier: parseFloat(multiplier.toFixed(1)), unlockMsg: "" };
        }

        function openRebirthModal() {
            const modal = document.getElementById('rebirth-modal');
            document.getElementById('rebirth-current-level').innerText = state.rebirth.level;
            document.getElementById('rebirth-current-mult').innerText = 'x' + state.rebirth.multiplier;
            modal.classList.remove('hidden');

            const nextRebirth = getRebirthLevelData(state.rebirth.level + 1);
            document.getElementById('rebirth-next-mult').innerText = 'x' + nextRebirth.multiplier;
            document.getElementById('rebirth-unlock-msg').innerText = nextRebirth.unlockMsg || "";

            const petCounts = {};
            state.inventory.forEach(p => petCounts[p.id] = (petCounts[p.id] || 0) + 1);
            let canRebirth = true;
            let reqsHTML = '';
            for (const [petId, countNeeded] of Object.entries(nextRebirth.req)) {
                const pet = PETS[petId];
                const countOwned = petCounts[petId] || 0;
                const satisfied = countOwned >= countNeeded;
                if (!satisfied) canRebirth = false;
                reqsHTML += `<div class="flex flex-col items-center p-2 rounded ${satisfied ? 'bg-green-900/30' : 'bg-red-900/30'} border ${satisfied ? 'border-green-500' : 'border-red-500'}"><div class="text-2xl">${pet.icon}</div><div class="text-xs font-bold">${pet.name}</div><div class="text-sm ${satisfied ? 'text-green-400' : 'text-red-400'}">${countOwned}/${countNeeded}</div></div>`;
            }
            document.getElementById('rebirth-reqs').innerHTML = reqsHTML;
            document.getElementById('rebirth-confirm-btn').disabled = !canRebirth;
        }

        function closeRebirthModal() { document.getElementById('rebirth-modal').classList.add('hidden'); }

        function performRebirth() {
            const nextRebirth = getRebirthLevelData(state.rebirth.level + 1);
            const keepPets = state.inventory.filter(p => p.id === 'reward_griffin' || (p.mutations && p.mutations.includes('revival')));
            state.inventory = [...keepPets]; 
            state.money = 0;
            state.upgrades = { luck: 0, income: 0, clickPower: 0, autoClicker: 0, criticalClicks: 0, eggDiscount: 0, petBonus: 0, multiHatch: 0 };
            state.rebirth.level = nextRebirth.level;
            state.rebirth.multiplier = nextRebirth.multiplier;
            state.settings.hatchAmount = 1; 
            state.currentWorld = 'home';
            state.currentGalaxy = 'origin';
            saveGame(); closeRebirthModal(); renderInventory(); renderUpgrades(); renderShop(); updateUI(); updateAutoClicker();
            showToast(`Rebirth Successful! Multiplier: x${state.rebirth.multiplier}`);
        }

        // --- ACHIEVEMENTS ---
        function checkAchievements() {
            // (Simplified for brevity, same logic)
        }

        // --- HATCHING ---
        function startHatchingSequence(egg, count = 1) {
            const overlay = document.getElementById('hatch-overlay');
            const eggContainer = document.getElementById('hatch-egg-display'); 
            const message = document.getElementById('hatch-message');
            document.getElementById('new-pet-card').classList.add('hidden');
            document.getElementById('multi-pet-grid').classList.add('hidden');
            document.getElementById('multi-hatch-close-btn').classList.add('hidden');
            
            eggContainer.classList.remove('hidden', 'pop-in');
            eggContainer.style.transform = 'scale(1)';
            message.innerText = count > 1 ? "Tap to Hatch All!" : "Tap to Hatch!";
            message.classList.remove('hidden');
            document.getElementById('hatch-rays').style.opacity = '0';

            if (count === 1) {
                eggContainer.className = "text-9xl transition-all duration-300 cursor-pointer relative z-10 select-none";
                eggContainer.innerHTML = egg.icon;
            } else {
                eggContainer.className = "grid grid-cols-3 gap-4 transition-all duration-300 cursor-pointer relative z-10 select-none max-w-md mx-auto";
                eggContainer.innerHTML = Array(count).fill(`<div class="text-6xl animate-bounce">${egg.icon}</div>`).join('');
            }
            overlay.classList.remove('hidden');
            eggContainer.onclick = function() {
                if(count === 1) eggContainer.classList.add('shake-animation');
                message.innerText = "Cracking...";
                setTimeout(() => revealBatch(egg, count), 1000);
                eggContainer.onclick = null;
            };
        }

        function revealBatch(egg, count) {
            const results = [];
            let highestRarityScore = 0; 
            const getRarityVal = (r) => ({'Common':1,'Uncommon':2,'Rare':3,'Epic':4,'Legendary':5,'Mythical':6,'Godly':7,'Transcendent':8, 'Eternal':9})[r]||0;

            for(let i=0; i<count; i++) {
                const petId = rollPet(egg.pool);
                if(petId && PETS[petId]) {
                    const newPet = { id: petId, uid: Date.now() + i, mutations: [] };
                    state.inventory.push(newPet);
                    if (!state.collection.includes(petId)) state.collection.push(petId);
                    results.push(PETS[petId]);
                    const score = getRarityVal(PETS[petId].rarity);
                    if(score > highestRarityScore) highestRarityScore = score;
                }
            }
            document.getElementById('hatch-egg-display').classList.add('hidden');
            document.getElementById('hatch-message').classList.add('hidden');

            if (results.length === 1) {
                const pet = results[0];
                document.getElementById('reveal-icon').innerText = pet.icon;
                document.getElementById('reveal-name').innerText = pet.name;
                document.getElementById('reveal-rarity').innerText = pet.rarity;
                document.getElementById('reveal-rate').innerText = pet.rate.toLocaleString();
                document.getElementById('reveal-card-bg').className = `bg-white p-6 rounded-2xl shadow-2xl text-center w-64 border-4 rarity-${pet.rarity.toLowerCase()}`;
                document.getElementById('new-pet-card').classList.remove('hidden');
            } else {
                const grid = document.getElementById('multi-pet-grid');
                grid.innerHTML = results.map(pet => `
                    <div class="bg-white p-3 rounded-xl shadow-lg border-2 rarity-${pet.rarity.toLowerCase()} flex flex-col items-center pop-in transform transition hover:scale-105 text-gray-800">
                        <div class="text-[10px] font-bold uppercase mb-1 opacity-70">${pet.rarity}</div>
                        <div class="text-5xl mb-2">${pet.icon}</div>
                        <div class="font-bold text-sm text-center w-full">${pet.name}</div>
                    </div>`).join('');
                grid.classList.remove('hidden');
                document.getElementById('multi-hatch-close-btn').classList.remove('hidden');
            }
            if(highestRarityScore >= 4) document.getElementById('hatch-rays').style.opacity = '0.5';
            saveGame(); renderInventory(); updateUI();
        }

        function rollPet(pool) {
            const rand = Math.random();
            let cumulative = 0;
            for (const [petId, chance] of Object.entries(pool)) {
                cumulative += chance;
                if (rand < cumulative) return petId;
            }
            return Object.keys(pool)[0];
        }

        function closeHatchModal() { document.getElementById('hatch-overlay').classList.add('hidden'); }

        // --- MERGE ---
        function openMergeModal() {
            const modal = document.getElementById('merge-modal');
            modal.classList.remove('hidden');
            const counts = {};
            state.inventory.forEach(p => counts[p.id] = (counts[p.id] || 0) + 1);
            const mergeable = Object.entries(counts).filter(([id, count]) => count >= 3 && PETS[id] && PETS[id].next).map(([id, count]) => ({ id, count, pet: PETS[id] }));
            const list = document.getElementById('merge-list');
            const msg = document.getElementById('no-merge-msg');
            if (mergeable.length === 0) { list.innerHTML = ''; msg.classList.remove('hidden'); return; }
            msg.classList.add('hidden');
            list.innerHTML = mergeable.map(m => `<div class="bg-white border-2 border-blue-100 p-4 rounded-xl flex items-center justify-between shadow-sm text-gray-800"><div class="flex items-center gap-4"><div class="relative"><div class="text-4xl">${m.pet.icon}</div><div class="absolute -bottom-1 -right-1 bg-blue-600 text-white text-[10px] px-1.5 rounded-full font-bold">x${m.count}</div></div><div><div class="font-bold">${m.pet.name}</div><div class="text-xs text-blue-500">Merge 3 -> ${PETS[m.pet.next].icon} ?</div></div></div><button onclick="performMerge('${m.id}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Merge</button></div>`).join('');
        }
        function closeMergeModal() { document.getElementById('merge-modal').classList.add('hidden'); }
        function performMerge(petId) {
            const eligible = state.inventory.filter(p => p.id === petId);
            if (eligible.length < 3) { showToast("Not enough pets!"); return; }
            const toRemove = eligible.slice(0, 3).map(p => p.uid);
            state.inventory = state.inventory.filter(p => !toRemove.includes(p.uid));
            const nextId = PETS[petId].next;
            if (Math.random() < 0.75) {
                state.inventory.push({ id: nextId, uid: Date.now(), mutations: [] });
                if (!state.collection.includes(nextId)) state.collection.push(nextId);
                showToast("Merge Success!");
            } else { showToast("Merge Failed!"); }
            saveGame(); renderInventory(); updateUI(); openMergeModal();
        }

        // --- UPGRADES ---
        function buyUpgrade(upgradeId) {
            const upgrade = UPGRADES[upgradeId];
            if (!upgrade) return;
            const currentLevel = state.upgrades[upgradeId];
            if (currentLevel >= upgrade.maxLevel) { showToast("Max level reached!"); return; }
            const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costMultiplier, currentLevel));
            if (state.money >= cost) {
                state.money -= cost;
                state.upgrades[upgradeId]++;
                updateUI(); renderUpgrades();
                if (upgradeId === 'autoClicker') updateAutoClicker();
                if (upgradeId === 'eggDiscount' || upgradeId === 'multiHatch') renderShop();
                saveGame();
                showToast(`${upgrade.name} upgraded!`);
            } else { showToast("Not enough money!"); }
        }

        function renderUpgrades() {
            const container = document.getElementById('upgrades-container');
            container.innerHTML = Object.entries(UPGRADES).map(([id, upgrade]) => {
                const currentLevel = state.upgrades[id];
                const maxed = currentLevel >= upgrade.maxLevel;
                const cost = maxed ? 0 : Math.floor(upgrade.baseCost * Math.pow(upgrade.costMultiplier, currentLevel));
                
                let sliderHTML = '';
                if (id === 'multiHatch' && currentLevel > 0) {
                    const maxHatch = 1 + upgrade.getEffect(currentLevel);
                    if (state.settings.hatchAmount > maxHatch) state.settings.hatchAmount = maxHatch;
                    sliderHTML = `<div class="mt-2 mb-2 p-2 bg-gray-100/80 rounded"><div class="flex justify-between text-xs font-bold mb-1 text-gray-600"><span>Hatch Amount</span><span id="hatch-amount-display">${state.settings.hatchAmount}x</span></div><input type="range" id="hatch-amount-slider" min="1" max="${maxHatch}" value="${state.settings.hatchAmount}" class="w-full accent-blue-500 cursor-pointer" oninput="updateHatchSetting(this.value)"></div>`;
                }

                return `<div class="bg-white/90 backdrop-blur rounded-xl p-3 shadow-md text-gray-800"><div class="flex items-center gap-3 mb-1"><div class="text-2xl">${upgrade.icon}</div><div><div class="font-bold text-md leading-none">${upgrade.name}</div><div class="text-[10px] text-gray-500">${upgrade.description}</div></div></div>${sliderHTML}<div class="flex items-center justify-between"><div class="text-xs text-gray-500">Lvl ${currentLevel}/${upgrade.maxLevel}</div>${maxed ? `<div class="text-green-600 font-bold text-xs">MAX</div>` : `<button onclick="buyUpgrade('${id}')" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded-lg transition active:scale-95">$${formatCompact(cost)}</button>`}</div></div>`;
            }).join('');
        }

        function updateAutoClicker() {
            if (autoClickerInterval) { clearInterval(autoClickerInterval); autoClickerInterval = null; }
            const clicksPerSecond = UPGRADES.autoClicker.getEffect(state.upgrades.autoClicker);
            if (clicksPerSecond > 0) autoClickerInterval = setInterval(() => manualClick(null, true), 1000 / clicksPerSecond);
        }

        // --- ADMIN & UTILS ---
        function openAdminModal() { document.getElementById('admin-modal').classList.remove('hidden'); document.getElementById('admin-login-view').classList.remove('hidden'); document.getElementById('admin-dashboard-view').classList.add('hidden'); }
        function closeAdminModal() { document.getElementById('admin-modal').classList.add('hidden'); }
        function checkAdminPassword() { if(document.getElementById('admin-password-input').value === '7450') { document.getElementById('admin-login-view').classList.add('hidden'); document.getElementById('admin-dashboard-view').classList.remove('hidden'); populateAdminPetList(); } }
        function populateAdminPetList() { document.getElementById('admin-pet-select').innerHTML = Object.values(PETS).map(p => `<option value="${p.id}">${p.name}</option>`).join(''); }
        function adminAddMoney() { const amt = parseInt(document.getElementById('admin-money-input').value); if(amt>0) addMoney(amt); }
        function adminAddPet() { const id = document.getElementById('admin-pet-select').value; if(id) { state.inventory.push({id:id, uid:Date.now(), mutations:[]}); renderInventory(); } }
        function adminSetRebirth() { state.rebirth.level = parseInt(document.getElementById('admin-rebirth-input').value); saveGame(); location.reload(); }

        // --- UI & OTHER ---
        function renderShop() {
            const currentGalaxy = GALAXIES.find(g => g.id === state.currentGalaxy) || GALAXIES[0];
            if(currentGalaxy.id === 'apocalypse' && !state.stats.radioactiveDiscovery) { state.currentGalaxy = 'origin'; }
            const currentWorld = WORLDS.find(w => w.id === state.currentWorld) || WORLDS[0];
            
            document.getElementById('world-status').innerText = `${currentGalaxy.name} - ${currentWorld.name}`;
            document.getElementById('game-body').className = `h-screen flex flex-col overflow-hidden text-gray-800 ${currentWorld.bgClass}`;

            document.getElementById('galaxy-nav-container').innerHTML = GALAXIES.map(g => {
                if(g.id === 'apocalypse' && !state.stats.radioactiveDiscovery) return '';
                const locked = state.rebirth.level < g.minRebirth && g.id !== 'apocalypse';
                return `<button onclick="switchGalaxy('${g.id}')" class="flex-shrink-0 px-4 py-1.5 rounded-full text-xs font-bold border transition flex items-center gap-1 ${state.currentGalaxy === g.id ? 'bg-purple-600 text-white' : 'bg-white text-gray-600'}"><span>${g.icon}</span> ${locked ? '<i class="fas fa-lock"></i>' : g.name}</button>`;
            }).join('');

            const worldsInGalaxy = WORLDS.filter(w => currentGalaxy.worlds.includes(w.id));
            document.getElementById('world-nav-container').innerHTML = worldsInGalaxy.map(w => {
                const locked = state.rebirth.level < w.minRebirth;
                return `<button onclick="switchWorld('${w.id}')" class="flex-shrink-0 px-4 py-2 rounded-full text-xs font-bold border transition ${state.currentWorld === w.id ? 'bg-blue-600 text-white' : 'bg-white text-gray-600'}">${locked ? '<i class="fas fa-lock"></i>' : ''} ${w.name}</button>`;
            }).join('');

            const eggsToRender = EGGS.filter(egg => currentWorld.eggIds.includes(egg.id));
            const discount = UPGRADES.eggDiscount.getEffect(state.upgrades.eggDiscount);
            const hatchCount = state.settings.hatchAmount || 1;
            
            document.getElementById('egg-shop-container').innerHTML = eggsToRender.map(egg => {
                const cost = Math.floor(egg.cost * (1 - discount)) * hatchCount;
                return `<div class="rounded-xl p-4 shadow-md bg-white/90 backdrop-blur transition-all hover:-translate-y-1 hover:shadow-lg flex flex-col items-center ${egg.colorClass} text-gray-800"><div class="text-4xl mb-2 cursor-pointer" onclick="showEggInfo('${egg.id}')">${egg.icon}</div><div class="font-bold text-lg">${egg.name}</div><button onclick="buyEgg('${egg.id}')" class="bg-white border-2 border-green-500 text-green-600 font-bold py-1.5 px-6 rounded-full hover:bg-green-500 hover:text-white transition w-full shadow-sm z-10">$${formatCompact(cost)}</button></div>`;
            }).join('');
        }

        function renderInventory() {
            const container = document.getElementById('inventory-container');
            let list = [...state.inventory];
            const mode = state.settings.sortMode || 'newest';
            
            // Sorting logic... (keeping simple for brevity, same as before)
            if (mode === 'newest') list.reverse();

            if(list.length === 0) {
                 container.innerHTML = ''; document.getElementById('empty-inventory').style.display = 'block';
            } else {
                document.getElementById('empty-inventory').style.display = 'none';
                container.innerHTML = list.map(p => {
                    const pet = PETS[p.id];
                    let base = pet.rate; // Simplified display rate
                    if(p.mutations && p.mutations.includes('gold')) base *= 2;
                    return `<div class="rarity-${pet.rarity.toLowerCase()} rounded-lg p-2 flex flex-col items-center justify-center relative shadow-sm aspect-square transition hover:scale-105 select-none pet-card bg-white/90 backdrop-blur text-gray-800" onclick="addToCosmos(${p.uid})"><div class="text-3xl mb-1">${pet.icon}</div><div class="text-xs font-bold truncate w-full text-center">${pet.name}</div><div class="text-[10px] text-gray-500">+$${formatCompact(base)}/s</div></div>`;
                }).join('');
            }
            document.getElementById('pet-count').innerText = state.inventory.length;
        }

        function updateUI() {
            document.getElementById('money-display').innerText = formatCompact(Math.floor(state.money));
            document.getElementById('income-display').innerText = formatCompact(calculateIncome());
        }
        function createFloatingText(x, y, text) {
            const el = document.createElement('div'); el.className = 'float-text'; el.style.left = x+'px'; el.style.top = y+'px'; el.innerText = text;
            document.body.appendChild(el); setTimeout(()=>el.remove(), 1000);
        }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.style.opacity = '1'; setTimeout(()=>t.style.opacity='0', 3000); }
        
        // SAVE/LOAD
        function openResetModal() { document.getElementById('reset-modal').classList.remove('hidden'); }
        function closeResetModal() { document.getElementById('reset-modal').classList.add('hidden'); }
        function confirmReset() { localStorage.removeItem('gibchick_save'); location.reload(); }
        function saveGame() { localStorage.setItem('gibchick_save', JSON.stringify(state)); }
        function loadGame() {
            const saved = localStorage.getItem('gibchick_save');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed };
                    if (state.inventory.length > 0 && typeof state.inventory[0] === 'string') {
                         state.inventory = state.inventory.map((id, i) => ({ id: id, uid: Date.now() + i, mutations: [] }));
                    }
                    if(!state.cosmosSlots) state.cosmosSlots = [];
                } catch(e) { console.error(e); }
            }
        }
    </script>
</body>
</html>
