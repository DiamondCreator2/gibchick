<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gibchick.com - Idle Egg Clicker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Fredoka', sans-serif;
            background: linear-gradient(135deg, #e0f7fa 0%, #80deea 100%);
            overscroll-behavior: none;
            user-select: none;
        }

        .shake-animation {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0) rotate(-5deg); }
            20%, 80% { transform: translate3d(2px, 0, 0) rotate(5deg); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0) rotate(-5deg); }
            40%, 60% { transform: translate3d(4px, 0, 0) rotate(5deg); }
        }

        .pop-in {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            0% { opacity: 0; transform: scale(0.5); }
            100% { opacity: 1; transform: scale(1); }
        }

        .float-text {
            position: absolute;
            animation: floatUp 1s forwards;
            pointer-events: none;
            font-weight: bold;
            color: #10b981;
            text-shadow: 1px 1px 0 #fff;
            z-index: 50;
        }

        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-50px); }
        }

        /* Rarity Gradients for Cards */
        .rarity-common { background: linear-gradient(to bottom right, #f3f4f6, #d1d5db); border: 2px solid #9ca3af; }
        .rarity-uncommon { background: linear-gradient(to bottom right, #d1fae5, #6ee7b7); border: 2px solid #10b981; }
        .rarity-rare { background: linear-gradient(to bottom right, #dbeafe, #60a5fa); border: 2px solid #2563eb; }
        .rarity-epic { background: linear-gradient(to bottom right, #f3e8ff, #c084fc); border: 2px solid #9333ea; }
        .rarity-legendary { background: linear-gradient(to bottom right, #fef3c7, #fcd34d); border: 2px solid #d97706; box-shadow: 0 0 10px #fbbf24; }
        .rarity-mythical { background: linear-gradient(to bottom right, #fee2e2, #f87171); border: 2px solid #dc2626; box-shadow: 0 0 15px #ef4444; animation: pulse-mythical 2s infinite; }
        
        .rarity-godly { 
            background: linear-gradient(to bottom right, #2d2d2d, #000000); 
            border: 2px solid #a8a8a8; 
            box-shadow: 0 0 20px #ffffff; 
            color: white;
            animation: pulse-godly 3s infinite; 
        }
        .rarity-godly .text-gray-700 { color: #fff !important; }
        .rarity-godly .text-gray-500 { color: #ccc !important; }
        .rarity-godly .bg-white\/50 { background: rgba(255,255,255,0.2); }

        @keyframes pulse-godly {
            0% { box-shadow: 0 0 10px #ffffff; }
            50% { box-shadow: 0 0 30px #888, 0 0 50px #fff; }
            100% { box-shadow: 0 0 10px #ffffff; }
        }

        @keyframes pulse-mythical {
            0% { box-shadow: 0 0 10px #ef4444; }
            50% { box-shadow: 0 0 20px #f87171, 0 0 40px #fca5a5; }
            100% { box-shadow: 0 0 10px #ef4444; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- Header / Stats -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center z-10 shrink-0">
        <div class="flex items-center gap-3">
            <div class="text-3xl">üê£</div>
            <div>
                <h1 class="font-bold text-xl leading-none text-purple-600">Gibchick</h1>
                <span class="text-xs text-gray-500">Collect 'em all!</span>
            </div>
        </div>
        
        <div class="flex gap-6 text-right">
            <div>
                <div class="text-xs text-gray-500 font-bold uppercase">Cash</div>
                <div class="text-2xl font-bold text-green-600 flex items-center gap-1 justify-end">
                    $<span id="money-display">0</span>
                </div>
            </div>
            <div>
                <div class="text-xs text-gray-500 font-bold uppercase">Income</div>
                <div class="text-xl font-bold text-blue-500 flex items-center gap-1 justify-end">
                    $<span id="income-display">0</span><span class="text-sm text-gray-400">/s</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Game Area -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
        
        <!-- Left Panel: Clicker & Eggs -->
        <section class="flex-1 p-4 overflow-y-auto flex flex-col gap-6 relative" id="click-area">
            
            <!-- Manual Click Button -->
            <div class="bg-white rounded-2xl shadow-lg p-6 text-center transform hover:scale-[1.02] transition-transform cursor-pointer active:scale-95 select-none" onclick="manualClick(event)">
                <div class="text-6xl mb-2">üê•</div>
                <h2 class="font-bold text-xl mb-1">Click for Cash!</h2>
                <p class="text-gray-500 text-sm">Get quick money to buy eggs</p>
            </div>

            <!-- Egg Shop -->
            <div>
                <h3 class="font-bold text-lg mb-3 flex items-center gap-2">
                    <i class="fas fa-shopping-basket text-orange-500"></i> Egg Shop
                </h3>
                <p class="text-xs text-gray-500 mb-2 italic">Click an egg icon to see drop rates!</p>
                <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4" id="egg-shop-container">
                    <!-- Eggs inserted by JS -->
                </div>
            </div>
        </section>

        <!-- Right Panel: Inventory -->
        <section class="flex-1 bg-white/50 backdrop-blur-sm border-l border-white/20 p-4 overflow-y-auto flex flex-col">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2">
                    <h3 class="font-bold text-lg flex items-center gap-2">
                        <i class="fas fa-paw text-purple-500"></i> My Pets
                        <span id="pet-count" class="bg-purple-100 text-purple-600 px-2 py-0.5 rounded-full text-xs">0</span>
                    </h3>
                </div>
                <button onclick="openMergeModal()" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded-full transition shadow-sm flex items-center gap-1">
                    <i class="fas fa-random"></i> Merge
                </button>
            </div>
            
            <!-- Inventory Wrapper -->
            <div class="relative flex-1 overflow-y-auto pr-1">
                <div id="empty-inventory" class="text-center py-10 text-gray-400 italic">
                    You have no pets yet. Buy an egg to start!
                </div>
                
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 gap-3 content-start pb-4" id="inventory-container">
                    <!-- Inventory Items inserted by JS -->
                </div>
            </div>
        </section>

    </main>

    <!-- Hatching Modal Overlay -->
    <div id="hatch-overlay" class="fixed inset-0 bg-black/80 z-50 hidden flex flex-col items-center justify-center backdrop-blur-sm">
        <div class="relative">
            <div id="hatch-egg-display" class="text-9xl transition-all duration-300 cursor-pointer">ü•ö</div>
            <div id="hatch-rays" class="absolute inset-0 bg-yellow-400 rounded-full blur-3xl opacity-0 transition-opacity duration-500 -z-10 animate-pulse"></div>
        </div>
        
        <div id="hatch-message" class="text-white text-2xl font-bold mt-8 text-center h-8">Tap to Hatch!</div>
        
        <div id="new-pet-card" class="hidden transform transition-all duration-500">
            <div class="bg-white p-6 rounded-2xl shadow-2xl text-center w-64 border-4" id="reveal-card-bg">
                <div class="text-sm font-bold uppercase tracking-wider mb-2" id="reveal-rarity">Common</div>
                <div class="text-8xl mb-4 pop-in" id="reveal-icon">üê•</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-1" id="reveal-name">Baby Chick</h2>
                <div class="text-green-600 font-bold text-lg mb-4">+$<span id="reveal-rate">1</span>/s</div>
                <button onclick="closeHatchModal()" class="bg-gray-800 text-white px-6 py-2 rounded-full font-bold hover:bg-gray-700 transition w-full">
                    Awesome!
                </button>
            </div>
        </div>
    </div>

    <!-- Egg Info Modal -->
    <div id="egg-info-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div id="egg-info-header" class="p-4 bg-gray-100 border-b flex justify-between items-center">
                <h2 class="font-bold text-xl flex items-center gap-2" id="egg-info-title">Egg Info</h2>
                <button onclick="closeEggInfo()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 max-h-[60vh] overflow-y-auto">
                <div id="egg-info-list" class="space-y-2">
                    <!-- Rates inserted by JS -->
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t text-center text-xs text-gray-500">
                Good luck!
            </div>
        </div>
    </div>

    <!-- Merge Modal -->
    <div id="merge-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[80vh]">
            <div class="p-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white flex justify-between items-center shrink-0">
                <div>
                    <h2 class="font-bold text-xl"><i class="fas fa-flask"></i> Merge Chamber</h2>
                    <p class="text-xs opacity-90">Fuse 3 identical pets for a chance to upgrade!</p>
                </div>
                <button onclick="closeMergeModal()" class="text-white/80 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-4 overflow-y-auto flex-1 bg-gray-50">
                <div id="merge-list" class="space-y-3">
                    <!-- Merge candidates inserted by JS -->
                </div>
                <div id="no-merge-msg" class="hidden text-center py-8 text-gray-400">
                    <div class="text-4xl mb-2">üß¨</div>
                    <p>You need 3 of the same pet to merge.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-[60] text-sm font-bold text-center">
        Notification
    </div>

    <script>
        /* --- GAME DATA --- */
        // Expanded Pet List with continuous Merge Chain
        const PETS = {
            // Tier 1: Common
            'ant': { id: 'ant', name: 'Worker Ant', icon: 'üêú', rate: 1, rarity: 'Common', next: 'chick' },
            'chick': { id: 'chick', name: 'Baby Chick', icon: 'üê•', rate: 2, rarity: 'Common', next: 'mouse' },
            'mouse': { id: 'mouse', name: 'Field Mouse', icon: 'üêÅ', rate: 3, rarity: 'Common', next: 'fish' },
            'fish': { id: 'fish', name: 'Goldfish', icon: 'üê†', rate: 4, rarity: 'Common', next: 'beetle' },
            'beetle': { id: 'beetle', name: 'Beetle', icon: 'üêû', rate: 5, rarity: 'Common', next: 'cat' },
            
            // Tier 2: Uncommon
            'cat': { id: 'cat', name: 'Stray Cat', icon: 'üêà', rate: 8, rarity: 'Uncommon', next: 'dog' },
            'dog': { id: 'dog', name: 'Good Boy', icon: 'üêï', rate: 10, rarity: 'Uncommon', next: 'pig' },
            'pig': { id: 'pig', name: 'Piggy', icon: 'üêñ', rate: 12, rarity: 'Uncommon', next: 'sheep' },
            'sheep': { id: 'sheep', name: 'Sheep', icon: 'üêë', rate: 15, rarity: 'Uncommon', next: 'snake' },
            'snake': { id: 'snake', name: 'Snake', icon: 'üêç', rate: 18, rarity: 'Uncommon', next: 'crab' },
            'crab': { id: 'crab', name: 'Crab', icon: 'ü¶Ä', rate: 22, rarity: 'Uncommon', next: 'fox' },

            // Tier 3: Rare
            'fox': { id: 'fox', name: 'Sly Fox', icon: 'ü¶ä', rate: 35, rarity: 'Rare', next: 'monkey' },
            'monkey': { id: 'monkey', name: 'Monkey', icon: 'üêí', rate: 40, rarity: 'Rare', next: 'penguin' },
            'penguin': { id: 'penguin', name: 'Penguin', icon: 'üêß', rate: 45, rarity: 'Rare', next: 'owl' },
            'owl': { id: 'owl', name: 'Wise Owl', icon: 'ü¶â', rate: 55, rarity: 'Rare', next: 'camel' },
            'camel': { id: 'camel', name: 'Camel', icon: 'üê´', rate: 65, rarity: 'Rare', next: 'turtle' },
            'turtle': { id: 'turtle', name: 'Turtle', icon: 'üê¢', rate: 75, rarity: 'Rare', next: 'wolf' },
            'wolf': { id: 'wolf', name: 'Wolf', icon: 'üê∫', rate: 90, rarity: 'Rare', next: 'vulture' },
            'vulture': { id: 'vulture', name: 'Vulture', icon: 'ü¶Ö', rate: 100, rarity: 'Rare', next: 't-rex' },

            // Tier 4: Epic
            't-rex': { id: 't-rex', name: 'T-Rex', icon: 'ü¶ñ', rate: 150, rarity: 'Epic', next: 'shark' },
            'shark': { id: 'shark', name: 'Great White', icon: 'ü¶à', rate: 170, rarity: 'Epic', next: 'alien' },
            'alien': { id: 'alien', name: 'Martian', icon: 'üëΩ', rate: 190, rarity: 'Epic', next: 'robot' },
            'robot': { id: 'robot', name: 'Bot-X', icon: 'ü§ñ', rate: 210, rarity: 'Epic', next: 'tiger' },
            'tiger': { id: 'tiger', name: 'Bengal Tiger', icon: 'üêÖ', rate: 240, rarity: 'Epic', next: 'bear' },
            'bear': { id: 'bear', name: 'Grizzly', icon: 'üêª', rate: 270, rarity: 'Epic', next: 'triceratops' },
            'triceratops': { id: 'triceratops', name: 'Triceratops', icon: 'ü¶ï', rate: 300, rarity: 'Epic', next: 'pterodactyl' },
            'pterodactyl': { id: 'pterodactyl', name: 'Pterodactyl', icon: 'ü¶á', rate: 350, rarity: 'Epic', next: 'skeleton' },
            'skeleton': { id: 'skeleton', name: 'Skeleton', icon: 'üíÄ', rate: 400, rarity: 'Epic', next: 'unicorn' },

            // Tier 5: Legendary
            'unicorn': { id: 'unicorn', name: 'Unicorn', icon: 'ü¶Ñ', rate: 600, rarity: 'Legendary', next: 'dragon' },
            'dragon': { id: 'dragon', name: 'Red Dragon', icon: 'üêâ', rate: 800, rarity: 'Legendary', next: 'yeti' },
            'yeti': { id: 'yeti', name: 'Abominable', icon: 'ü¶ç', rate: 1000, rarity: 'Legendary', next: 'mammoth' },
            'mammoth': { id: 'mammoth', name: 'Mammoth', icon: 'ü¶£', rate: 1250, rarity: 'Legendary', next: 'reaper' },
            'reaper': { id: 'reaper', name: 'Grim Reaper', icon: 'üïØÔ∏è', rate: 1666, rarity: 'Legendary', next: 'griffin' },
            'griffin': { id: 'griffin', name: 'Griffin', icon: 'ü¶Å', rate: 2000, rarity: 'Legendary', next: 'phoenix' },

            // Tier 6: Mythical
            'phoenix': { id: 'phoenix', name: 'Phoenix', icon: 'üî•', rate: 3500, rarity: 'Mythical', next: 'kraken' },
            'kraken': { id: 'kraken', name: 'The Kraken', icon: 'üêô', rate: 5000, rarity: 'Mythical', next: 'hydra' },
            'hydra': { id: 'hydra', name: 'Hydra', icon: 'üêç', rate: 7500, rarity: 'Mythical', next: 'titan' },
            'titan': { id: 'titan', name: 'Titan', icon: 'üóø', rate: 10000, rarity: 'Mythical', next: 'void' },

            // Tier 7: Godly
            'void': { id: 'void', name: 'The Void', icon: 'üåå', rate: 50000, rarity: 'Godly', next: null },
        };

        const EGGS = [
            { 
                id: 'starter', name: 'Starter Egg', cost: 50, icon: 'ü•ö', colorClass: 'bg-orange-100 border-orange-200',
                pool: { 'ant': 0.45, 'chick': 0.40, 'mouse': 0.15 } 
            },
            { 
                id: 'farm', name: 'Farm Egg', cost: 250, icon: 'üè°', colorClass: 'bg-yellow-100 border-yellow-200',
                pool: { 'mouse': 0.3, 'beetle': 0.2, 'cat': 0.25, 'dog': 0.15, 'pig': 0.08, 'sheep': 0.02 } 
            },
            { 
                id: 'aqua', name: 'Aqua Egg', cost: 1500, icon: 'üåä', colorClass: 'bg-blue-100 border-blue-200',
                pool: { 'fish': 0.35, 'crab': 0.3, 'turtle': 0.2, 'shark': 0.1, 'kraken': 0.005 } 
            },
            { 
                id: 'desert', name: 'Desert Egg', cost: 5000, icon: 'üåµ', colorClass: 'bg-amber-100 border-amber-200',
                pool: { 'snake': 0.4, 'camel': 0.3, 'vulture': 0.2, 'fox': 0.1 } 
            },
            { 
                id: 'spooky', name: 'Spooky Egg', cost: 15000, icon: 'üëª', colorClass: 'bg-purple-100 border-purple-200',
                pool: { 'spider': 0.3, 'owl': 0.3, 'wolf': 0.25, 'skeleton': 0.1, 'reaper': 0.05 } 
            },
            { 
                id: 'forest', name: 'Forest Egg', cost: 60000, icon: 'üå≤', colorClass: 'bg-green-100 border-green-200',
                pool: { 'fox': 0.3, 'monkey': 0.3, 'owl': 0.2, 'wolf': 0.15, 'bear': 0.05 } 
            },
            { 
                id: 'prehistoric', name: 'Dino Egg', cost: 250000, icon: 'üåã', colorClass: 'bg-red-100 border-red-200',
                pool: { 't-rex': 0.4, 'triceratops': 0.3, 'pterodactyl': 0.2, 'mammoth': 0.1 } 
            },
            { 
                id: 'jungle', name: 'Jungle Egg', cost: 1000000, icon: 'üå¥', colorClass: 'bg-emerald-100 border-emerald-200',
                pool: { 'monkey': 0.3, 'snake': 0.3, 'tiger': 0.2, 'bear': 0.15, 'hydra': 0.005 } 
            },
            { 
                id: 'arctic', name: 'Arctic Egg', cost: 5000000, icon: '‚ùÑÔ∏è', colorClass: 'bg-cyan-100 border-cyan-200',
                pool: { 'penguin': 0.4, 'bear': 0.3, 'yeti': 0.2, 'mammoth': 0.1 } 
            },
            { 
                id: 'cosmic', name: 'Cosmic Egg', cost: 25000000, icon: 'ü™ê', colorClass: 'bg-indigo-100 border-indigo-200',
                pool: { 'alien': 0.4, 'robot': 0.4, 'titan': 0.15, 'void': 0.005 } 
            },
            { 
                id: 'fantasy', name: 'Fantasy Egg', cost: 100000000, icon: 'üè∞', colorClass: 'bg-pink-100 border-pink-200',
                pool: { 'unicorn': 0.35, 'griffin': 0.3, 'dragon': 0.2, 'phoenix': 0.1, 'titan': 0.05 } 
            },
            { 
                id: 'divine', name: 'Divine Egg', cost: 500000000, icon: 'üëë', colorClass: 'bg-yellow-50 border-yellow-300',
                pool: { 'phoenix': 0.4, 'kraken': 0.25, 'hydra': 0.2, 'titan': 0.1, 'void': 0.05 } 
            }
        ];

        /* --- STATE --- */
        let state = {
            money: 0,
            inventory: [], // Array of pet IDs
            lastSave: Date.now()
        };

        /* --- GAME LOGIC --- */

        // Start Loop
        window.onload = function() {
            loadGame();
            renderShop();
            renderInventory();
            updateUI();
            
            // Income Tick (every 1 sec)
            setInterval(() => {
                const income = calculateIncome();
                if (income > 0) {
                    addMoney(income);
                }
            }, 1000);

            // Auto Save (every 10 sec)
            setInterval(saveGame, 10000);
        };

        function calculateIncome() {
            return state.inventory.reduce((total, petId) => {
                const pet = PETS[petId];
                return total + (pet ? pet.rate : 0);
            }, 0);
        }

        function addMoney(amount) {
            state.money += amount;
            updateUI();
        }

        function manualClick(e) {
            const baseClick = 1;
            // Click power scales slightly with income (1% of income per click, min 1)
            const bonus = Math.floor(calculateIncome() * 0.05); 
            const total = baseClick + bonus;
            
            addMoney(total);
            
            // Visual Effect
            createFloatingText(e.clientX, e.clientY, `+$${total}`);
        }

        function buyEgg(eggId) {
            const egg = EGGS.find(e => e.id === eggId);
            if (!egg) return;

            if (state.money >= egg.cost) {
                state.money -= egg.cost;
                updateUI();
                startHatchingSequence(egg);
            } else {
                showToast("Not enough money!");
            }
        }

        /* --- EGG INFO SYSTEM --- */
        function showEggInfo(eggId) {
            const egg = EGGS.find(e => e.id === eggId);
            if(!egg) return;

            document.getElementById('egg-info-title').innerHTML = `${egg.icon} ${egg.name} Rates`;
            const list = document.getElementById('egg-info-list');
            
            // Convert pool to sorted array
            const drops = Object.entries(egg.pool)
                .map(([petId, chance]) => ({ pet: PETS[petId], chance }))
                .filter(d => d.pet) // Filter out any undefined pets just in case
                .sort((a,b) => a.chance - b.chance); 

            list.innerHTML = drops.map(d => {
                const percent = (d.chance * 100).toFixed(1);
                // Color code percent
                let percentColor = 'text-gray-600';
                if(d.chance < 0.05) percentColor = 'text-red-500 font-bold';
                else if(d.chance < 0.15) percentColor = 'text-orange-500 font-bold';

                return `
                    <div class="flex items-center justify-between p-2 rounded bg-gray-50 border border-gray-100">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">${d.pet.icon}</div>
                            <div>
                                <div class="font-bold text-sm text-gray-800">${d.pet.name}</div>
                                <div class="text-[10px] uppercase font-bold text-gray-400">${d.pet.rarity}</div>
                            </div>
                        </div>
                        <div class="${percentColor}">${percent}%</div>
                    </div>
                `;
            }).join('');

            document.getElementById('egg-info-modal').classList.remove('hidden');
        }

        function closeEggInfo() {
            document.getElementById('egg-info-modal').classList.add('hidden');
        }

        /* --- MERGE SYSTEM --- */
        function openMergeModal() {
            const modal = document.getElementById('merge-modal');
            const list = document.getElementById('merge-list');
            const msg = document.getElementById('no-merge-msg');
            
            modal.classList.remove('hidden');
            
            // Count pets
            const counts = {};
            state.inventory.forEach(id => {
                counts[id] = (counts[id] || 0) + 1;
            });

            // Find mergeable
            const mergeable = Object.entries(counts)
                .filter(([id, count]) => count >= 3 && PETS[id] && PETS[id].next)
                .map(([id, count]) => ({ id, count, pet: PETS[id] }));

            if (mergeable.length === 0) {
                list.innerHTML = '';
                msg.classList.remove('hidden');
                return;
            }

            msg.classList.add('hidden');
            list.innerHTML = mergeable.map(m => {
                const nextPet = PETS[m.pet.next];
                if (!nextPet) return ''; // Should not happen due to filter but safety first

                return `
                    <div class="bg-white border-2 border-blue-100 p-4 rounded-xl flex items-center justify-between shadow-sm">
                        <div class="flex items-center gap-4">
                            <div class="relative">
                                <div class="text-4xl">${m.pet.icon}</div>
                                <div class="absolute -bottom-1 -right-1 bg-blue-600 text-white text-[10px] px-1.5 rounded-full font-bold">x${m.count}</div>
                            </div>
                            <div>
                                <div class="font-bold text-gray-800">${m.pet.name}</div>
                                <div class="text-xs text-blue-500 flex items-center gap-1">
                                    Merge 3 <i class="fas fa-arrow-right text-[10px]"></i> ${nextPet.icon} ?
                                </div>
                            </div>
                        </div>
                        <button onclick="performMerge('${m.id}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-sm transition active:scale-95">
                            Merge
                        </button>
                    </div>
                `;
            }).join('');
        }

        function closeMergeModal() {
            document.getElementById('merge-modal').classList.add('hidden');
        }

        function performMerge(petId) {
            // Validate
            const count = state.inventory.filter(id => id === petId).length;
            if (count < 3) {
                showToast("Not enough pets!");
                openMergeModal(); // Refresh
                return;
            }

            const currentPet = PETS[petId];
            const nextPetId = currentPet.next;
            const nextPet = PETS[nextPetId];

            if (!nextPet) return;

            // Remove 3 pets
            let removed = 0;
            const newInventory = [];
            for (let item of state.inventory) {
                if (item === petId && removed < 3) {
                    removed++;
                } else {
                    newInventory.push(item);
                }
            }
            state.inventory = newInventory;

            // Luck Calculation (75% chance)
            const roll = Math.random();
            const success = roll < 0.75;

            if (success) {
                state.inventory.push(nextPetId);
                showToast(`Success! Merged into ${nextPet.name}!`);
            } else {
                showToast(`Failed! The fusion unstable...`);
            }

            saveGame();
            renderInventory();
            updateUI();
            openMergeModal(); // Refresh list
        }

        /* --- HATCHING SYSTEM --- */
        let hatchTimeout = null;

        function startHatchingSequence(egg) {
            const overlay = document.getElementById('hatch-overlay');
            const eggDisplay = document.getElementById('hatch-egg-display');
            const message = document.getElementById('hatch-message');
            const petCard = document.getElementById('new-pet-card');
            const rays = document.getElementById('hatch-rays');

            petCard.classList.add('hidden');
            eggDisplay.classList.remove('hidden', 'pop-in');
            eggDisplay.style.transform = 'scale(1)';
            eggDisplay.innerHTML = egg.icon; 
            message.innerText = "Tap egg to hatch!";
            message.classList.remove('hidden');
            rays.style.opacity = '0';

            if (hatchTimeout) clearTimeout(hatchTimeout);

            overlay.classList.remove('hidden');

            eggDisplay.onclick = function() {
                eggDisplay.classList.add('shake-animation');
                message.innerText = "Cracking...";
                
                hatchTimeout = setTimeout(() => {
                    revealPet(egg);
                }, 1000);
                
                eggDisplay.onclick = null;
            };
        }

        function revealPet(egg) {
            const petId = rollPet(egg.pool);
            if (!petId || !PETS[petId]) {
                 closeHatchModal();
                 // Fallback if we somehow rolled a pet that isn't in PETS (e.g. 'spider' used in pool but not defined)
                 // Just give them a common as backup
                 state.inventory.push('ant');
                 showToast("Glitched egg! Found an Ant.");
                 return;
            }
            const pet = PETS[petId];
            state.inventory.push(petId);
            
            try {
                const eggDisplay = document.getElementById('hatch-egg-display');
                const petCard = document.getElementById('new-pet-card');
                const message = document.getElementById('hatch-message');
                const rays = document.getElementById('hatch-rays');
                
                document.getElementById('reveal-icon').innerText = pet.icon;
                document.getElementById('reveal-name').innerText = pet.name;
                document.getElementById('reveal-rarity').innerText = pet.rarity;
                document.getElementById('reveal-rate').innerText = pet.rate;
                
                const cardBg = document.getElementById('reveal-card-bg');
                const rarityClass = `rarity-${pet.rarity.toLowerCase()}`;
                cardBg.className = `bg-white p-6 rounded-2xl shadow-2xl text-center w-64 border-4 ${rarityClass}`;
                
                eggDisplay.classList.remove('shake-animation');
                eggDisplay.classList.add('hidden');
                message.classList.add('hidden');
                
                petCard.classList.remove('hidden');
                petCard.classList.add('pop-in');
                
                if(['Epic', 'Legendary', 'Mythical', 'Godly'].includes(pet.rarity)) {
                    rays.style.opacity = '0.5';
                }
            } catch (err) {
                console.error("Card Display Error:", err);
                closeHatchModal();
                showToast("You caught a " + pet.name + "!");
            }

            try {
                renderInventory();
                updateUI();
            } catch (err) {
                console.warn("Inventory Render Error:", err);
            }

            saveGame(); 
        }

        function rollPet(pool) {
            const rand = Math.random();
            let cumulative = 0;
            for (const [petId, chance] of Object.entries(pool)) {
                cumulative += chance;
                if (rand < cumulative) {
                    return petId;
                }
            }
            return Object.keys(pool)[0];
        }

        function closeHatchModal() {
            document.getElementById('hatch-overlay').classList.add('hidden');
        }

        /* --- UI RENDERING --- */
        function renderShop() {
            const container = document.getElementById('egg-shop-container');
            container.innerHTML = EGGS.map(egg => `
                <div class="rounded-xl p-4 shadow-md transition-all hover:-translate-y-1 hover:shadow-lg flex flex-col items-center ${egg.colorClass}">
                    <div class="cursor-pointer transition-transform hover:scale-110 active:scale-95 text-center w-full" onclick="showEggInfo('${egg.id}')" title="Click for Drop Rates">
                        <div class="text-4xl mb-2">${egg.icon}</div>
                        <div class="font-bold text-lg leading-tight mb-1 flex items-center justify-center gap-1">
                            ${egg.name} <i class="fas fa-info-circle text-gray-400 text-xs"></i>
                        </div>
                        <div class="text-xs text-gray-500 text-center mb-3 h-8 overflow-hidden">
                            ${getRarePreview(egg.pool)}
                        </div>
                    </div>
                    <button onclick="buyEgg('${egg.id}')" class="bg-white border-2 border-green-500 text-green-600 font-bold py-1.5 px-6 rounded-full hover:bg-green-500 hover:text-white transition w-full shadow-sm z-10">
                        $${egg.cost.toLocaleString()}
                    </button>
                </div>
            `).join('');
        }

        function getRarePreview(pool) {
            // Filter pool to ensure pet exists in PETS
            const validPool = Object.entries(pool).filter(([id]) => PETS[id]);
            const sorted = validPool.sort((a,b) => a[1] - b[1]); 
            const best = sorted.slice(0, 2);
            return "Contains: " + best.map(([id]) => PETS[id].icon).join(' ');
        }

        function renderInventory() {
            const container = document.getElementById('inventory-container');
            const emptyMsg = document.getElementById('empty-inventory');
            
            if (state.inventory.length === 0) {
                if(emptyMsg) emptyMsg.style.display = 'block';
                container.innerHTML = '';
                return;
            } else {
                if(emptyMsg) emptyMsg.style.display = 'none';
            }

            const list = [...state.inventory].reverse();

            container.innerHTML = list.map(petId => {
                const pet = PETS[petId];
                if (!pet) return ''; 
                return `
                    <div class="rarity-${pet.rarity.toLowerCase()} rounded-lg p-2 flex flex-col items-center justify-center relative shadow-sm aspect-square transition hover:scale-105 select-none">
                        <div class="text-3xl mb-1">${pet.icon}</div>
                        <div class="text-xs font-bold text-gray-700 truncate w-full text-center">${pet.name}</div>
                        <div class="text-[10px] text-gray-500 font-mono bg-white/50 px-1 rounded">+$${pet.rate}/s</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('pet-count').innerText = state.inventory.length;
        }

        function updateUI() {
            document.getElementById('money-display').innerText = Math.floor(state.money).toLocaleString();
            document.getElementById('income-display').innerText = calculateIncome().toLocaleString();
        }

        /* --- UTILS --- */
        function createFloatingText(x, y, text) {
            const el = document.createElement('div');
            el.className = 'float-text';
            el.style.left = x + 'px';
            el.style.top = y + 'px';
            el.innerText = text;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 3000);
        }

        /* --- SAVE SYSTEM --- */
        function saveGame() {
            try {
                localStorage.setItem('gibchick_save', JSON.stringify(state));
            } catch (e) {
                console.warn("Save failed (Storage Full or Disabled):", e);
            }
        }

        function loadGame() {
            const saved = localStorage.getItem('gibchick_save');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if(parsed.money !== undefined) state.money = parsed.money;
                    if(parsed.inventory && Array.isArray(parsed.inventory)) state.inventory = parsed.inventory;
                } catch (e) {
                    console.error("Save corrupted");
                }
            } else {
                state.money = 0;
            }
        }
    </script>
</body>
</html>