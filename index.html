<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gibchick - Ultimate Idle Clicker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');
        
        body {
            font-family: 'Fredoka', sans-serif;
            transition: background 1s ease, color 0.5s ease;
            overscroll-behavior: none;
            user-select: none;
        }

        /* --- WORLD THEMES --- */
        .bg-world-home { background: linear-gradient(135deg, #e0f7fa 0%, #80deea 100%); }
        .bg-world-spooky { background: linear-gradient(135deg, #2d1b4e 0%, #1a102e 100%); color: black; }
        .bg-world-jurassic { background: linear-gradient(135deg, #fed7aa 0%, #fb923c 100%); }
        .bg-world-frozen { background: linear-gradient(135deg, #cffafe 0%, #67e8f9 100%); }
        .bg-world-magic { background: linear-gradient(135deg, #fbcfe8 0%, #f472b6 100%); }
        .bg-world-space { background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%); color: #1f2937; } 
        .bg-world-divine { background: linear-gradient(135deg, #fef9c3 0%, #facc15 100%); }
        
        .bg-world-cyber { background: linear-gradient(135deg, #0f172a 0%, #0ea5e9 100%); color: #1f2937; }
        .bg-world-volcano { background: linear-gradient(135deg, #450a0a 0%, #ef4444 100%); color: #fecaca; }
        .bg-world-candy { background: linear-gradient(135deg, #fdf4ff 0%, #f5d0fe 100%); color: #86198f; }
        .bg-world-atlantis { background: linear-gradient(135deg, #022c22 0%, #0d9488 100%); color: #1f2937; }
        .bg-world-shadow { background: linear-gradient(135deg, #000000 0%, #581c87 100%); color: #1f2937; }
        .bg-world-celestial { background: linear-gradient(135deg, #fffbeb 0%, #fcd34d 50%, #fffbeb 100%); color: #78350f; }
        .bg-world-radioactive { background: linear-gradient(135deg, #14532d 0%, #4ade80 100%); color: #064e3b; }

        .bg-world-gold { background: linear-gradient(135deg, #FFD700 0%, #FDB931 100%); color: #7c5e10; }
        .bg-world-rainbow { background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 20%, #a18cd1 100%); color: #4a044e; }
        .bg-world-mecha { background: linear-gradient(135deg, #2c3e50 0%, #bdc3c7 100%); color: #1f2937; }
        .bg-world-darkmatter { background: linear-gradient(135deg, #000000 0%, #434343 100%); color: #1f2937; }

        /* Forced Dark Text for White Cards */
        .bg-white, .bg-white\/90 { color: #1f2937; }

        .shake-animation { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite; }
        @keyframes shake { 10%,90%{transform:translate3d(-1px,0,0) rotate(-5deg)} 20%,80%{transform:translate3d(2px,0,0) rotate(5deg)} 30%,50%,70%{transform:translate3d(-4px,0,0) rotate(-5deg)} 40%,60%{transform:translate3d(4px,0,0) rotate(5deg)} }
        
        .pop-in { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn { 0%{opacity:0;transform:scale(0.5)} 100%{opacity:1;transform:scale(1)} }
        
        .float-text { position: absolute; animation: floatUp 1s forwards; pointer-events: none; font-weight: bold; color: #10b981; text-shadow: 1px 1px 0 #fff; z-index: 50; }
        @keyframes floatUp { 0%{opacity:1;transform:translateY(0)} 100%{opacity:0;transform:translateY(-50px)} }

        /* Rarity & Mutation Styles */
        .rarity-common { background: linear-gradient(to bottom right, #f3f4f6, #d1d5db); border: 2px solid #9ca3af; }
        .rarity-uncommon { background: linear-gradient(to bottom right, #d1fae5, #6ee7b7); border: 2px solid #10b981; }
        .rarity-rare { background: linear-gradient(to bottom right, #dbeafe, #60a5fa); border: 2px solid #2563eb; }
        .rarity-epic { background: linear-gradient(to bottom right, #f3e8ff, #c084fc); border: 2px solid #9333ea; }
        .rarity-legendary { background: linear-gradient(to bottom right, #fef3c7, #fcd34d); border: 2px solid #d97706; box-shadow: 0 0 10px #fbbf24; }
        .rarity-mythical { background: linear-gradient(to bottom right, #fee2e2, #f87171); border: 2px solid #dc2626; box-shadow: 0 0 15px #ef4444; animation: pulse-mythical 2s infinite; }
        .rarity-godly { background: linear-gradient(to bottom right, #2d2d2d, #000000); border: 2px solid #a8a8a8; box-shadow: 0 0 20px #ffffff; color: white; animation: pulse-godly 3s infinite; }
        .rarity-transcendent { background: linear-gradient(to bottom right, #000000, #1a1a2e, #16213e); border: 3px solid #ffd700; box-shadow: 0 0 30px #ffd700, 0 0 60px #ffd700; color: #ffd700; animation: pulse-transcendent 2s infinite; }
        .rarity-eternal { background: linear-gradient(to bottom right, #0891b2, #ecfeff, #0891b2); border: 3px solid #22d3ee; box-shadow: 0 0 40px #22d3ee, 0 0 80px #67e8f9; color: #0e7490; animation: pulse-eternal 4s infinite; }
        .rarity-special { background: linear-gradient(124deg, #ff2400, #e81d1d, #e8b71d, #e3e81d, #1de840, #1ddde8, #2b1de8, #dd00f3, #dd00f3); background-size: 400% 400%; border: 3px solid white; box-shadow: 0 0 20px #ffffff; color: white; text-shadow: 1px 1px 2px black; animation: rainbow 6s ease infinite; }

        /* Mutation Badges */
        /* REMOVED absolute positioning from the badge itself so they stack in flex containers */
        .mutation-badge { width: 14px; height: 14px; border-radius: 50%; display: inline-block; border: 1px solid white; box-shadow: 0 0 2px rgba(0,0,0,0.5); flex-shrink: 0; }
        
        /* Container for badges on cards */
        .mutation-container { position: absolute; top: 4px; right: 4px; display: flex; gap: 2px; z-index: 10; flex-wrap: wrap; justify-content: flex-end; max-width: 60px; }

        .mut-gold { background: #ffd700; color: #b45309; box-shadow: 0 0 5px #ffd700; }
        .mut-rainbow { background: linear-gradient(124deg, #ff2400, #e81d1d, #e8b71d, #e3e81d, #1de840, #1ddde8, #2b1de8, #dd00f3); color: white; }
        .mut-darkmatter { background: black; color: #00ffcc; border-color: #00ffcc; }
        .mut-radioactive { background: #4ade80; color: #14532d; }
        .mut-revival { background: #f472b6; color: white; }
        .mut-chaos { background: #dc2626; color: white; }

        .rarity-godly .text-gray-700, .rarity-transcendent .text-gray-700, .rarity-eternal .text-gray-700, .rarity-special .text-gray-700 { color: inherit !important; }
        .rarity-godly .text-gray-500, .rarity-transcendent .text-gray-500, .rarity-eternal .text-gray-500, .rarity-special .text-gray-500 { color: rgba(255,255,255,0.7) !important; }

        @keyframes pulse-godly { 0%{box-shadow:0 0 10px #ffffff} 50%{box-shadow:0 0 30px #888,0 0 50px #fff} 100%{box-shadow:0 0 10px #ffffff} }
        @keyframes pulse-mythical { 0%{box-shadow:0 0 10px #ef4444} 50%{box-shadow:0 0 20px #f87171,0 0 40px #fca5a5} 100%{box-shadow:0 0 10px #ef4444} }
        @keyframes pulse-transcendent { 0%{box-shadow:0 0 20px #ffd700,0 0 40px #ffd700} 50%{box-shadow:0 0 40px #ffd700,0 0 80px #ffed4e,0 0 120px #ffd700} 100%{box-shadow:0 0 20px #ffd700,0 0 40px #ffd700} }
        @keyframes pulse-eternal { 0%{background-position:0% 50%;box-shadow:0 0 30px #22d3ee} 50%{background-position:100% 50%;box-shadow:0 0 60px #67e8f9,0 0 90px #a5f3fc} 100%{background-position:0% 50%;box-shadow:0 0 30px #22d3ee} }
        @keyframes rainbow { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); }
        .pet-silhouette { filter: brightness(0) opacity(0.2); }
        .pet-locked-text { color: transparent; text-shadow: 0 0 8px rgba(0,0,0,0.5); }
    </style>
</head>
<body id="game-body" class="h-screen flex flex-col overflow-hidden text-gray-800 bg-world-home">

    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-md shadow-md p-4 flex justify-between items-center z-10 shrink-0">
        <div class="flex items-center gap-3">
            <div class="text-3xl">üê£</div>
            <div>
                <h1 class="font-bold text-xl leading-none text-purple-600">Gibchick</h1>
                <span class="text-xs text-gray-500">Collect 'em all!</span>
            </div>
            <button onclick="openAdminModal()" class="ml-2 text-gray-400 hover:text-red-500 transition text-sm" title="Admin"><i class="fas fa-user-shield"></i></button>
            <button onclick="openRebirthModal()" class="ml-2 text-purple-500 hover:text-purple-700 transition text-sm animate-pulse" title="Rebirth"><i class="fas fa-sync-alt text-xl"></i></button>
            <button onclick="openKitchenModal()" class="ml-2 text-green-500 hover:text-green-700 transition text-sm" title="Kitchen Cosmos"><i class="fas fa-atom text-xl"></i></button>
            <button onclick="openIndexModal()" class="ml-2 text-blue-400 hover:text-blue-600 transition text-sm" title="Pet Index"><i class="fas fa-book-open text-xl"></i></button>
            <button onclick="openResetModal()" class="ml-2 text-gray-300 hover:text-red-500 transition text-sm" title="Reset Progress"><i class="fas fa-trash-alt"></i></button>
        </div>
        
        <div class="flex gap-6 text-right">
            <div>
                <div class="text-xs text-gray-500 font-bold uppercase">Cash</div>
                <div class="text-2xl font-bold text-green-600 flex items-center gap-1 justify-end">$<span id="money-display">0</span></div>
            </div>
            <div>
                <div class="text-xs text-gray-500 font-bold uppercase">Income</div>
                <div class="text-xl font-bold text-blue-500 flex items-center gap-1 justify-end">$<span id="income-display">0</span><span class="text-sm text-gray-400">/s</span></div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col md:flex-row overflow-hidden">
        
        <!-- Left Panel -->
        <section class="flex-1 p-4 overflow-y-auto flex flex-col gap-6 relative" id="click-area">
            
            <div class="bg-white/90 backdrop-blur rounded-2xl shadow-lg p-6 text-center transform hover:scale-[1.02] transition-transform cursor-pointer active:scale-95 select-none text-gray-800" onclick="manualClick(event)">
                <div class="text-6xl mb-2">üê•</div>
                <h2 class="font-bold text-xl mb-1">Click for Cash!</h2>
                <p class="text-gray-500 text-sm">Get quick money to buy eggs</p>
                <div id="rebirth-multiplier-display" class="text-xs text-purple-600 font-bold mt-2 hidden">Rebirth Multiplier: x1</div>
            </div>

            <!-- World Selector & Egg Shop -->
            <div>
                <div class="flex justify-between items-center mb-3">
                    <h3 class="font-bold text-lg flex items-center gap-2"><i class="fas fa-globe text-blue-500"></i> Worlds</h3>
                    <div class="text-xs opacity-80" id="world-status">Home Village</div>
                </div>
                
                <!-- Galaxy Navigation -->
                <div class="flex gap-2 overflow-x-auto pb-2 mb-2 scrollbar-hide border-b border-gray-200/20" id="galaxy-nav-container"></div>
                <!-- World Navigation Scroll -->
                <div class="flex gap-2 overflow-x-auto pb-4 mb-2 scrollbar-hide" id="world-nav-container"></div>
                
                <!-- Hatch Slider -->
                <div class="mb-4 px-2" id="hatch-slider-container" style="display:none;">
                     <div class="flex justify-between text-xs font-bold mb-1 opacity-90">
                         <span>Hatch Amount</span>
                         <span id="hatch-amount-display">1x</span>
                     </div>
                     <input type="range" id="hatch-amount-slider" min="1" max="1" value="1" class="w-full accent-blue-500" oninput="updateHatchSetting(this.value)">
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-4" id="egg-shop-container"></div>
             </div>

             <!-- Upgrades -->
             <div>
                 <h3 class="font-bold text-lg mb-3 flex items-center gap-2"><i class="fas fa-arrow-up text-purple-500"></i> Upgrades</h3>
                 <div id="upgrades-container" class="grid grid-cols-1 gap-3"></div>
             </div>

             <!-- Trust & Quests -->
             <div>
                 <h3 class="font-bold text-lg mb-3 flex items-center gap-2">
                     <i class="fas fa-star text-yellow-500"></i> Kitchen Trust
                     <span id="trust-display" class="bg-yellow-100 text-yellow-600 px-2 py-0.5 rounded-full text-xs">Trust Level: 1</span>
                 </h3>
                 <p class="text-xs text-gray-500 mb-2 italic">Complete quests to gain trust and improve cosmic drop rates!</p>
                 <div id="quests-container" class="grid grid-cols-1 gap-2 max-h-60 overflow-y-auto">
                     <!-- Quests inserted by JS -->
                 </div>
             </div>

             <!-- Daily & Play Time Rewards -->
             <div>
                 <h3 class="font-bold text-lg mb-3 flex items-center gap-2">
                     <i class="fas fa-gift text-green-500"></i> Rewards
                 </h3>
                 <div class="space-y-3">
                     <!-- Daily Rewards -->
                     <div class="bg-green-50 rounded-lg p-3 border-2 border-green-200">
                         <div class="flex items-center justify-between mb-2">
                             <h4 class="font-bold text-sm text-green-700">Daily Rewards</h4>
                             <span id="daily-reward-info" class="text-xs text-green-600">Loading...</span>
                         </div>
                         <button id="daily-reward-btn" onclick="claimDailyReward()" class="bg-green-500 hover:bg-green-600 text-white text-xs font-bold py-1 px-3 rounded-lg transition">
                             Claim Daily Reward
                         </button>
                     </div>

                     <!-- Play Time Rewards -->
                     <div class="bg-blue-50 rounded-lg p-3 border-2 border-blue-200">
                         <div class="flex items-center justify-between mb-2">
                             <h4 class="font-bold text-sm text-blue-700">Play Time Rewards</h4>
                             <span id="playtime-info" class="text-xs text-blue-600">Loading...</span>
                         </div>
                         <div class="text-xs text-blue-600">
                             Earn rewards for playing! Next reward in <span id="next-playtime">calculating...</span>
                         </div>
                     </div>
                 </div>
             </div>

             <!-- Achievements -->
             <div>
                  <h3 class="font-bold text-lg mb-3 flex items-center gap-2"><i class="fas fa-trophy text-yellow-500"></i> Achievements <span id="achievement-count" class="bg-yellow-100 text-yellow-600 px-2 py-0.5 rounded-full text-xs">0/22</span></h3>
                 <div id="achievements-container" class="grid grid-cols-2 gap-2 max-h-40 overflow-y-auto"></div>
             </div>
         </section>

         <!-- Right Panel -->
        <section class="flex-1 bg-white/50 backdrop-blur-sm border-l border-white/20 p-4 overflow-y-auto flex flex-col">
            <div class="flex justify-between items-center mb-4 gap-2 flex-wrap text-gray-800">
                <h3 class="font-bold text-lg flex items-center gap-2"><i class="fas fa-paw text-purple-500"></i> My Pets <span id="pet-count" class="bg-purple-100 text-purple-600 px-2 py-0.5 rounded-full text-xs">0</span></h3>
                <div class="flex gap-2">
                    <select id="sort-inventory" onchange="updateSortSetting(this.value)" class="bg-white border border-gray-300 text-gray-700 text-xs rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5">
                        <option value="rarity_desc">Rarity (High)</option>
                        <option value="rarity_asc">Rarity (Low)</option>
                        <option value="power_desc">Power (High)</option>
                        <option value="newest">Newest</option>
                        <option value="name">Name</option>
                    </select>
                    <button onclick="openMergeModal()" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded-full transition shadow-sm flex items-center gap-1"><i class="fas fa-random"></i> Merge</button>
                </div>
            </div>
            <div class="relative flex-1 overflow-y-auto pr-1">
                <div id="empty-inventory" class="text-center py-10 text-gray-400 italic">You have no pets yet. Buy an egg to start!</div>
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-3 lg:grid-cols-4 gap-3 content-start pb-4" id="inventory-container"></div>
            </div>
        </section>

    </main>

    <!-- Overlays -->
    <div id="kitchen-modal" class="fixed inset-0 bg-black/90 z-[80] hidden flex items-center justify-center backdrop-blur-sm p-4 text-gray-800">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg p-6 relative h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <div>
                    <h2 class="text-2xl font-bold text-green-600 flex items-center gap-2"><i class="fas fa-atom"></i> Kitchen Cosmos</h2>
                    <p class="text-xs text-gray-500">Mutate your pets... or destroy them.</p>
                </div>
                <button onclick="closeKitchenModal()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-2xl"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto bg-gray-50 rounded-lg p-4 mb-4">
                <div id="cosmos-grid" class="grid grid-cols-4 gap-3"></div>
                <div class="mt-4 text-xs text-gray-500">
                    <h4 class="font-bold text-gray-700">Mutation Chances (Per tick):</h4>
                    <div class="grid grid-cols-2 gap-x-4 gap-y-1 mt-1">
                        <div class="flex items-center gap-1"><div class="w-2 h-2 bg-yellow-400 rounded-full"></div> Gold (x2): 50%</div>
                        <div class="flex items-center gap-1"><div class="w-2 h-2 bg-gradient-to-r from-red-500 to-blue-500 rounded-full"></div> Rainbow (x4): 10%</div>
                        <div class="flex items-center gap-1"><div class="w-2 h-2 bg-black rounded-full"></div> Dark Matter (x10): 10%</div>
                        <div class="flex items-center gap-1"><div class="w-2 h-2 bg-green-500 rounded-full"></div> Radioactive: 5%</div>
                        <div class="flex items-center gap-1"><div class="w-2 h-2 bg-pink-400 rounded-full"></div> Revival: 1%</div>
                        <div class="flex items-center gap-1"><div class="w-2 h-2 bg-red-600 rounded-full"></div> Chaos (+25% Type): 4%</div>
                        <div class="flex items-center gap-1 col-span-2 font-bold text-red-600"><i class="fas fa-skull"></i> Destruction: 20% + Time</div>
                    </div>
                </div>
            </div>
            
            <div class="border-t pt-4">
                <h3 class="font-bold text-sm mb-2">Add from Inventory</h3>
                <div id="cosmos-inventory" class="flex gap-2 overflow-x-auto pb-2 h-20"></div>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="fixed inset-0 bg-black/90 z-[100] hidden flex items-center justify-center backdrop-blur-sm p-4 text-gray-800">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 relative">
            <button onclick="closeAdminModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            <h2 class="text-2xl font-bold mb-4 text-center text-red-600"><i class="fas fa-user-shield"></i> Admin Panel</h2>
            <div id="admin-login-view">
                <p class="text-sm text-gray-600 mb-4 text-center">Enter Access Code</p>
                <input type="password" id="admin-password-input" class="w-full border p-2 rounded mb-4 text-center text-xl tracking-widest text-gray-800" placeholder="----">
                <button onclick="checkAdminPassword()" class="w-full bg-red-600 text-white font-bold py-2 rounded hover:bg-red-700 transition">Unlock</button>
            </div>
            <div id="admin-dashboard-view" class="hidden space-y-4">
                <div class="bg-gray-100 p-3 rounded">
                    <label class="block text-xs font-bold text-gray-500 mb-1">ADD CASH</label>
                    <div class="flex gap-2">
                        <input type="number" id="admin-money-input" class="flex-1 border p-2 rounded text-sm text-gray-800" placeholder="Amount">
                        <button onclick="adminAddMoney()" class="bg-green-500 text-white px-3 rounded font-bold hover:bg-green-600">+</button>
                    </div>
                </div>
                <div class="bg-gray-100 p-3 rounded">
                    <label class="block text-xs font-bold text-gray-500 mb-1">GIVE PET</label>
                    <div class="flex gap-2">
                        <select id="admin-pet-select" class="flex-1 border p-2 rounded text-sm bg-white text-gray-800"></select>
                        <button onclick="adminAddPet()" class="bg-blue-500 text-white px-3 rounded font-bold hover:bg-blue-600">+</button>
                    </div>
                </div>
                <div class="bg-gray-100 p-3 rounded">
                    <label class="block text-xs font-bold text-gray-500 mb-1">SET REBIRTH LEVEL</label>
                    <div class="flex gap-2">
                        <input type="number" id="admin-rebirth-input" class="flex-1 border p-2 rounded text-sm text-gray-800" placeholder="Level (0-1000)">
                        <button onclick="adminSetRebirth()" class="bg-purple-600 text-white px-3 rounded font-bold hover:bg-purple-700">SET</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="hatch-overlay" class="fixed inset-0 bg-black/80 z-50 hidden flex flex-col items-center justify-center backdrop-blur-sm p-4 overflow-y-auto">
        <div class="relative flex flex-col items-center justify-center w-full min-h-[50vh]">
            <div id="hatch-egg-display" class="transition-all duration-300 cursor-pointer relative z-10"></div>
            <div id="hatch-rays" class="absolute inset-0 bg-yellow-400 rounded-full blur-3xl opacity-0 transition-opacity duration-500 -z-10 animate-pulse pointer-events-none"></div>
            <div id="hatch-message" class="text-white text-2xl font-bold mt-8 text-center h-8 z-20">Tap to Hatch!</div>
            <div id="new-pet-card" class="hidden transform transition-all duration-500 z-30">
                <div class="bg-white p-6 rounded-2xl shadow-2xl text-center w-64 border-4 text-gray-800" id="reveal-card-bg">
                    <div class="text-sm font-bold uppercase tracking-wider mb-2" id="reveal-rarity">Common</div>
                    <div class="text-8xl mb-4 pop-in" id="reveal-icon">üê•</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-1" id="reveal-name">Baby Chick</h2>
                    <div class="text-green-600 font-bold text-lg mb-4">+$<span id="reveal-rate">1</span>/s</div>
                    <button onclick="closeHatchModal()" class="bg-gray-800 text-white px-6 py-2 rounded-full font-bold hover:bg-gray-700 transition w-full">Awesome!</button>
                </div>
            </div>
            <div id="multi-pet-grid" class="hidden grid grid-cols-2 sm:grid-cols-3 gap-4 max-w-3xl w-full z-30 mt-4"></div>
            <button id="multi-hatch-close-btn" onclick="closeHatchModal()" class="hidden mt-8 bg-gray-800 text-white px-8 py-3 rounded-full font-bold hover:bg-gray-700 transition shadow-lg z-40 animate-bounce">Awesome!</button>
        </div>
    </div>

    <div id="egg-info-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden text-gray-800">
            <div id="egg-info-header" class="p-4 bg-gray-100 border-b flex justify-between items-center">
                <h2 class="font-bold text-xl flex items-center gap-2" id="egg-info-title">Egg Info</h2>
                <button onclick="closeEggInfo()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 max-h-[60vh] overflow-y-auto">
                <div id="egg-info-list" class="space-y-2"></div>
            </div>
            <div class="p-4 bg-gray-50 border-t text-center text-xs text-gray-500">Good luck!</div>
        </div>
    </div>

    <div id="merge-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[80vh] text-gray-800">
            <div class="p-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white flex justify-between items-center shrink-0">
                <div>
                    <h2 class="font-bold text-xl"><i class="fas fa-flask"></i> Merge Chamber</h2>
                    <p class="text-xs opacity-90">Fuse 3 identical pets to upgrade!</p>
                </div>
                <button onclick="closeMergeModal()" class="text-white/80 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 overflow-y-auto flex-1 bg-gray-50">
                <div id="merge-list" class="space-y-3"></div>
                <div id="no-merge-msg" class="hidden text-center py-8 text-gray-400">
                    <div class="text-4xl mb-2">üß¨</div>
                    <p>You need 3 of the same pet to merge.</p>
                </div>
            </div>
        </div>
    </div>

    <div id="index-modal" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[90vh] overflow-hidden flex flex-col text-gray-800">
            <div class="p-4 bg-blue-600 text-white flex justify-between items-center shrink-0">
                <div>
                    <h2 class="font-bold text-2xl flex items-center gap-2"><i class="fas fa-book-open"></i> Pet Index</h2>
                    <p class="text-sm opacity-90" id="index-progress-text">Collected: 0/0</p>
                </div>
                <button onclick="closeIndexModal()" class="text-white/80 hover:text-white text-2xl"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 bg-gray-100">
                <div id="index-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-6 gap-4"></div>
            </div>
            <div class="p-4 bg-white border-t flex flex-col sm:flex-row items-center justify-between gap-4">
                <div>
                    <h3 class="font-bold text-lg text-gray-800">Completion Reward</h3>
                    <p class="text-xs text-gray-500">Collect all standard pets to unlock the Guardian Griffin!</p>
                </div>
                <button id="claim-reward-btn" onclick="claimIndexReward()" disabled class="bg-gray-300 text-gray-500 font-bold py-3 px-8 rounded-full transition cursor-not-allowed flex items-center gap-2">
                    <span>Locked</span> <i class="fas fa-lock"></i>
                </button>
            </div>
        </div>
    </div>

    <div id="rebirth-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-gray-900 border border-purple-500 rounded-2xl shadow-2xl w-full max-w-md p-6 text-center text-white relative overflow-hidden">
            <div class="absolute inset-0 bg-purple-600 opacity-10 animate-pulse pointer-events-none"></div>
            <div class="relative z-10">
                <div class="text-5xl mb-4">üåÄ</div>
                <h2 class="text-3xl font-bold mb-2 text-purple-300">Rebirth</h2>
                <div id="rebirth-info" class="mb-6">
                    <p class="text-gray-300 mb-2">Current Multiplier: <span id="rebirth-current-mult" class="text-green-400 font-bold">x1</span></p>
                    <p class="text-gray-300 mb-4">Rebirth Level: <span id="rebirth-current-level" class="text-blue-400 font-bold">0</span></p>
                    <div class="bg-gray-800 rounded-lg p-4 border border-gray-700">
                        <div class="text-sm font-bold uppercase text-gray-500 mb-2">Next Rebirth Requirements</div>
                        <div id="rebirth-reqs" class="text-xl font-bold flex justify-center items-center gap-2 mb-2"></div>
                        <div class="text-xs text-gray-400 italic">Sacrifice these pets to ascend.</div>
                        <div class="mt-3 pt-3 border-t border-gray-700">
                            <div class="text-sm">New Multiplier: <span id="rebirth-next-mult" class="text-purple-400 font-bold text-lg">x1.5</span></div>
                            <div class="text-sm text-yellow-300 mt-1" id="rebirth-unlock-msg"></div>
                        </div>
                    </div>
                </div>
                <p class="text-red-400 text-xs mb-6">Warning: Rebirthing resets your Money, Inventory, and Upgrades. Achievements and Index are saved.</p>
                <div class="flex gap-3 justify-center">
                    <button onclick="closeRebirthModal()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full transition">Cancel</button>
                    <button onclick="performRebirth()" id="rebirth-confirm-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-8 rounded-full transition shadow-lg shadow-purple-500/30 disabled:opacity-50 disabled:cursor-not-allowed">Rebirth</button>
                </div>
            </div>
        </div>
    </div>

    <div id="reset-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center text-gray-800">
            <div class="text-red-500 text-5xl mb-4"><i class="fas fa-exclamation-triangle"></i></div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Reset Account?</h2>
            <p class="text-gray-600 mb-6">Are you sure you want to wipe all your progress? This cannot be undone.</p>
            <div class="flex gap-3 justify-center">
                <button onclick="closeResetModal()" class="bg-gray-200 text-gray-700 font-bold py-2 px-6 rounded-full hover:bg-gray-300 transition">Cancel</button>
                <button onclick="confirmReset()" class="bg-red-500 text-white font-bold py-2 px-6 rounded-full hover:bg-red-600 transition">Reset</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-[60] text-sm font-bold text-center">Notification</div>
    <div id="pet-tooltip" class="fixed bg-white rounded-lg shadow-xl border-2 border-gray-200 p-3 opacity-0 transition-opacity duration-200 pointer-events-none z-[70] text-sm max-w-xs text-gray-800"><div id="pet-tooltip-content"></div></div>

    <script>
        // --- DATA ---
        const GALAXIES = [
            { id: 'origin', name: 'Origin System', icon: 'üåå', minRebirth: 0, worlds: ['home', 'spooky', 'jurassic', 'frozen', 'magic'] },
            { id: 'astral', name: 'Astral Sector', icon: 'ü™ê', minRebirth: 5, worlds: ['space', 'divine', 'cyber', 'volcano'] },
            { id: 'mystic', name: 'Mystic Reach', icon: '‚ú®', minRebirth: 11, worlds: ['candy', 'atlantis', 'shadow', 'celestial'] },
            { id: 'chickverse', name: 'Chickverse', icon: 'üê£', minRebirth: 20, worlds: ['gold', 'rainbow', 'mecha', 'darkmatter'] },
            { id: 'apocalypse', name: 'Apocalypse', icon: '‚ò¢Ô∏è', minRebirth: 2, worlds: ['radioactive'] },
            { id: 'nebulon', name: 'Nebulon Cluster', icon: 'üå†', minRebirth: 30, worlds: ['nebula', 'cosmic', 'quantum', 'singularity'] },
            { id: 'chronoverse', name: 'Chronoverse', icon: '‚è∞', minRebirth: 40, worlds: ['temporal', 'ether', 'infinity', 'paradox'] },
            { id: 'elementia', name: 'Elementia', icon: 'üî•', minRebirth: 50, worlds: ['elemental', 'volcano', 'eclipse', 'dreamscape'] },
            { id: 'mechanica', name: 'Mechanica', icon: '‚öôÔ∏è', minRebirth: 60, worlds: ['machinery', 'cyber', 'steampunk', 'digital'] },
            { id: 'celebrantia', name: 'Celebrantia', icon: 'üéâ', minRebirth: 70, worlds: ['celebration', 'candy', 'spectrum', 'festival'] },
            { id: 'gemworld', name: 'Gemworld', icon: 'üíé', minRebirth: 80, worlds: ['gemstone', 'treasury', 'divine', 'ultimate_cosmos'] }
        ];

        const WORLDS = [
            { id: 'home', name: 'Home Village', minRebirth: 0, bgClass: 'bg-world-home', eggIds: ['starter', 'farm', 'aqua', 'desert'] },
            { id: 'spooky', name: 'Haunted Forest', minRebirth: 1, bgClass: 'bg-world-spooky', eggIds: ['spooky', 'forest'] },
            { id: 'jurassic', name: 'Jurassic Isle', minRebirth: 2, bgClass: 'bg-world-jurassic', eggIds: ['prehistoric', 'jungle'] },
            { id: 'frozen', name: 'Frozen Tundra', minRebirth: 3, bgClass: 'bg-world-frozen', eggIds: ['arctic'] },
            { id: 'magic', name: 'Magic Realm', minRebirth: 4, bgClass: 'bg-world-magic', eggIds: ['fantasy', 'mystery'] },
            { id: 'space', name: 'Deep Space', minRebirth: 5, bgClass: 'bg-world-space', eggIds: ['cosmic', 'void'] },
            { id: 'divine', name: 'Divine Plane', minRebirth: 6, bgClass: 'bg-world-divine', eggIds: ['divine'] },
            { id: 'cyber', name: 'Cyber City', minRebirth: 9, bgClass: 'bg-world-cyber', eggIds: ['cyber'] },
            { id: 'volcano', name: 'Volcanic Core', minRebirth: 10, bgClass: 'bg-world-volcano', eggIds: ['magma'] },
            { id: 'candy', name: 'Candy Land', minRebirth: 11, bgClass: 'bg-world-candy', eggIds: ['sugar'] },
            { id: 'atlantis', name: 'Atlantis', minRebirth: 12, bgClass: 'bg-world-atlantis', eggIds: ['abyssal'] },
            { id: 'shadow', name: 'Shadow Realm', minRebirth: 13, bgClass: 'bg-world-shadow', eggIds: ['eclipse'] },
            { id: 'celestial', name: 'Celestial Haven', minRebirth: 14, bgClass: 'bg-world-celestial', eggIds: ['ether', 'infinity'] },
            { id: 'gold', name: 'Gilded Coop', minRebirth: 20, bgClass: 'bg-world-gold', eggIds: ['treasury'] },
            { id: 'rainbow', name: 'Prismatic Fields', minRebirth: 25, bgClass: 'bg-world-rainbow', eggIds: ['spectrum'] },
            { id: 'mecha', name: 'Mecha Base', minRebirth: 30, bgClass: 'bg-world-mecha', eggIds: ['machinery'] },
            { id: 'darkmatter', name: 'Void Nexus', minRebirth: 35, bgClass: 'bg-world-darkmatter', eggIds: ['singularity'] },
            { id: 'radioactive', name: 'Radioactive Wasteland', minRebirth: 0, bgClass: 'bg-world-radioactive', eggIds: ['toxic'], hidden: true },

            // New Galaxy Worlds
            { id: 'nebula', name: 'Nebula Fields', minRebirth: 30, bgClass: 'bg-world-nebula', eggIds: ['celestial', 'legendary'] },
            { id: 'cosmic', name: 'Cosmic Abyss', minRebirth: 32, bgClass: 'bg-world-cosmic', eggIds: ['ultimate', 'ultimate_cosmos'] },
            { id: 'quantum', name: 'Quantum Realm', minRebirth: 34, bgClass: 'bg-world-quantum', eggIds: ['quantum'] },
            { id: 'singularity', name: 'Singularity Core', minRebirth: 36, bgClass: 'bg-world-singularity', eggIds: ['singularity'] },
            { id: 'temporal', name: 'Time Streams', minRebirth: 40, bgClass: 'bg-world-temporal', eggIds: ['temporal'] },
            { id: 'ether', name: 'Ether Planes', minRebirth: 42, bgClass: 'bg-world-ether', eggIds: ['ether'] },
            { id: 'infinity', name: 'Infinite Loop', minRebirth: 44, bgClass: 'bg-world-infinity', eggIds: ['infinity'] },
            { id: 'paradox', name: 'Paradox Zone', minRebirth: 46, bgClass: 'bg-world-paradox', eggIds: ['paradox'] },
            { id: 'elemental', name: 'Elemental Chaos', minRebirth: 50, bgClass: 'bg-world-elemental', eggIds: ['elemental'] },
            { id: 'volcano', name: 'Volcanic Core', minRebirth: 52, bgClass: 'bg-world-volcano', eggIds: ['volcano'] },
            { id: 'eclipse', name: 'Eclipse Veil', minRebirth: 54, bgClass: 'bg-world-eclipse', eggIds: ['eclipse'] },
            { id: 'dreamscape', name: 'Dreamscape', minRebirth: 56, bgClass: 'bg-world-dreamscape', eggIds: ['dreamscape'] },
            { id: 'machinery', name: 'Mecha Base', minRebirth: 60, bgClass: 'bg-world-machinery', eggIds: ['machinery'] },
            { id: 'cyber', name: 'Cyber City', minRebirth: 62, bgClass: 'bg-world-cyber', eggIds: ['cyber'] },
            { id: 'steampunk', name: 'Steamworks', minRebirth: 64, bgClass: 'bg-world-steampunk', eggIds: ['steampunk'] },
            { id: 'digital', name: 'Digital Matrix', minRebirth: 66, bgClass: 'bg-world-digital', eggIds: ['digital'] },
            { id: 'celebration', name: 'Festival Grounds', minRebirth: 70, bgClass: 'bg-world-celebration', eggIds: ['celebration'] },
            { id: 'candy', name: 'Candy Land', minRebirth: 72, bgClass: 'bg-world-candy', eggIds: ['sugar'] },
            { id: 'spectrum', name: 'Prismatic Fields', minRebirth: 74, bgClass: 'bg-world-spectrum', eggIds: ['spectrum'] },
            { id: 'festival', name: 'Eternal Festival', minRebirth: 76, bgClass: 'bg-world-festival', eggIds: ['celebration'] },
            { id: 'gemstone', name: 'Crystal Caverns', minRebirth: 80, bgClass: 'bg-world-gemstone', eggIds: ['gemstone'] },
            { id: 'treasury', name: 'Gilded Coop', minRebirth: 82, bgClass: 'bg-world-treasury', eggIds: ['treasury'] },
            { id: 'divine', name: 'Divine Plane', minRebirth: 84, bgClass: 'bg-world-divine', eggIds: ['divine'] },
            { id: 'ultimate_cosmos', name: 'Ultimate Cosmos', minRebirth: 86, bgClass: 'bg-world-ultimate', eggIds: ['ultimate_cosmos'] }
        ];

        const PETS = {
            'ant': { id: 'ant', name: 'Worker Ant', icon: 'üêú', rate: 1, rarity: 'Common', next: 'chick' },
            'chick': { id: 'chick', name: 'Baby Chick', icon: 'üê•', rate: 2, rarity: 'Common', next: 'mouse' },
            'mouse': { id: 'mouse', name: 'Field Mouse', icon: 'üêÅ', rate: 3, rarity: 'Common', next: 'fish' },
            'fish': { id: 'fish', name: 'Goldfish', icon: 'üê†', rate: 5, rarity: 'Common', next: 'beetle' },
            'beetle': { id: 'beetle', name: 'Beetle', icon: 'üêû', rate: 8, rarity: 'Common', next: 'spider' },
            'spider': { id: 'spider', name: 'Spider', icon: 'üï∑Ô∏è', rate: 12, rarity: 'Common', next: 'bee' },
            'bee': { id: 'bee', name: 'Honey Bee', icon: 'üêù', rate: 16, rarity: 'Common', next: 'cat' },
            'cat': { id: 'cat', name: 'Stray Cat', icon: 'üêà', rate: 20, rarity: 'Uncommon', next: 'dog' },
            'dog': { id: 'dog', name: 'Good Boy', icon: 'üêï', rate: 30, rarity: 'Uncommon', next: 'pig' },
            'pig': { id: 'pig', name: 'Piggy', icon: 'üêñ', rate: 45, rarity: 'Uncommon', next: 'sheep' },
            'sheep': { id: 'sheep', name: 'Sheep', icon: 'üêë', rate: 60, rarity: 'Uncommon', next: 'snake' },
            'snake': { id: 'snake', name: 'Snake', icon: 'üêç', rate: 80, rarity: 'Uncommon', next: 'crab' },
            'crab': { id: 'crab', name: 'Crab', icon: 'ü¶Ä', rate: 100, rarity: 'Uncommon', next: 'frog' },
            'frog': { id: 'frog', name: 'Frog', icon: 'üê∏', rate: 125, rarity: 'Uncommon', next: 'fox' },
            'fox': { id: 'fox', name: 'Sly Fox', icon: 'ü¶ä', rate: 150, rarity: 'Rare', next: 'monkey' },
            'monkey': { id: 'monkey', name: 'Monkey', icon: 'üêí', rate: 200, rarity: 'Rare', next: 'penguin' },
            'penguin': { id: 'penguin', name: 'Penguin', icon: 'üêß', rate: 300, rarity: 'Rare', next: 'owl' },
            'owl': { id: 'owl', name: 'Wise Owl', icon: 'ü¶â', rate: 400, rarity: 'Rare', next: 'camel' },
            'camel': { id: 'camel', name: 'Camel', icon: 'üê´', rate: 500, rarity: 'Rare', next: 'turtle' },
            'turtle': { id: 'turtle', name: 'Turtle', icon: 'üê¢', rate: 650, rarity: 'Rare', next: 'wolf' },
            'wolf': { id: 'wolf', name: 'Wolf', icon: 'üê∫', rate: 800, rarity: 'Rare', next: 'vulture' },
            'vulture': { id: 'vulture', name: 'Vulture', icon: 'ü¶Ö', rate: 1000, rarity: 'Rare', next: 't-rex' },
            't-rex': { id: 't-rex', name: 'T-Rex', icon: 'ü¶ñ', rate: 1500, rarity: 'Epic', next: 'shark' },
            'shark': { id: 'shark', name: 'Great White', icon: 'ü¶à', rate: 1800, rarity: 'Epic', next: 'alien' },
            'alien': { id: 'alien', name: 'Martian', icon: 'üëΩ', rate: 2100, rarity: 'Epic', next: 'robot' },
            'robot': { id: 'robot', name: 'Bot-X', icon: 'ü§ñ', rate: 2500, rarity: 'Epic', next: 'tiger' },
            'tiger': { id: 'tiger', name: 'Bengal Tiger', icon: 'üêÖ', rate: 2900, rarity: 'Epic', next: 'bear' },
            'bear': { id: 'bear', name: 'Grizzly', icon: 'üêª', rate: 3300, rarity: 'Epic', next: 'triceratops' },
            'triceratops': { id: 'triceratops', name: 'Triceratops', icon: 'ü¶ï', rate: 3700, rarity: 'Epic', next: 'pterodactyl' },
            'pterodactyl': { id: 'pterodactyl', name: 'Pterodactyl', icon: 'ü¶á', rate: 4100, rarity: 'Epic', next: 'skeleton' },
            'skeleton': { id: 'skeleton', name: 'Skeleton', icon: 'üíÄ', rate: 4500, rarity: 'Epic', next: 'unicorn' },
            'unicorn': { id: 'unicorn', name: 'Unicorn', icon: 'ü¶Ñ', rate: 5000, rarity: 'Legendary', next: 'dragon' },
            'dragon': { id: 'dragon', name: 'Red Dragon', icon: 'üêâ', rate: 6000, rarity: 'Legendary', next: 'yeti' },
            'yeti': { id: 'yeti', name: 'Abominable', icon: 'ü¶ç', rate: 7500, rarity: 'Legendary', next: 'mammoth' },
            'mammoth': { id: 'mammoth', name: 'Mammoth', icon: 'ü¶£', rate: 10000, rarity: 'Legendary', next: 'reaper' },
            'reaper': { id: 'reaper', name: 'Grim Reaper', icon: 'üïØÔ∏è', rate: 15000, rarity: 'Legendary', next: 'griffin' },
            'griffin': { id: 'griffin', name: 'Chimera', icon: 'ü¶Å', rate: 25000, rarity: 'Legendary', next: 'phoenix' },
            'phoenix': { id: 'phoenix', name: 'Phoenix', icon: 'üî•', rate: 50000, rarity: 'Mythical', next: 'kraken' },
            'kraken': { id: 'kraken', name: 'The Kraken', icon: 'üêô', rate: 100000, rarity: 'Mythical', next: 'hydra' },
            'hydra': { id: 'hydra', name: 'Hydra', icon: 'üêç', rate: 250000, rarity: 'Mythical', next: 'titan' },
            'titan': { id: 'titan', name: 'Titan', icon: 'üóø', rate: 500000, rarity: 'Mythical', next: 'void' },
            'void': { id: 'void', name: 'The Void', icon: 'üåå', rate: 1000000, rarity: 'Godly', next: 'cosmos' },
            'cosmos': { id: 'cosmos', name: 'The Cosmos', icon: 'üåå', rate: 5000000, rarity: 'Transcendent', next: 'nebula' },
            'nebula': { id: 'nebula', name: 'Nebula', icon: 'üå†', rate: 25000000, rarity: 'Cosmic', next: 'star' },
            'star': { id: 'star', name: 'Living Star', icon: '‚≠ê', rate: 100000000, rarity: 'Cosmic', next: null },
            'cyborg': { id: 'cyborg', name: 'Cyborg', icon: 'ü§ñ', rate: 25000000, rarity: 'Godly', next: 'magma_lord' },
            'magma_lord': { id: 'magma_lord', name: 'Magma Lord', icon: 'üëπ', rate: 100000000, rarity: 'Godly', next: 'candy_king' },
            'candy_king': { id: 'candy_king', name: 'Candy King', icon: 'üç¨', rate: 500000000, rarity: 'Godly', next: 'leviathan' },
            'leviathan': { id: 'leviathan', name: 'Leviathan', icon: 'üêã', rate: 2000000000, rarity: 'Transcendent', next: 'nightmare' },
            'nightmare': { id: 'nightmare', name: 'Nightmare', icon: 'üåö', rate: 10000000000, rarity: 'Transcendent', next: 'archangel' },
            'archangel': { id: 'archangel', name: 'Archangel', icon: 'üëº', rate: 50000000000, rarity: 'Transcendent', next: 'chronos' },
            'chronos': { id: 'chronos', name: 'Chronos', icon: '‚è≥', rate: 250000000000, rarity: 'Eternal', next: 'golden_chick' },
            'drone': { id: 'drone', name: 'Drone', icon: 'üöÅ', rate: 150000, rarity: 'Epic', next: 'cyborg' },
            'magma_golem': { id: 'magma_golem', name: 'Magma Golem', icon: 'üåã', rate: 2000000, rarity: 'Legendary', next: 'magma_lord' },
            'gummy_bear': { id: 'gummy_bear', name: 'Gummy Bear', icon: 'üß∏', rate: 5000, rarity: 'Rare', next: 'candy_king' },
            'mermaid': { id: 'mermaid', name: 'Mermaid', icon: 'üßú‚Äç‚ôÄÔ∏è', rate: 5000000, rarity: 'Legendary', next: 'leviathan' },
            'wraith': { id: 'wraith', name: 'Wraith', icon: 'üëª', rate: 8000000, rarity: 'Legendary', next: 'nightmare' },
            'cherub': { id: 'cherub', name: 'Cherub', icon: 'üèπ', rate: 12000000, rarity: 'Mythical', next: 'archangel' },
            'golden_chick': { id: 'golden_chick', name: 'Golden Chick', icon: 'üèÜ', rate: 1000000000000, rarity: 'Legendary', next: 'rainbow_chick' },
            'rainbow_chick': { id: 'rainbow_chick', name: 'Rainbow Chick', icon: 'üåà', rate: 5000000000000, rarity: 'Mythical', next: 'mecha_chick' },
            'mecha_chick': { id: 'mecha_chick', name: 'Mecha Chick', icon: 'ü§ñ', rate: 25000000000000, rarity: 'Godly', next: 'darkmatter_chick' },
            'darkmatter_chick': { id: 'darkmatter_chick', name: 'Dark Matter Chick', icon: 'üåë', rate: 100000000000000, rarity: 'Transcendent', next: null },
            'reward_griffin': { id: 'reward_griffin', name: 'Guardian Griffin', icon: 'ü¶Ö', rate: 0, rarity: 'Special', next: null, hidden: false },

            // New world pets
            'drone': { id: 'drone', name: 'Attack Drone', icon: 'üöÅ', rate: 80000, rarity: 'Epic', next: 'cyborg' },
            'cyborg': { id: 'cyborg', name: 'Cyborg', icon: 'ü§ñ', rate: 120000, rarity: 'Epic', next: 'robot' },
            'magma_golem': { id: 'magma_golem', name: 'Magma Golem', icon: 'ü™®', rate: 150000, rarity: 'Epic', next: 'magma_lord' },
            'magma_lord': { id: 'magma_lord', name: 'Magma Lord', icon: 'üåã', rate: 250000, rarity: 'Legendary', next: 'dragon' },
            'gummy_bear': { id: 'gummy_bear', name: 'Gummy Bear', icon: 'üç¨', rate: 300000, rarity: 'Legendary', next: 'candy_king' },
            'candy_king': { id: 'candy_king', name: 'Candy King', icon: 'üëë', rate: 500000, rarity: 'Mythical', next: 'unicorn' },
            'mermaid': { id: 'mermaid', name: 'Mermaid', icon: 'üßú', rate: 400000, rarity: 'Mythical', next: 'leviathan' },
            'leviathan': { id: 'leviathan', name: 'Leviathan', icon: 'üêã', rate: 750000, rarity: 'Mythical', next: 'kraken' },
            'wraith': { id: 'wraith', name: 'Wraith', icon: 'üëª', rate: 600000, rarity: 'Mythical', next: 'nightmare' },
            'nightmare': { id: 'nightmare', name: 'Nightmare', icon: 'ü¶Ñ', rate: 1000000, rarity: 'Godly', next: 'void' },
            'cherub': { id: 'cherub', name: 'Cherub', icon: 'üëº', rate: 1500000, rarity: 'Godly', next: 'archangel' },
            'archangel': { id: 'archangel', name: 'Archangel', icon: 'üòá', rate: 2500000, rarity: 'Transcendent', next: 'cosmos' },
            'chronos': { id: 'chronos', name: 'Chronos', icon: '‚è∞', rate: 5000000, rarity: 'Transcendent', next: 'nebula' },
            'golden_chick': { id: 'golden_chick', name: 'Golden Chick', icon: 'üêî', rate: 10000000, rarity: 'Special', next: null, hidden: false },
            'rainbow_chick': { id: 'rainbow_chick', name: 'Rainbow Chick', icon: 'üåà', rate: 25000000, rarity: 'Special', next: null, hidden: false },
            'mecha_chick': { id: 'mecha_chick', name: 'Mecha Chick', icon: 'ü§ñ', rate: 50000000, rarity: 'Special', next: null, hidden: false },

            // Additional pets for more variety
            'dragon': { id: 'dragon', name: 'Dragon', icon: 'üêâ', rate: 15000, rarity: 'Legendary', next: 'yeti' },
            'yeti': { id: 'yeti', name: 'Yeti', icon: 'ü¶ç', rate: 20000, rarity: 'Legendary', next: 'mammoth' },
            'mammoth': { id: 'mammoth', name: 'Mammoth', icon: 'ü¶£', rate: 30000, rarity: 'Legendary', next: 'reaper' },
            'reaper': { id: 'reaper', name: 'Grim Reaper', icon: 'üïØÔ∏è', rate: 50000, rarity: 'Legendary', next: 'griffin' },
            'griffin': { id: 'griffin', name: 'Griffin', icon: 'ü¶Ö', rate: 75000, rarity: 'Legendary', next: null },
            
            // Radioactive Pets
            'roach': { id: 'roach', name: 'Rad-Roach', icon: 'ü™≥', rate: 500000, rarity: 'Common', next: 'slime' },
            'slime': { id: 'slime', name: 'Mutant Slime', icon: 'ü¶†', rate: 2500000, rarity: 'Rare', next: 'hazmat' },
            'hazmat': { id: 'hazmat', name: 'Toxic Beast', icon: 'üßü', rate: 15000000, rarity: 'Epic', next: 'godzilla' },
            'godzilla': { id: 'godzilla', name: 'Kaiju', icon: 'ü¶ñ', rate: 1000000000, rarity: 'Mythical', next: null },

            // Ocean/Sea Pets
            'dolphin': { id: 'dolphin', name: 'Dolphin', icon: 'üê¨', rate: 800000, rarity: 'Rare', next: 'shark' },
            'octopus': { id: 'octopus', name: 'Octopus', icon: 'üêô', rate: 1200000, rarity: 'Epic', next: 'whale' },
            'whale': { id: 'whale', name: 'Blue Whale', icon: 'üêã', rate: 2000000, rarity: 'Epic', next: 'leviathan' },
            'seahorse': { id: 'seahorse', name: 'Sea Horse', icon: 'ü™º', rate: 1500000, rarity: 'Rare', next: 'jellyfish' },
            'jellyfish': { id: 'jellyfish', name: 'Jellyfish', icon: 'ü™º', rate: 2500000, rarity: 'Epic', next: 'kraken' },

            // Forest/Woodland Pets
            'deer': { id: 'deer', name: 'Deer', icon: 'ü¶å', rate: 900000, rarity: 'Rare', next: 'bear' },
            'raccoon': { id: 'raccoon', name: 'Raccoon', icon: 'ü¶ù', rate: 1100000, rarity: 'Rare', next: 'wolf' },
            'squirrel': { id: 'squirrel', name: 'Squirrel', icon: 'üêøÔ∏è', rate: 700000, rarity: 'Common', next: 'fox' },
            'owl': { id: 'owl', name: 'Owl', icon: 'ü¶â', rate: 1300000, rarity: 'Rare', next: 'eagle' },
            'eagle': { id: 'eagle', name: 'Eagle', icon: 'ü¶Ö', rate: 1800000, rarity: 'Epic', next: 'griffin' },

            // Desert/Ancient Pets
            'camel': { id: 'camel', name: 'Camel', icon: 'üê™', rate: 1000000, rarity: 'Rare', next: 'scorpion' },
            'scorpion': { id: 'scorpion', name: 'Scorpion', icon: 'ü¶Ç', rate: 1400000, rarity: 'Rare', next: 'sphinx' },
            'sphinx': { id: 'sphinx', name: 'Sphinx', icon: 'ü¶Å', rate: 2200000, rarity: 'Epic', next: 'pharaoh' },
            'pharaoh': { id: 'pharaoh', name: 'Pharaoh Cat', icon: 'üê±', rate: 3500000, rarity: 'Legendary', next: 'anubis' },
            'anubis': { id: 'anubis', name: 'Anubis', icon: 'üê∫', rate: 6000000, rarity: 'Legendary', next: 'titan' },

            // Industrial/Tech Pets
            'robot': { id: 'robot', name: 'Robot', icon: 'ü§ñ', rate: 1600000, rarity: 'Epic', next: 'android' },
            'android': { id: 'android', name: 'Android', icon: 'üì±', rate: 2800000, rarity: 'Epic', next: 'cyborg' },
            'drone': { id: 'drone', name: 'Drone', icon: 'üöÅ', rate: 3200000, rarity: 'Epic', next: 'mech' },
            'mech': { id: 'mech', name: 'Mech Suit', icon: 'ü§ñ', rate: 5000000, rarity: 'Legendary', next: 'ai' },
            'ai': { id: 'ai', name: 'AI Core', icon: 'üß†', rate: 8000000, rarity: 'Legendary', next: 'cosmos' },

            // Magical/Fantasy Pets
            'fairy': { id: 'fairy', name: 'Fairy', icon: 'üßö', rate: 1700000, rarity: 'Epic', next: 'elf' },
            'elf': { id: 'elf', name: 'Elf', icon: 'üßù', rate: 2600000, rarity: 'Epic', next: 'wizard' },
            'wizard': { id: 'wizard', name: 'Wizard', icon: 'üßô', rate: 4000000, rarity: 'Legendary', next: 'dragon' },
            'pegasus': { id: 'pegasus', name: 'Pegasus', icon: 'ü¶Ñ', rate: 5500000, rarity: 'Legendary', next: 'phoenix' },
            'centaur': { id: 'centaur', name: 'Centaur', icon: 'ü¶Ñ', rate: 7500000, rarity: 'Mythical', next: 'titan' },

            // Holiday/Seasonal Pets
            'snowman': { id: 'snowman', name: 'Snowman', icon: '‚õÑ', rate: 1900000, rarity: 'Rare', next: 'reindeer' },
            'reindeer': { id: 'reindeer', name: 'Reindeer', icon: 'ü¶å', rate: 2900000, rarity: 'Epic', next: 'santa' },
            'santa': { id: 'santa', name: 'Santa', icon: 'üéÖ', rate: 4500000, rarity: 'Legendary', next: 'snowflake' },
            'snowflake': { id: 'snowflake', name: 'Snowflake', icon: '‚ùÑÔ∏è', rate: 7000000, rarity: 'Mythical', next: 'north_pole' },
            'north_pole': { id: 'north_pole', name: 'North Pole', icon: 'üèîÔ∏è', rate: 12000000, rarity: 'Mythical', next: null },

            // Food/Candy Pets
            'cookie': { id: 'cookie', name: 'Cookie', icon: 'üç™', rate: 2100000, rarity: 'Rare', next: 'cake' },
            'cake': { id: 'cake', name: 'Cake', icon: 'üç∞', rate: 3100000, rarity: 'Epic', next: 'ice_cream' },
            'ice_cream': { id: 'ice_cream', name: 'Ice Cream', icon: 'üç¶', rate: 4800000, rarity: 'Legendary', next: 'lollipop' },
            'lollipop': { id: 'lollipop', name: 'Lollipop', icon: 'üç≠', rate: 7200000, rarity: 'Legendary', next: 'candy_cane' },
            'candy_cane': { id: 'candy_cane', name: 'Candy Cane', icon: 'üç¨', rate: 11000000, rarity: 'Mythical', next: 'gingerbread' },
            'gingerbread': { id: 'gingerbread', name: 'Gingerbread', icon: 'üè†', rate: 18000000, rarity: 'Mythical', next: null },

            // Mythical Creatures
            'minotaur': { id: 'minotaur', name: 'Minotaur', icon: 'üêÇ', rate: 2300000, rarity: 'Epic', next: 'cyclops' },
            'cyclops': { id: 'cyclops', name: 'Cyclops', icon: 'üëÅÔ∏è', rate: 3400000, rarity: 'Legendary', next: 'hydra' },
            'manticore': { id: 'manticore', name: 'Manticore', icon: 'ü¶Å', rate: 5100000, rarity: 'Legendary', next: 'behemoth' },
            'behemoth': { id: 'behemoth', name: 'Behemoth', icon: 'üêò', rate: 7800000, rarity: 'Mythical', next: 'leviathan' },
            'chimera': { id: 'chimera', name: 'Chimera', icon: 'üêâ', rate: 12500000, rarity: 'Mythical', next: 'titan' },

            // Space/Alien Pets
            'ufo': { id: 'ufo', name: 'UFO', icon: 'üõ∏', rate: 2400000, rarity: 'Epic', next: 'martian' },
            'martian': { id: 'martian', name: 'Martian', icon: 'üëΩ', rate: 3600000, rarity: 'Legendary', next: 'alien' },
            'astronaut': { id: 'astronaut', name: 'Astronaut', icon: 'üë®‚ÄçüöÄ', rate: 5400000, rarity: 'Legendary', next: 'satellite' },
            'satellite': { id: 'satellite', name: 'Satellite', icon: 'üõ∞Ô∏è', rate: 8200000, rarity: 'Mythical', next: 'nebula' },
            'comet': { id: 'comet', name: 'Comet', icon: '‚òÑÔ∏è', rate: 13000000, rarity: 'Mythical', next: 'star' },

            // Time/Dimensional Pets
            'hourglass': { id: 'hourglass', name: 'Hourglass', icon: '‚è≥', rate: 2500000, rarity: 'Epic', next: 'clock' },
            'clock': { id: 'clock', name: 'Clock', icon: 'üïê', rate: 3700000, rarity: 'Legendary', next: 'chronos' },
            'portal': { id: 'portal', name: 'Portal', icon: 'üåÄ', rate: 5600000, rarity: 'Legendary', next: 'void' },
            'dimension': { id: 'dimension', name: 'Dimension', icon: 'üåå', rate: 8500000, rarity: 'Mythical', next: 'cosmos' },
            'eternity': { id: 'eternity', name: 'Eternity', icon: '‚ôæÔ∏è', rate: 13500000, rarity: 'Transcendent', next: 'void_lord' },

            // Ultra Rare/Transcendent Pets
            'void_lord': { id: 'void_lord', name: 'Void Lord', icon: 'üåë', rate: 50000000, rarity: 'Transcendent', next: 'cosmic_titan' },
            'cosmic_titan': { id: 'cosmic_titan', name: 'Cosmic Titan', icon: 'üí´', rate: 200000000, rarity: 'Transcendent', next: 'reality_weaver' },
            'reality_weaver': { id: 'reality_weaver', name: 'Reality Weaver', icon: 'üåÄ', rate: 1000000000, rarity: 'Transcendent', next: null },

            // Digital/Cyber Pets
            'pixel': { id: 'pixel', name: 'Pixel', icon: 'üî≥', rate: 25000000, rarity: 'Epic', next: 'byte' },
            'byte': { id: 'byte', name: 'Byte', icon: 'üíæ', rate: 75000000, rarity: 'Legendary', next: 'data' },
            'data': { id: 'data', name: 'Data Stream', icon: 'üåä', rate: 250000000, rarity: 'Mythical', next: 'algorithm' },
            'algorithm': { id: 'algorithm', name: 'Algorithm', icon: 'üßÆ', rate: 1000000000, rarity: 'Transcendent', next: null },

            // Nature/Elemental Pets
            'breeze': { id: 'breeze', name: 'Gentle Breeze', icon: 'üí®', rate: 30000000, rarity: 'Rare', next: 'storm' },
            'storm': { id: 'storm', name: 'Thunder Storm', icon: '‚õàÔ∏è', rate: 90000000, rarity: 'Epic', next: 'earthquake' },
            'earthquake': { id: 'earthquake', name: 'Earthquake', icon: 'üåã', rate: 300000000, rarity: 'Legendary', next: 'volcano' },
            'volcano': { id: 'volcano', name: 'Living Volcano', icon: 'üåã', rate: 1200000000, rarity: 'Mythical', next: null },

            // Time/Space Pets
            'moment': { id: 'moment', name: 'Frozen Moment', icon: 'üï∞Ô∏è', rate: 35000000, rarity: 'Epic', next: 'era' },
            'era': { id: 'era', name: 'Ancient Era', icon: 'üìú', rate: 110000000, rarity: 'Legendary', next: 'dimension' },
            'dimension': { id: 'dimension', name: 'Pocket Dimension', icon: 'üîÆ', rate: 400000000, rarity: 'Mythical', next: 'multiverse' },
            'multiverse': { id: 'multiverse', name: 'Multiverse', icon: 'üåå', rate: 1500000000, rarity: 'Transcendent', next: null },

            // Holiday/Event Pets
            'firework': { id: 'firework', name: 'Firework', icon: 'üéÜ', rate: 40000000, rarity: 'Epic', next: 'lantern' },
            'lantern': { id: 'lantern', name: 'Festival Lantern', icon: 'üèÆ', rate: 125000000, rarity: 'Legendary', next: 'dragon_dance' },
            'dragon_dance': { id: 'dragon_dance', name: 'Dragon Dance', icon: 'üê≤', rate: 450000000, rarity: 'Mythical', next: 'festival' },
            'festival': { id: 'festival', name: 'Eternal Festival', icon: 'üé™', rate: 1800000000, rarity: 'Transcendent', next: null },

            // Gem/Crystal Pets
            'ruby': { id: 'ruby', name: 'Ruby Guardian', icon: 'üíé', rate: 45000000, rarity: 'Epic', next: 'sapphire' },
            'sapphire': { id: 'sapphire', name: 'Sapphire Spirit', icon: 'üíé', rate: 135000000, rarity: 'Legendary', next: 'emerald' },
            'emerald': { id: 'emerald', name: 'Emerald Essence', icon: 'üíé', rate: 500000000, rarity: 'Mythical', next: 'diamond' },
            'diamond': { id: 'diamond', name: 'Diamond Core', icon: 'üíé', rate: 2000000000, rarity: 'Transcendent', next: null },

            // Mechanical/Steam Punk Pets
            'gear': { id: 'gear', name: 'Clockwork Gear', icon: '‚öôÔ∏è', rate: 50000000, rarity: 'Epic', next: 'steam' },
            'steam': { id: 'steam', name: 'Steam Engine', icon: 'üöÇ', rate: 150000000, rarity: 'Legendary', next: 'piston' },
            'piston': { id: 'piston', name: 'Hydraulic Piston', icon: 'üîß', rate: 600000000, rarity: 'Mythical', next: 'automaton' },
            'automaton': { id: 'automaton', name: 'Grand Automaton', icon: 'ü§ñ', rate: 2500000000, rarity: 'Transcendent', next: null },

            // Dream/Illusion Pets
            'dream': { id: 'dream', name: 'Sweet Dream', icon: 'üí≠', rate: 55000000, rarity: 'Epic', next: 'nightmare' },
            'nightmare': { id: 'nightmare', name: 'Living Nightmare', icon: 'üëª', rate: 165000000, rarity: 'Legendary', next: 'illusion' },
            'illusion': { id: 'illusion', name: 'Perfect Illusion', icon: 'üé≠', rate: 700000000, rarity: 'Mythical', next: 'phantasm' },
            'phantasm': { id: 'phantasm', name: 'Phantasm Lord', icon: 'üëë', rate: 3000000000, rarity: 'Transcendent', next: null }
        };

        const EGGS = [
            { id: 'starter', name: 'Starter Egg', cost: 50, icon: 'ü•ö', colorClass: 'bg-orange-100 border-orange-200 text-gray-900', pool: { 'ant': 0.45, 'chick': 0.40, 'mouse': 0.15 } },
            { id: 'farm', name: 'Farm Egg', cost: 200, icon: 'üè°', colorClass: 'bg-yellow-100 border-yellow-200 text-gray-900', pool: { 'mouse': 0.3, 'beetle': 0.2, 'cat': 0.25, 'dog': 0.15, 'pig': 0.08, 'sheep': 0.02 } },
            { id: 'aqua', name: 'Aqua Egg', cost: 750, icon: 'üåä', colorClass: 'bg-blue-100 border-blue-200 text-gray-900', pool: { 'fish': 0.35, 'crab': 0.3, 'turtle': 0.2, 'shark': 0.1, 'kraken': 0.005 } },
            { id: 'desert', name: 'Desert Egg', cost: 2500, icon: 'üåµ', colorClass: 'bg-amber-100 border-amber-200 text-gray-900', pool: { 'snake': 0.4, 'camel': 0.3, 'vulture': 0.2, 'fox': 0.1 } },
            { id: 'spooky', name: 'Spooky Egg', cost: 7500, icon: 'üëª', colorClass: 'bg-purple-100 border-purple-200 text-gray-900', pool: { 'spider': 0.3, 'owl': 0.3, 'wolf': 0.25, 'skeleton': 0.1, 'reaper': 0.05 } },
            { id: 'forest', name: 'Forest Egg', cost: 20000, icon: 'üå≤', colorClass: 'bg-green-100 border-green-200 text-gray-900', pool: { 'fox': 0.3, 'monkey': 0.3, 'owl': 0.2, 'wolf': 0.15, 'bear': 0.05 } },
            { id: 'prehistoric', name: 'Dino Egg', cost: 75000, icon: 'üåã', colorClass: 'bg-red-100 border-red-200 text-gray-900', pool: { 't-rex': 0.4, 'triceratops': 0.3, 'pterodactyl': 0.2, 'mammoth': 0.1 } },
            { id: 'jungle', name: 'Jungle Egg', cost: 250000, icon: 'üå¥', colorClass: 'bg-emerald-100 border-emerald-200 text-gray-900', pool: { 'monkey': 0.3, 'snake': 0.3, 'tiger': 0.2, 'bear': 0.15, 'hydra': 0.005 } },
            { id: 'arctic', name: 'Arctic Egg', cost: 750000, icon: '‚ùÑÔ∏è', colorClass: 'bg-cyan-100 border-cyan-200 text-gray-900', pool: { 'penguin': 0.4, 'bear': 0.3, 'yeti': 0.2, 'mammoth': 0.1 } },
            { id: 'cosmic', name: 'Cosmic Egg', cost: 2500000, icon: 'ü™ê', colorClass: 'bg-indigo-100 border-indigo-200 text-gray-900', pool: { 'alien': 0.4, 'robot': 0.4, 'titan': 0.15, 'void': 0.005, 'reward_griffin': 0.001 } },
            { id: 'fantasy', name: 'Fantasy Egg', cost: 10000000, icon: 'üè∞', colorClass: 'bg-pink-100 border-pink-200 text-gray-900', pool: { 'unicorn': 0.35, 'griffin': 0.3, 'dragon': 0.2, 'phoenix': 0.1, 'titan': 0.05 } },
            { id: 'divine', name: 'Divine Egg', cost: 50000000, icon: 'üëë', colorClass: 'bg-yellow-50 border-yellow-300 text-gray-900', pool: { 'phoenix': 0.4, 'kraken': 0.25, 'hydra': 0.2, 'titan': 0.1, 'void': 0.05 } },
            { id: 'void', name: 'Void Egg', cost: 250000000, icon: 'üï≥Ô∏è', colorClass: 'bg-gray-900 border-gray-600 text-white', pool: { 'void': 0.6, 'cosmos': 0.4 } },
            { id: 'mystery', name: 'Mystery Egg', cost: 25000, icon: '‚ùì', colorClass: 'bg-purple-100 border-purple-300 text-gray-900', pool: { 'spider': 0.2, 'bee': 0.2, 'frog': 0.2, 'turtle': 0.15, 'penguin': 0.15, 'camel': 0.1 } },
            { id: 'enchanted', name: 'Enchanted Egg', cost: 500000, icon: '‚ú®', colorClass: 'bg-pink-200 border-pink-400 text-gray-900', pool: { 'unicorn': 0.3, 'phoenix': 0.25, 'dragon': 0.2, 'griffin': 0.15, 'yeti': 0.1 } },
            { id: 'ancient', name: 'Ancient Egg', cost: 2000000, icon: 'üèõÔ∏è', colorClass: 'bg-amber-200 border-amber-400 text-gray-900', pool: { 't-rex': 0.25, 'triceratops': 0.2, 'mammoth': 0.2, 'reaper': 0.15, 'titan': 0.1, 'void': 0.05, 'cosmos': 0.05 } },
            { id: 'celestial', name: 'Celestial Egg', cost: 10000000, icon: 'üåü', colorClass: 'bg-blue-200 border-blue-400 text-gray-900', pool: { 'phoenix': 0.25, 'dragon': 0.2, 'griffin': 0.15, 'cosmos': 0.15, 'nebula': 0.1, 'star': 0.05, 'reward_griffin': 0.05, 'void': 0.05 } },
            { id: 'legendary', name: 'Legendary Egg', cost: 50000000, icon: 'üëë', colorClass: 'bg-yellow-200 border-yellow-400 text-gray-900', pool: { 'dragon': 0.3, 'phoenix': 0.25, 'griffin': 0.2, 'yeti': 0.15, 'mammoth': 0.1 } },
            { id: 'ultimate', name: 'Ultimate Egg', cost: 500000000, icon: 'üíé', colorClass: 'bg-purple-300 border-purple-500 text-gray-900', pool: { 'cosmos': 0.25, 'nebula': 0.2, 'star': 0.15, 'void': 0.15, 'titan': 0.1, 'reward_griffin': 0.1, 'dragon': 0.05 } },
            { id: 'cyber', name: 'Cyber Egg', cost: 1000000000, icon: 'üíæ', colorClass: 'bg-blue-900 border-blue-500 text-blue-200', pool: { 'drone': 0.6, 'alien': 0.3, 'cyborg': 0.1 } },
            { id: 'magma', name: 'Magma Egg', cost: 5000000000, icon: '‚òÑÔ∏è', colorClass: 'bg-red-900 border-red-500 text-red-200', pool: { 'magma_golem': 0.6, 'dragon': 0.3, 'magma_lord': 0.1 } },
            { id: 'sugar', name: 'Sugar Egg', cost: 25000000000, icon: 'üç≠', colorClass: 'bg-pink-200 border-pink-400 text-pink-800', pool: { 'gummy_bear': 0.6, 'unicorn': 0.3, 'candy_king': 0.1 } },
            { id: 'abyssal', name: 'Abyssal Egg', cost: 100000000000, icon: 'üî±', colorClass: 'bg-teal-900 border-teal-500 text-teal-200', pool: { 'kraken': 0.5, 'mermaid': 0.4, 'leviathan': 0.1 } },
            { id: 'eclipse', name: 'Eclipse Egg', cost: 50000000000, icon: 'üåë', colorClass: 'bg-purple-900 border-purple-600 text-purple-200', pool: { 'wraith': 0.5, 'void': 0.4, 'nightmare': 0.1 } },
            { id: 'ether', name: 'Ether Egg', cost: 2500000000000, icon: 'üå§Ô∏è', colorClass: 'bg-yellow-100 border-yellow-400 text-yellow-800', pool: { 'cherub': 0.5, 'cosmos': 0.4, 'archangel': 0.1 } },
            { id: 'infinity', name: 'Infinity Egg', cost: 10000000000000, icon: '‚ôæÔ∏è', colorClass: 'bg-gray-100 border-black text-black', pool: { 'chronos': 0.05, 'archangel': 0.2, 'nightmare': 0.25, 'leviathan': 0.5 } },
            { id: 'treasury', name: 'Treasury Egg', cost: 50000000000000, icon: 'üèÜ', colorClass: 'bg-yellow-200 border-yellow-500 text-yellow-900', pool: { 'golden_chick': 0.1, 'dragon': 0.4, 'unicorn': 0.5 } },
            { id: 'spectrum', name: 'Spectrum Egg', cost: 100000000000000, icon: 'üåà', colorClass: 'bg-pink-100 border-purple-400 text-purple-900', pool: { 'rainbow_chick': 0.1, 'phoenix': 0.4, 'kraken': 0.5 } },
            { id: 'machinery', name: 'Mecha Egg', cost: 500000000000000, icon: '‚öôÔ∏è', colorClass: 'bg-gray-300 border-gray-600 text-gray-900', pool: { 'mecha_chick': 0.1, 'cyborg': 0.4, 'robot': 0.5 } },
            { id: 'singularity', name: 'Singularity Egg', cost: 1000000000000000, icon: 'üåå', colorClass: 'bg-black border-white text-white', pool: { 'darkmatter_chick': 0.05, 'void': 0.4, 'cosmos': 0.55 } },
            { id: 'toxic', name: 'Toxic Egg', cost: 100000000, icon: '‚ò¢Ô∏è', colorClass: 'bg-green-900 border-green-400 text-green-200', pool: { 'roach': 0.6, 'slime': 0.3, 'hazmat': 0.09, 'godzilla': 0.01 } },

            // New Advanced World Eggs
            { id: 'digital', name: 'Digital Egg', cost: 750000000000, icon: 'üíª', colorClass: 'bg-green-800 border-green-400 text-green-200', pool: { 'pixel': 0.5, 'byte': 0.3, 'data': 0.15, 'algorithm': 0.05 } },
            { id: 'elemental', name: 'Elemental Egg', cost: 1500000000000, icon: 'üî•', colorClass: 'bg-orange-800 border-orange-400 text-orange-200', pool: { 'breeze': 0.4, 'storm': 0.3, 'earthquake': 0.2, 'volcano': 0.1 } },
            { id: 'temporal', name: 'Temporal Egg', cost: 3000000000000, icon: '‚è∞', colorClass: 'bg-indigo-700 border-indigo-400 text-indigo-200', pool: { 'moment': 0.4, 'era': 0.3, 'dimension': 0.2, 'multiverse': 0.1 } },
            { id: 'celebration', name: 'Celebration Egg', cost: 6000000000000, icon: 'üéâ', colorClass: 'bg-pink-700 border-pink-400 text-pink-200', pool: { 'firework': 0.4, 'lantern': 0.3, 'dragon_dance': 0.2, 'festival': 0.1 } },
            { id: 'gemstone', name: 'Gemstone Egg', cost: 12000000000000, icon: 'üíç', colorClass: 'bg-cyan-700 border-cyan-400 text-cyan-200', pool: { 'ruby': 0.35, 'sapphire': 0.3, 'emerald': 0.25, 'diamond': 0.1 } },
            { id: 'steampunk', name: 'Steampunk Egg', cost: 25000000000000, icon: 'üî©', colorClass: 'bg-amber-800 border-amber-400 text-amber-200', pool: { 'gear': 0.4, 'steam': 0.3, 'piston': 0.2, 'automaton': 0.1 } },
            { id: 'dreamscape', name: 'Dreamscape Egg', cost: 50000000000000, icon: 'üåô', colorClass: 'bg-purple-800 border-purple-400 text-purple-200', pool: { 'dream': 0.4, 'nightmare': 0.3, 'illusion': 0.2, 'phantasm': 0.1 } },
            { id: 'quantum', name: 'Quantum Egg', cost: 100000000000000, icon: '‚öõÔ∏è', colorClass: 'bg-blue-900 border-blue-400 text-blue-200', pool: { 'void_lord': 0.3, 'cosmic_titan': 0.4, 'reality_weaver': 0.3 } },
            { id: 'paradox', name: 'Paradox Egg', cost: 200000000000000, icon: 'üîÑ', colorClass: 'bg-gray-800 border-gray-400 text-gray-200', pool: { 'eternity': 0.4, 'multiverse': 0.3, 'reality_weaver': 0.3 } },
            { id: 'ultimate_cosmos', name: 'Ultimate Cosmos Egg', cost: 500000000000000, icon: '‚ú®', colorClass: 'bg-gradient-to-r from-purple-900 via-blue-900 to-indigo-900 border-white text-white', pool: { 'cosmic_titan': 0.3, 'reality_weaver': 0.3, 'phantasm': 0.2, 'automaton': 0.2 } },

            // Ocean/Sea Eggs
            { id: 'coral', name: 'Coral Egg', cost: 150000000, icon: 'ü™∏', colorClass: 'bg-cyan-800 border-cyan-400 text-cyan-200', pool: { 'dolphin': 0.5, 'octopus': 0.3, 'seahorse': 0.15, 'jellyfish': 0.05 } },
            { id: 'deep', name: 'Deep Sea Egg', cost: 300000000, icon: 'üê†', colorClass: 'bg-blue-900 border-blue-400 text-blue-200', pool: { 'octopus': 0.4, 'whale': 0.3, 'jellyfish': 0.2, 'leviathan': 0.1 } },
            { id: 'tropical', name: 'Tropical Egg', cost: 600000000, icon: 'üèùÔ∏è', colorClass: 'bg-teal-700 border-teal-400 text-teal-200', pool: { 'dolphin': 0.4, 'seahorse': 0.3, 'shark': 0.2, 'kraken': 0.1 } },

            // Forest/Woodland Eggs
            { id: 'woodland', name: 'Woodland Egg', cost: 200000000, icon: 'üå≥', colorClass: 'bg-green-800 border-green-400 text-green-200', pool: { 'deer': 0.4, 'raccoon': 0.3, 'squirrel': 0.2, 'owl': 0.1 } },
            { id: 'ancient_forest', name: 'Ancient Forest Egg', cost: 400000000, icon: 'üå≤', colorClass: 'bg-emerald-900 border-emerald-400 text-emerald-200', pool: { 'deer': 0.3, 'owl': 0.25, 'eagle': 0.2, 'bear': 0.15, 'griffin': 0.1 } },
            { id: 'enchanted_woods', name: 'Enchanted Woods Egg', cost: 800000000, icon: 'üßö', colorClass: 'bg-lime-800 border-lime-400 text-lime-200', pool: { 'raccoon': 0.35, 'eagle': 0.3, 'griffin': 0.25, 'unicorn': 0.1 } },

            // Desert/Ancient Eggs
            { id: 'oasis', name: 'Oasis Egg', cost: 250000000, icon: 'üèúÔ∏è', colorClass: 'bg-yellow-800 border-yellow-400 text-yellow-200', pool: { 'camel': 0.5, 'scorpion': 0.3, 'snake': 0.15, 'vulture': 0.05 } },
            { id: 'pyramid', name: 'Pyramid Egg', cost: 500000000, icon: 'üèóÔ∏è', colorClass: 'bg-amber-900 border-amber-400 text-amber-200', pool: { 'scorpion': 0.4, 'sphinx': 0.3, 'pharaoh': 0.2, 'anubis': 0.1 } },
            { id: 'pharaohs_tomb', name: 'Pharaohs Tomb Egg', cost: 1000000000, icon: 'üïå', colorClass: 'bg-orange-900 border-orange-400 text-orange-200', pool: { 'sphinx': 0.35, 'pharaoh': 0.3, 'anubis': 0.25, 'titan': 0.1 } },

            // Industrial/Tech Eggs
            { id: 'factory', name: 'Factory Egg', cost: 350000000, icon: 'üè≠', colorClass: 'bg-gray-700 border-gray-400 text-gray-200', pool: { 'robot': 0.5, 'android': 0.3, 'drone': 0.15, 'cyborg': 0.05 } },
            { id: 'cyberpunk', name: 'Cyberpunk Egg', cost: 700000000, icon: 'üåÜ', colorClass: 'bg-purple-900 border-purple-400 text-purple-200', pool: { 'android': 0.4, 'drone': 0.3, 'mech': 0.2, 'ai': 0.1 } },
            { id: 'future', name: 'Future Egg', cost: 1400000000, icon: 'üöÄ', colorClass: 'bg-indigo-900 border-indigo-400 text-indigo-200', pool: { 'mech': 0.4, 'ai': 0.3, 'cosmos': 0.2, 'void': 0.1 } },

            // Magical/Fantasy Eggs
            { id: 'fairy_tale', name: 'Fairy Tale Egg', cost: 450000000, icon: 'üìñ', colorClass: 'bg-pink-700 border-pink-400 text-pink-200', pool: { 'fairy': 0.4, 'elf': 0.3, 'pegasus': 0.2, 'wizard': 0.1 } },
            { id: 'wizard_tower', name: 'Wizard Tower Egg', cost: 900000000, icon: 'üè∞', colorClass: 'bg-violet-800 border-violet-400 text-violet-200', pool: { 'elf': 0.35, 'wizard': 0.3, 'pegasus': 0.25, 'dragon': 0.1 } },
            { id: 'mythical_realm', name: 'Mythical Realm Egg', cost: 1800000000, icon: 'üßô', colorClass: 'bg-fuchsia-800 border-fuchsia-400 text-fuchsia-200', pool: { 'wizard': 0.4, 'centaur': 0.3, 'phoenix': 0.2, 'titan': 0.1 } },

            // Holiday/Seasonal Eggs
            { id: 'winter_wonderland', name: 'Winter Wonderland Egg', cost: 550000000, icon: '‚ùÑÔ∏è', colorClass: 'bg-sky-700 border-sky-400 text-sky-200', pool: { 'snowman': 0.5, 'reindeer': 0.3, 'penguin': 0.15, 'yeti': 0.05 } },
            { id: 'christmas', name: 'Christmas Egg', cost: 1100000000, icon: 'üéÑ', colorClass: 'bg-red-700 border-red-400 text-red-200', pool: { 'reindeer': 0.4, 'santa': 0.3, 'snowflake': 0.2, 'north_pole': 0.1 } },
            { id: 'holiday_spirit', name: 'Holiday Spirit Egg', cost: 2200000000, icon: 'üéÅ', colorClass: 'bg-green-700 border-green-400 text-green-200', pool: { 'santa': 0.4, 'snowflake': 0.3, 'north_pole': 0.2, 'yeti': 0.1 } },

            // Food/Candy Eggs
            { id: 'bakery', name: 'Bakery Egg', cost: 650000000, icon: 'ü•ñ', colorClass: 'bg-amber-600 border-amber-400 text-amber-900', pool: { 'cookie': 0.5, 'cake': 0.3, 'ice_cream': 0.15, 'lollipop': 0.05 } },
            { id: 'candy_land', name: 'Candy Land Egg', cost: 1300000000, icon: 'üç¨', colorClass: 'bg-pink-600 border-pink-400 text-pink-900', pool: { 'cake': 0.4, 'ice_cream': 0.3, 'candy_cane': 0.2, 'gingerbread': 0.1 } },
            { id: 'sweet_paradise', name: 'Sweet Paradise Egg', cost: 2600000000, icon: 'üç∞', colorClass: 'bg-rose-600 border-rose-400 text-rose-900', pool: { 'lollipop': 0.4, 'candy_cane': 0.3, 'gingerbread': 0.2, 'unicorn': 0.1 } },

            // Mythical Creatures Eggs
            { id: 'labyrinth', name: 'Labyrinth Egg', cost: 750000000, icon: 'üè∞', colorClass: 'bg-stone-700 border-stone-400 text-stone-200', pool: { 'minotaur': 0.5, 'cyclops': 0.3, 'manticore': 0.15, 'behemoth': 0.05 } },
            { id: 'monster_island', name: 'Monster Island Egg', cost: 1500000000, icon: 'üèùÔ∏è', colorClass: 'bg-slate-700 border-slate-400 text-slate-200', pool: { 'cyclops': 0.4, 'manticore': 0.3, 'behemoth': 0.2, 'chimera': 0.1 } },
            { id: 'legendary_beasts', name: 'Legendary Beasts Egg', cost: 3000000000, icon: 'ü¶Å', colorClass: 'bg-neutral-700 border-neutral-400 text-neutral-200', pool: { 'manticore': 0.4, 'behemoth': 0.3, 'chimera': 0.2, 'leviathan': 0.1 } },

            // Space/Alien Eggs
            { id: 'alien_world', name: 'Alien World Egg', cost: 850000000, icon: 'üõ∏', colorClass: 'bg-green-800 border-green-400 text-green-200', pool: { 'ufo': 0.5, 'martian': 0.3, 'astronaut': 0.15, 'satellite': 0.05 } },
            { id: 'cosmic_voyage', name: 'Cosmic Voyage Egg', cost: 1700000000, icon: 'üöÄ', colorClass: 'bg-blue-800 border-blue-400 text-blue-200', pool: { 'martian': 0.4, 'astronaut': 0.3, 'comet': 0.2, 'nebula': 0.1 } },
            { id: 'galactic_empire', name: 'Galactic Empire Egg', cost: 3400000000, icon: 'üåå', colorClass: 'bg-indigo-800 border-indigo-400 text-indigo-200', pool: { 'satellite': 0.4, 'comet': 0.3, 'star': 0.2, 'cosmos': 0.1 } },

            // Time/Dimensional Eggs
            { id: 'time_machine', name: 'Time Machine Egg', cost: 950000000, icon: '‚è∞', colorClass: 'bg-slate-600 border-slate-400 text-slate-900', pool: { 'hourglass': 0.5, 'clock': 0.3, 'portal': 0.15, 'dimension': 0.05 } },
            { id: 'dimensional_rift', name: 'Dimensional Rift Egg', cost: 1900000000, icon: 'üåÄ', colorClass: 'bg-violet-600 border-violet-400 text-violet-900', pool: { 'clock': 0.4, 'portal': 0.3, 'dimension': 0.2, 'eternity': 0.1 } },
            { id: 'eternal_void', name: 'Eternal Void Egg', cost: 3800000000, icon: '‚ôæÔ∏è', colorClass: 'bg-gray-600 border-gray-400 text-gray-900', pool: { 'dimension': 0.4, 'eternity': 0.3, 'void': 0.2, 'cosmos': 0.1 } }
        ];

        const ACHIEVEMENTS = {
            // Basic Progression
            firstEgg: {
                id: 'firstEgg',
                name: 'First Steps',
                description: 'Buy your first egg',
                condition: (state) => state.stats.totalEggs >= 1
            },
            tenEggs: {
                id: 'tenEggs',
                name: 'Egg Collector',
                description: 'Buy 10 eggs',
                condition: (state) => state.stats.totalEggs >= 10
            },
            firstClick: {
                id: 'firstClick',
                name: 'Click Master',
                description: 'Click 100 times',
                condition: (state) => state.stats.totalClicks >= 100
            },

            // Pet Collection
            firstRare: {
                id: 'firstRare',
                name: 'Rare Find',
                description: 'Hatch your first Rare pet',
                condition: (state) => state.inventory.some(p => PETS[p.id] && PETS[p.id].rarity === 'Rare')
            },
            firstEpic: {
                id: 'firstEpic',
                name: 'Epic Hunter',
                description: 'Hatch your first Epic pet',
                condition: (state) => state.inventory.some(p => PETS[p.id] && PETS[p.id].rarity === 'Epic')
            },
            firstLegendary: {
                id: 'firstLegendary',
                name: 'Legendary',
                description: 'Hatch your first Legendary pet',
                condition: (state) => state.inventory.some(p => PETS[p.id] && PETS[p.id].rarity === 'Legendary')
            },
            firstMythical: {
                id: 'firstMythical',
                name: 'Mythical',
                description: 'Hatch your first Mythical pet',
                condition: (state) => state.inventory.some(p => PETS[p.id] && PETS[p.id].rarity === 'Mythical')
            },
            firstGodly: {
                id: 'firstGodly',
                name: 'Godly',
                description: 'Hatch your first Godly pet',
                condition: (state) => state.inventory.some(p => PETS[p.id] && PETS[p.id].rarity === 'Godly')
            },
            firstTranscendent: {
                id: 'firstTranscendent',
                name: 'Transcendent',
                description: 'Hatch your first Transcendent pet',
                condition: (state) => state.inventory.some(p => PETS[p.id] && PETS[p.id].rarity === 'Transcendent')
            },
            firstCosmic: {
                id: 'firstCosmic',
                name: 'Cosmic',
                description: 'Hatch your first Cosmic pet',
                condition: (state) => state.inventory.some(p => PETS[p.id] && PETS[p.id].rarity === 'Cosmic')
            },

            // Wealth Achievements
            millionaire: {
                id: 'millionaire',
                name: 'Millionaire',
                description: 'Earn $1,000,000 total',
                condition: (state) => state.stats.totalMoney >= 1000000
            },
            billionaire: {
                id: 'billionaire',
                name: 'Billionaire',
                description: 'Earn $1,000,000,000 total',
                condition: (state) => state.stats.totalMoney >= 1000000000
            },
            trillionaire: {
                id: 'trillionaire',
                name: 'Trillionaire',
                description: 'Earn $1,000,000,000,000 total',
                condition: (state) => state.stats.totalMoney >= 1000000000000
            },
            quadrillionaire: {
                id: 'quadrillionaire',
                name: 'Quadrillionaire',
                description: 'Earn $1,000,000,000,000,000 total',
                condition: (state) => state.stats.totalMoney >= 1000000000000000
            },

            // Gameplay Achievements
            firstMerge: {
                id: 'firstMerge',
                name: 'Alchemist',
                description: 'Successfully merge pets',
                condition: (state) => state.stats.totalMerges >= 1
            },
            tenMerges: {
                id: 'tenMerges',
                name: 'Master Alchemist',
                description: 'Perform 10 successful merges',
                condition: (state) => state.stats.totalMerges >= 10
            },
            hundredEggs: {
                id: 'hundredEggs',
                name: 'Egg Master',
                description: 'Buy 100 eggs',
                condition: (state) => state.stats.totalEggs >= 100
            },
            thousandEggs: {
                id: 'thousandEggs',
                name: 'Egg Emperor',
                description: 'Buy 1,000 eggs',
                condition: (state) => state.stats.totalEggs >= 1000
            },

            // Special Achievements
            trustMaster: {
                id: 'trustMaster',
                name: 'Trust Master',
                description: 'Reach trust level 5',
                condition: (state) => (state.trust && state.trust.level >= 5)
            },
            trustLegend: {
                id: 'trustLegend',
                name: 'Trust Legend',
                description: 'Reach trust level 10',
                condition: (state) => (state.trust && state.trust.level >= 10)
            },
            collectionMaster: {
                id: 'collectionMaster',
                name: 'Collection Master',
                description: 'Collect 50 different pets',
                condition: (state) => state.collection.length >= 50
            },
            collectionLegend: {
                id: 'collectionLegend',
                name: 'Collection Legend',
                description: 'Collect 100 different pets',
                condition: (state) => state.collection.length >= 100
            },

            // Galaxy Achievements
            firstGalaxy: {
                id: 'firstGalaxy',
                name: 'Galaxy Explorer',
                description: 'Unlock your first galaxy',
                condition: (state) => state.currentGalaxy !== 'origin'
            },
            allGalaxies: {
                id: 'allGalaxies',
                name: 'Galaxy Master',
                description: 'Unlock all galaxies',
                condition: (state) => true // This would need to check if all galaxies are unlocked
            }
        };

        const QUESTS = {
            // Basic Kitchen Tasks
            firstEgg: {
                id: 'firstEgg',
                name: 'First Steps in the Kitchen',
                description: 'Buy your first egg',
                reward: 10,
                condition: (state) => state.stats.totalEggs >= 1,
                completed: false
            },
            tenEggs: {
                id: 'tenEggs',
                name: 'Kitchen Novice',
                description: 'Buy 10 eggs',
                reward: 25,
                condition: (state) => state.stats.totalEggs >= 10,
                completed: false
            },
            firstClick: {
                id: 'firstClick',
                name: 'Click Training',
                description: 'Click 50 times',
                reward: 15,
                condition: (state) => state.stats.totalClicks >= 50,
                completed: false
            },

            // Pet Discovery Quests
            firstRare: {
                id: 'firstRare',
                name: 'Rare Discovery',
                description: 'Hatch your first Rare pet',
                reward: 50,
                condition: (state) => state.inventory.some(p => PETS[p.id] && PETS[p.id].rarity === 'Rare'),
                completed: false
            },
            firstEpic: {
                id: 'firstEpic',
                name: 'Epic Discovery',
                description: 'Hatch your first Epic pet',
                reward: 75,
                condition: (state) => state.inventory.some(p => PETS[p.id] && PETS[p.id].rarity === 'Epic'),
                completed: false
            },
            firstLegendary: {
                id: 'firstLegendary',
                name: 'Legendary Discovery',
                description: 'Hatch your first Legendary pet',
                reward: 100,
                condition: (state) => state.inventory.some(p => PETS[p.id] && PETS[p.id].rarity === 'Legendary'),
                completed: false
            },
            firstCosmic: {
                id: 'firstCosmic',
                name: 'Cosmic Chef',
                description: 'Hatch your first Cosmic pet',
                reward: 200,
                condition: (state) => state.inventory.some(p => PETS[p.id] && PETS[p.id].rarity === 'Cosmic'),
                completed: false
            },

            // Wealth Building Quests
            millionaire: {
                id: 'millionaire',
                name: 'Wealthy Chef',
                description: 'Earn $1,000,000 total',
                reward: 100,
                condition: (state) => state.stats.totalMoney >= 1000000,
                completed: false
            },
            tenMillion: {
                id: 'tenMillion',
                name: 'Rich Chef',
                description: 'Earn $10,000,000 total',
                reward: 150,
                condition: (state) => state.stats.totalMoney >= 10000000,
                completed: false
            },
            billionaire: {
                id: 'billionaire',
                name: 'Billionaire Chef',
                description: 'Earn $1,000,000,000 total',
                reward: 250,
                condition: (state) => state.stats.totalMoney >= 1000000000,
                completed: false
            },

            // Collection Quests
            tenRares: {
                id: 'tenRares',
                name: 'Rare Collector',
                description: 'Collect 10 different Rare pets',
                reward: 300,
                condition: (state) => {
                    const rarePets = state.inventory.filter(p => PETS[p.id] && PETS[p.id].rarity === 'Rare').map(p => p.id);
                    return [...new Set(rarePets)].length >= 10;
                },
                completed: false
            },
            fiveEpics: {
                id: 'fiveEpics',
                name: 'Epic Collector',
                description: 'Collect 5 different Epic pets',
                reward: 400,
                condition: (state) => {
                    const epicPets = state.inventory.filter(p => PETS[p.id] && PETS[p.id].rarity === 'Epic').map(p => p.id);
                    return [...new Set(epicPets)].length >= 5;
                },
                completed: false
            },

            // Gameplay Quests
            firstMerge: {
                id: 'firstMerge',
                name: 'First Fusion',
                description: 'Successfully merge pets for the first time',
                reward: 80,
                condition: (state) => state.stats.totalMerges >= 1,
                completed: false
            },
            fiveMerges: {
                id: 'fiveMerges',
                name: 'Fusion Expert',
                description: 'Perform 5 successful merges',
                reward: 120,
                condition: (state) => state.stats.totalMerges >= 5,
                completed: false
            },
            hundredEggs: {
                id: 'hundredEggs',
                name: 'Master Chef',
                description: 'Buy 100 eggs',
                reward: 150,
                condition: (state) => state.stats.totalEggs >= 100,
                completed: false
            },

            // Trust Building Quests
            kitchenTrust: {
                id: 'kitchenTrust',
                name: 'Kitchen Cosmos Trust',
                description: 'Complete 5 trust quests',
                reward: 500,
                condition: (state) => state.trust.questsCompleted.length >= 5,
                completed: false
            },
            trustBuilder: {
                id: 'trustBuilder',
                name: 'Trust Builder',
                description: 'Reach trust level 3',
                reward: 300,
                condition: (state) => (state.trust && state.trust.level >= 3),
                completed: false
            },
            trustMaster: {
                id: 'trustMaster',
                name: 'Trust Master',
                description: 'Reach trust level 7',
                reward: 600,
                condition: (state) => (state.trust && state.trust.level >= 7),
                completed: false
            },

            // Advanced Quests
            collection25: {
                id: 'collection25',
                name: 'Pet Collector',
                description: 'Collect 25 different pets',
                reward: 350,
                condition: (state) => state.collection.length >= 25,
                completed: false
            },
            collection50: {
                id: 'collection50',
                name: 'Pet Master',
                description: 'Collect 50 different pets',
                reward: 500,
                condition: (state) => state.collection.length >= 50,
                completed: false
            },
            galaxyExplorer: {
                id: 'galaxyExplorer',
                name: 'Galaxy Explorer',
                description: 'Unlock 3 different galaxies',
                reward: 400,
                condition: (state) => {
                    // This would need to check unlocked galaxies
                    return true; // Placeholder
                },
                completed: false
            }
        };

        const UPGRADES = {
            luck: { name: 'Luck', description: 'Increases merge success rate', icon: 'üçÄ', baseCost: 50000000, costMultiplier: 2.5, maxLevel: 10, getEffect: (level) => level * 0.05 },
            income: { name: 'Income', description: 'Multiplies all pet income', icon: 'üí∞', baseCost: 250000000, costMultiplier: 3, maxLevel: 10, getEffect: (level) => level * 0.1 },
            clickPower: { name: 'Click', description: 'Increases click earnings', icon: 'üëÜ', baseCost: 25000000, costMultiplier: 2, maxLevel: 20, getEffect: (level) => level * 2 },
            autoClicker: { name: 'Auto-Click', description: 'Automatically clicks for you', icon: 'ü§ñ', baseCost: 500000000, costMultiplier: 4, maxLevel: 10, getEffect: (level) => level * 4 },
            criticalClicks: { name: 'Critical', description: 'Chance for 5x click earnings', icon: 'üí•', baseCost: 125000000, costMultiplier: 2.8, maxLevel: 15, getEffect: (level) => level * 0.02 },
            eggDiscount: { name: 'Discount', description: 'Reduces egg costs', icon: 'üè∑Ô∏è', baseCost: 375000000, costMultiplier: 3.5, maxLevel: 8, getEffect: (level) => level * 0.05 },
            petBonus: { name: 'Pet Boost', description: 'Increases pet income rates', icon: '‚≠ê', baseCost: 750000000, costMultiplier: 3.2, maxLevel: 12, getEffect: (level) => level * 0.08 },
            multiHatch: { name: 'Multi-Hatch', description: 'Max eggs hatched at once', icon: 'ü•ö', baseCost: 2500000000, costMultiplier: 5, maxLevel: 5, getEffect: (level) => level + 1 },
            offlineProgress: { name: 'Offline Progress', description: 'Earn income while away', icon: '‚è∞', baseCost: 500000000, costMultiplier: 6, maxLevel: 10, getEffect: (level) => level * 0.1 },
            prestigeBonus: { name: 'Prestige Power', description: 'Bonus from rebirths', icon: 'üî•', baseCost: 500000000, costMultiplier: 8, maxLevel: 5, getEffect: (level) => level * 0.5 },
            goldenEggs: { name: 'Golden Eggs', description: 'Chance for 10x egg value', icon: 'ü•á', baseCost: 500000000, costMultiplier: 4, maxLevel: 8, getEffect: (level) => level * 0.01 },
            petEvolution: { name: 'Evolution Speed', description: 'Faster pet evolution', icon: '‚ö°', baseCost: 500000000, costMultiplier: 3.5, maxLevel: 15, getEffect: (level) => level * 0.05 },
            luckBoost: { name: 'Super Luck', description: 'Massive luck improvements', icon: 'üçé', baseCost: 500000000, costMultiplier: 4.5, maxLevel: 12, getEffect: (level) => level * 0.08 }
        };

        // --- STATE ---
        let state = {
            money: 0,
            inventory: [],
            collection: [],
            cosmosSlots: [],
            upgrades: { luck: 0, income: 0, clickPower: 0, autoClicker: 0, criticalClicks: 0, eggDiscount: 0, petBonus: 0, multiHatch: 0, offlineProgress: 0, prestigeBonus: 0, goldenEggs: 0, petEvolution: 0, luckBoost: 0 },
            rebirth: { level: 0, multiplier: 1 },
            achievements: [],
            trust: { level: 1, experience: 0, questsCompleted: [] },
            dailyRewards: { lastClaim: 0, streak: 0, claimedDays: [] },
            playTime: { totalSeconds: 0, lastUpdate: Date.now(), rewards: [] },
            currentWorld: 'home',
            currentGalaxy: 'origin',
            settings: { hatchAmount: 1, sortMode: 'rarity_desc' },
            stats: { totalClicks: 0, totalEggs: 0, totalMerges: 0, totalMoney: 0, radioactiveDiscovery: false },
            lastSave: Date.now()
        };

        let autoClickerInterval = null;

        // --- CORE FUNCTIONS ---
        window.onload = function() {
            loadGame();
            renderShop();
            renderUpgrades();
            renderQuests();
            renderAchievements();
            renderInventory();
            updateAutoClicker();
            checkAchievements();
            checkQuests();
            checkDailyRewards();
            updateDailyUI();
            updatePlayTimeUI();
            updateUI();

            setInterval(() => {
                const income = calculateIncome();
                if (income > 0) addMoney(income);
                updatePlayTime();
            }, 1000);

            setInterval(processCosmos, 1000);
            setInterval(saveGame, 10000);
            setInterval(() => {
                updateDailyUI();
                updatePlayTimeUI();
            }, 5000); // Update UI every 5 seconds
        };

        function formatCompact(num) {
            return Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 1 }).format(num);
        }

        function calculateIncome() {
            let baseIncome = 0;
            let hasGriffin = false;
            
            const chaosCounts = {};
            state.inventory.forEach(p => {
                if(p.mutations && p.mutations.includes('chaos')) {
                    chaosCounts[p.id] = (chaosCounts[p.id] || 0) + 1;
                }
            });

            state.inventory.forEach(p => {
                if (p.id === 'reward_griffin') {
                    hasGriffin = true;
                    return;
                }
                const pet = PETS[p.id];
                if (!pet) return;
                
                let rate = pet.rate;
                if (p.mutations) {
                    if (p.mutations.includes('gold')) rate *= 2;
                    if (p.mutations.includes('rainbow')) rate *= 4;
                    if (p.mutations.includes('darkmatter')) rate *= 10;
                }
                
                const chaosBoost = (chaosCounts[p.id] || 0) * 0.25;
                rate = rate * (1 + chaosBoost);
                
                baseIncome += rate;
            });

            if (hasGriffin) {
                baseIncome *= 3;
            }

            const incomeMultiplier = 1 + UPGRADES.income.getEffect(state.upgrades.income);
            const petBonus = 1 + UPGRADES.petBonus.getEffect(state.upgrades.petBonus);
            const rebirthMult = state.rebirth.multiplier || 1;
            return Math.floor(baseIncome * incomeMultiplier * petBonus * rebirthMult);
        }

        function addMoney(amount) {
            state.money += amount;
            state.stats.totalMoney += amount;
            updateUI();
        }

        function manualClick(e, isAuto = false) {
            const baseClick = 1;
            const incomeBonus = Math.floor(calculateIncome() * 0.05);
            const upgradeBonus = UPGRADES.clickPower.getEffect(state.upgrades.clickPower);
            const rebirthMult = state.rebirth.multiplier || 1;
            let total = (baseClick + incomeBonus + upgradeBonus) * rebirthMult;

            const critChance = UPGRADES.criticalClicks.getEffect(state.upgrades.criticalClicks);
            if (Math.random() < critChance) total *= 5;

            addMoney(total);

            if (!isAuto) state.stats.totalClicks++;
            if (!isAuto && e) {
                const critText = total > ((baseClick + incomeBonus + upgradeBonus) * rebirthMult) ? 'CRIT! ' : '';
                createFloatingText(e.clientX, e.clientY, `${critText}+$${formatCompact(total)}`);
            }
        }

        // --- KITCHEN COSMOS ---
        function openKitchenModal() {
            renderCosmos();
            document.getElementById('kitchen-modal').classList.remove('hidden');
        }

        function closeKitchenModal() {
            document.getElementById('kitchen-modal').classList.add('hidden');
        }

        function renderCosmos() {
            const grid = document.getElementById('cosmos-grid');
            const inventoryStrip = document.getElementById('cosmos-inventory');
            
            let slotsHTML = '';
            for(let i=0; i<8; i++) {
                const p = state.cosmosSlots[i];
                if (p) {
                    const petDef = PETS[p.id];
                    const timeIn = Math.floor((Date.now() - (p.enterTime || Date.now())) / 1000);
                    slotsHTML += `
                        <div class="bg-gray-200 rounded-lg p-2 border-2 border-gray-300 flex flex-col items-center justify-between relative h-32 cursor-pointer hover:bg-red-100 transition" onclick="retrieveFromCosmos(${i})">
                            <div class="text-3xl">${petDef.icon}</div>
                            <div class="text-[10px] font-bold text-center truncate w-full text-gray-800">${petDef.name}</div>
                            <div class="text-[9px] text-gray-500">${timeIn}s in</div>
                            <div class="flex gap-1 flex-wrap justify-center mt-1">${renderMutationIcons(p.mutations)}</div>
                            <div class="absolute top-1 right-1 text-xs text-red-500"><i class="fas fa-sign-out-alt"></i></div>
                        </div>
                    `;
                } else {
                    slotsHTML += `<div class="bg-gray-100 rounded-lg border-2 border-dashed border-gray-300 flex items-center justify-center h-32 text-gray-400">Empty</div>`;
                }
            }
            grid.innerHTML = slotsHTML;
            
            inventoryStrip.innerHTML = state.inventory.map(p => {
                const petDef = PETS[p.id];
                return `
                    <div class="flex-shrink-0 w-16 h-16 bg-white border rounded-lg flex flex-col items-center justify-center cursor-pointer hover:bg-blue-50 relative text-gray-800" onclick="addToCosmos(${p.uid})">
                        <div class="mutation-container" style="top:2px; right:2px; gap:1px;">${renderMutationIcons(p.mutations)}</div>
                        <div class="text-2xl">${petDef.icon}</div>
                        <div class="text-[9px] truncate w-full text-center">${petDef.name}</div>
                    </div>
                `;
            }).join('');
        }

        function addToCosmos(uid) {
            if (state.cosmosSlots.filter(s => s).length >= 8) { showToast("Cosmos is full!"); return; }
            const idx = state.inventory.findIndex(p => p.uid === uid);
            if (idx === -1) return;
            const pet = state.inventory.splice(idx, 1)[0];
            
            // Initializing mutations array if it doesn't exist
            if (!pet.mutations) pet.mutations = [];
            
            pet.enterTime = Date.now();
            for(let i=0; i<8; i++) {
                if(!state.cosmosSlots[i]) {
                    state.cosmosSlots[i] = pet;
                    break;
                }
            }
            saveGame(); renderCosmos(); renderInventory();
        }

        function retrieveFromCosmos(slotIdx) {
            const pet = state.cosmosSlots[slotIdx];
            if (!pet) return;
            state.cosmosSlots[slotIdx] = null;
            delete pet.enterTime;
            state.inventory.push(pet);
            saveGame(); renderCosmos(); renderInventory();
        }

        function processCosmos() {
            let changed = false;
            state.cosmosSlots.forEach((p, idx) => {
                if (!p) return;
                
                // Initialize if missing
                if (!p.mutations) p.mutations = [];

                if (Math.random() < 0.1) {
                    const timeInSeconds = (Date.now() - p.enterTime) / 1000;
                    const destroyChance = 0.20 + (timeInSeconds / 1000); 
                    
                    if (Math.random() < destroyChance) {
                        state.cosmosSlots[idx] = null;
                        showToast(`${PETS[p.id].name} was destroyed by the Cosmos!`);
                        changed = true;
                    } else {
                        // Only try to mutate if we have less than 3 mutations
                        if (p.mutations.length < 3) {
                            const roll = Math.random();
                            let mutation = null;
                            if (roll < 0.5) mutation = 'gold';
                            else if (roll < 0.6) mutation = 'rainbow';
                            else if (roll < 0.7) mutation = 'darkmatter';
                            else if (roll < 0.75) mutation = 'radioactive';
                            else if (roll < 0.79) mutation = 'chaos';
                            else if (roll < 0.8) mutation = 'revival';
                            
                            // Apply mutation if selected and (not owned OR is chaos/stackable)
                            if (mutation) {
                                // Logic: Chaos stacks, others unique
                                if (mutation === 'chaos' || !p.mutations.includes(mutation)) {
                                    p.mutations.push(mutation);
                                    showToast(`${PETS[p.id].name} mutated: ${mutation.toUpperCase()}!`);
                                    changed = true;
                                    
                                    if (mutation === 'radioactive' && !state.stats.radioactiveDiscovery) {
                                        state.stats.radioactiveDiscovery = true;
                                        showToast("New World Discovered: Radioactive Wasteland!");
                                        renderShop();
                                    }
                                }
                            }
                        }
                    }
                }
            });
            
            // Always render if modal is open to update timers, regardless of mutations
            if (!document.getElementById('kitchen-modal').classList.contains('hidden')) {
                renderCosmos();
            }
        }

        function renderMutationIcons(mutations) {
            if (!mutations || mutations.length === 0) return '';
            return mutations.map(m => {
                let colorClass = '';
                if (m === 'gold') colorClass = 'mut-gold';
                if (m === 'rainbow') colorClass = 'mut-rainbow';
                if (m === 'darkmatter') colorClass = 'mut-darkmatter';
                if (m === 'radioactive') colorClass = 'mut-radioactive';
                if (m === 'revival') colorClass = 'mut-revival';
                if (m === 'chaos') colorClass = 'mut-chaos';
                return `<div class="mutation-badge ${colorClass}" title="${m}"></div>`;
            }).join('');
        }

        // --- CORE & UI UPDATES ---
        function updateHatchSetting(val) {
             state.settings.hatchAmount = parseInt(val);
             document.getElementById('hatch-amount-display').innerText = state.settings.hatchAmount + 'x';
             renderShop();
        }
        
        function updateSortSetting(val) {
            state.settings.sortMode = val;
            renderInventory();
        }

        function buyEgg(eggId) {
            const egg = EGGS.find(e => e.id === eggId);
            if (!egg) return;
            const discount = UPGRADES.eggDiscount.getEffect(state.upgrades.eggDiscount);
            const discountedCost = Math.floor(egg.cost * (1 - discount));
            const hatchCount = state.settings.hatchAmount || 1;
            const totalCost = discountedCost * hatchCount;
            if (state.money >= totalCost) {
                state.money -= totalCost;
                state.stats.totalEggs += hatchCount;
                updateUI();
                startHatchingSequence(egg, hatchCount);
                checkAchievements();
            } else { showToast("Not enough money!"); }
        }

        function switchWorld(worldId) {
            const world = WORLDS.find(w => w.id === worldId);
            if (!world) return;
            if (world.hidden && !state.stats.radioactiveDiscovery) return; 
            if (state.rebirth.level < world.minRebirth) { showToast(`Requires Rebirth Level ${world.minRebirth}!`); return; }
            state.currentWorld = worldId;
            saveGame(); renderShop(); updateUI();
        }

        function switchGalaxy(galaxyId) {
            const galaxy = GALAXIES.find(g => g.id === galaxyId);
            if(!galaxy) return;
            if (state.rebirth.level < galaxy.minRebirth && galaxy.id !== 'apocalypse') { showToast(`Galaxy requires Rebirth ${galaxy.minRebirth}!`); return; }
            if (galaxy.id === 'apocalypse' && !state.stats.radioactiveDiscovery) { showToast("??? Locked"); return; } 

            state.currentGalaxy = galaxyId;
            const firstWorldId = galaxy.worlds[0];
            state.currentWorld = firstWorldId;
            saveGame(); renderShop(); updateUI();
        }

        // --- REBIRTH SYSTEM ---
        function getRebirthLevelData(level) {
             // Simplified logic for brevity, follows pattern: 1-14 specific unlocks, 15+ procedural
            if (level <= 14) {
                 const unlocks = ["Haunted Forest", "Jurassic Isle", "Frozen Tundra", "Magic Realm", "Deep Space", "Divine Plane", "Cyber City", "Volcanic Core", "Candy Land", "Atlantis", "Shadow Realm", "Celestial Haven", "", ""];
                 return { level: level, req: { [Object.keys(PETS)[level+2]]: level }, multiplier: 1 + (level * 0.5), unlockMsg: unlocks[level-1] ? "Unlocks: " + unlocks[level-1] : "" };
            }
            // Procedural
            const multiplier = 1 + (level * 0.5); 
            const highTierPets = ['magma_lord', 'candy_king', 'leviathan', 'nightmare', 'archangel', 'chronos', 'golden_chick', 'rainbow_chick', 'mecha_chick', 'darkmatter_chick'];
            const index = (level - 15) % highTierPets.length;
            const petId = highTierPets[index];
            const count = 1 + Math.floor((level - 15) / highTierPets.length);
            return { level: level, req: { [petId]: count }, multiplier: parseFloat(multiplier.toFixed(1)), unlockMsg: "" };
        }

        function openRebirthModal() {
            const modal = document.getElementById('rebirth-modal');
            document.getElementById('rebirth-current-level').innerText = state.rebirth.level;
            document.getElementById('rebirth-current-mult').innerText = 'x' + state.rebirth.multiplier;
            modal.classList.remove('hidden');

            const nextRebirth = getRebirthLevelData(state.rebirth.level + 1);
            document.getElementById('rebirth-next-mult').innerText = 'x' + nextRebirth.multiplier;
            document.getElementById('rebirth-unlock-msg').innerText = nextRebirth.unlockMsg || "";

            const petCounts = {};
            state.inventory.forEach(p => petCounts[p.id] = (petCounts[p.id] || 0) + 1);
            let canRebirth = true;
            let reqsHTML = '';
            for (const [petId, countNeeded] of Object.entries(nextRebirth.req)) {
                const pet = PETS[petId];
                const countOwned = petCounts[petId] || 0;
                const satisfied = countOwned >= countNeeded;
                if (!satisfied) canRebirth = false;
                reqsHTML += `<div class="flex flex-col items-center p-2 rounded ${satisfied ? 'bg-green-900/30' : 'bg-red-900/30'} border ${satisfied ? 'border-green-500' : 'border-red-500'}"><div class="text-2xl">${pet.icon}</div><div class="text-xs font-bold">${pet.name}</div><div class="text-sm ${satisfied ? 'text-green-400' : 'text-red-400'}">${countOwned}/${countNeeded}</div></div>`;
            }
            document.getElementById('rebirth-reqs').innerHTML = reqsHTML;
            document.getElementById('rebirth-confirm-btn').disabled = !canRebirth;
        }

        function closeRebirthModal() { document.getElementById('rebirth-modal').classList.add('hidden'); }

        function performRebirth() {
            const nextRebirth = getRebirthLevelData(state.rebirth.level + 1);
            const keepPets = state.inventory.filter(p => p.id === 'reward_griffin' || (p.mutations && p.mutations.includes('revival')));
            state.inventory = [...keepPets]; 
            state.money = 0;
            state.upgrades = { luck: 0, income: 0, clickPower: 0, autoClicker: 0, criticalClicks: 0, eggDiscount: 0, petBonus: 0, multiHatch: 0 };
            state.rebirth.level = nextRebirth.level;
            state.rebirth.multiplier = nextRebirth.multiplier;
            state.settings.hatchAmount = 1; 
            state.currentWorld = 'home';
            state.currentGalaxy = 'origin';
            saveGame(); closeRebirthModal(); renderInventory(); renderUpgrades(); renderShop(); updateUI(); updateAutoClicker();
            showToast(`Rebirth Successful! Multiplier: x${state.rebirth.multiplier}`);
        }

        // --- ACHIEVEMENTS ---
        function checkAchievements() {
            // Ensure state is properly initialized
            if (!state.stats) {
                state.stats = {
                    totalClicks: 0,
                    totalEggs: 0,
                    totalMerges: 0,
                    totalMoney: 0
                };
            }
            if (!state.inventory) state.inventory = [];
            if (!state.achievements) state.achievements = [];

            let newAchievements = [];
            Object.values(ACHIEVEMENTS).forEach(achievement => {
                if (!state.achievements.includes(achievement.id) && achievement.condition(state)) {
                    state.achievements.push(achievement.id);
                    newAchievements.push(achievement);
                }
            });

            if (newAchievements.length > 0) {
                newAchievements.forEach(achievement => {
                    showToast(`Achievement Unlocked: ${achievement.name}!`);
                });
                renderAchievements();
                saveGame();
            }

            // Always update achievements display
            renderAchievements();
        }

        /* --- EGG INFO MODAL SYSTEM --- */
        function showEggInfo(eggId) {
            const egg = EGGS.find(e => e.id === eggId);
            if (!egg) return;

            const modal = document.getElementById('egg-info-modal');
            const title = document.getElementById('egg-info-title');
            const list = document.getElementById('egg-info-list');

            // Set title with egg icon and name
            title.innerHTML = `${egg.icon} ${egg.name} Drop Rates`;

            // Calculate drop rates with trust bonuses
            const trustBonus = getTrustBonus();
            const adjustedPool = {};

            Object.entries(egg.pool).forEach(([petId, baseChance]) => {
                let adjustedChance = baseChance;
                // Apply trust bonus to rare+ pets
                if (PETS[petId] && ['Rare', 'Epic', 'Legendary', 'Mythical', 'Godly', 'Transcendent', 'Cosmic'].includes(PETS[petId].rarity)) {
                    adjustedChance *= (1 + trustBonus);
                }
                adjustedPool[petId] = adjustedChance;
            });

            // Normalize probabilities
            const totalChance = Object.values(adjustedPool).reduce((sum, chance) => sum + chance, 0);
            Object.keys(adjustedPool).forEach(petId => {
                adjustedPool[petId] = adjustedPool[petId] / totalChance;
            });

            // Sort by probability (highest first)
            const sortedDrops = Object.entries(adjustedPool)
                .map(([petId, chance]) => ({ pet: PETS[petId], chance }))
                .filter(drop => drop.pet)
                .sort((a, b) => b.chance - a.chance);

            // Generate HTML for drop list
            list.innerHTML = sortedDrops.map(drop => {
                const percentage = (drop.chance * 100).toFixed(2);
                const rarityColor = {
                    'Common': 'text-gray-600',
                    'Uncommon': 'text-green-600',
                    'Rare': 'text-blue-600',
                    'Epic': 'text-purple-600',
                    'Legendary': 'text-orange-600',
                    'Mythical': 'text-red-600',
                    'Godly': 'text-yellow-600',
                    'Transcendent': 'text-pink-600',
                    'Cosmic': 'text-indigo-600'
                }[drop.pet.rarity] || 'text-gray-600';

                return `
                    <div class="flex items-center justify-between p-3 rounded-lg bg-gray-50 border border-gray-200 hover:bg-gray-100 transition">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">${drop.pet.icon}</div>
                            <div>
                                <div class="font-bold text-sm text-gray-800">${drop.pet.name}</div>
                                <div class="text-xs uppercase font-semibold ${rarityColor}">${drop.pet.rarity}</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-lg text-gray-800">${percentage}%</div>
                            <div class="text-xs text-gray-500">+$${formatCompact(drop.pet.rate)}/s</div>
                        </div>
                    </div>
                `;
            }).join('');

            modal.classList.remove('hidden');
        }

        function closeEggInfo() {
            document.getElementById('egg-info-modal').classList.add('hidden');
        }

        /* --- PET TOOLTIP SYSTEM --- */
        function showPetTooltip(petId, count, event) {
            const pet = PETS[petId];
            if (!pet) return;

            const tooltip = document.getElementById('pet-tooltip');
            const content = document.getElementById('pet-tooltip-content');

            // Calculate effective income (with upgrades)
            const incomeMultiplier = 1 + UPGRADES.income.getEffect(state.upgrades.income);
            const petBonus = 1 + UPGRADES.petBonus.getEffect(state.upgrades.petBonus);
            const effectiveRate = Math.floor(pet.rate * incomeMultiplier * petBonus);

            content.innerHTML = `
                <div class="font-bold text-lg mb-2 flex items-center gap-2">
                    <span class="text-2xl">${pet.icon}</span>
                    <span>${pet.name}</span>
                </div>
                <div class="space-y-1 text-xs">
                    <div><strong>Rarity:</strong> <span class="capitalize">${pet.rarity}</span></div>
                    <div><strong>Owned:</strong> ${count}</div>
                    <div><strong>Base Income:</strong> $${pet.rate.toLocaleString()}/s</div>
                    <div><strong>Effective Income:</strong> $${effectiveRate.toLocaleString()}/s</div>
                    ${pet.next ? `<div><strong>Next Tier:</strong> ${PETS[pet.next].icon} ${PETS[pet.next].name}</div>` : '<div><strong>Max Tier</strong></div>'}
                </div>
            `;

            // Position tooltip near mouse cursor
            const rect = event.target.getBoundingClientRect();
            tooltip.style.left = (rect.left + rect.width / 2) + 'px';
            tooltip.style.top = (rect.top - 10) + 'px';
            tooltip.style.transform = 'translate(-50%, -100%)';
            tooltip.style.opacity = '1';
        }

        function hidePetTooltip() {
            const tooltip = document.getElementById('pet-tooltip');
            tooltip.style.opacity = '0';
        }

        function selectPetForMerge(petId) {
            // For now, just show a toast. Could be expanded to merge system
            const pet = PETS[petId];
            showToast(`Selected ${pet.name} for potential merge!`);
        }

        /* --- ACHIEVEMENTS SYSTEM --- */
        function renderAchievements() {
            const container = document.getElementById('achievements-container');
            if (!container) return;

            const achievementsHtml = Object.values(ACHIEVEMENTS).map(achievement => {
                const unlocked = state.achievements.includes(achievement.id);
                return `
                    <div class="bg-white rounded-lg p-2 shadow-sm border-2 ${unlocked ? 'border-yellow-400' : 'border-gray-200'}">
                        <div class="text-center">
                            <div class="text-lg mb-1">üèÜ</div>
                            <div class="text-xs font-bold ${unlocked ? 'text-yellow-600' : 'text-gray-400'}">${achievement.name}</div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = achievementsHtml;

            // Update achievement count
            const totalAchievements = Object.keys(ACHIEVEMENTS).length;
            const unlockedCount = state.achievements.length;
            const countDisplay = document.getElementById('achievement-count');
            if (countDisplay) {
                countDisplay.textContent = `${unlockedCount}/${totalAchievements}`;
            }
        }

        /* --- DAILY REWARDS SYSTEM --- */
        function checkDailyRewards() {
            const now = Date.now();
            const lastClaim = state.dailyRewards.lastClaim;
            const daysSinceLastClaim = Math.floor((now - lastClaim) / (1000 * 60 * 60 * 24));

            if (daysSinceLastClaim >= 1) {
                // New day available
                const streak = state.dailyRewards.streak;
                const reward = calculateDailyReward(streak + 1);

                showToast(`üéÅ Daily reward available! Day ${streak + 1}: ${formatCompact(reward)} coins`);
                // The reward will be claimed when player clicks the claim button
            }
        }

        function calculateDailyReward(day) {
            // Base reward increases with streak, with bonuses for milestones
            let base = 1000 * day;
            if (day >= 7) base *= 2; // Week streak bonus
            if (day >= 30) base *= 3; // Month streak bonus
            if (day >= 100) base *= 5; // Century streak bonus
            return base;
        }

        function claimDailyReward() {
            const now = Date.now();
            const lastClaim = state.dailyRewards.lastClaim;
            const daysSinceLastClaim = Math.floor((now - lastClaim) / (1000 * 60 * 60 * 24));

            if (daysSinceLastClaim >= 1) {
                const streak = daysSinceLastClaim === 1 ? state.dailyRewards.streak + 1 : 1;
                const reward = calculateDailyReward(streak);

                state.dailyRewards.lastClaim = now;
                state.dailyRewards.streak = streak;
                state.dailyRewards.claimedDays.push(now);

                addMoney(reward);
                showToast(`üéâ Daily reward claimed! Day ${streak}: +${formatCompact(reward)} coins`);

                updateDailyUI();
                saveGame();
            } else {
                showToast('Daily reward already claimed today!');
            }
        }

        function updateDailyUI() {
            const now = Date.now();
            const lastClaim = state.dailyRewards.lastClaim;
            const daysSinceLastClaim = Math.floor((now - lastClaim) / (1000 * 60 * 60 * 24));
            const canClaim = daysSinceLastClaim >= 1;

            // Update UI elements if they exist
            const dailyBtn = document.getElementById('daily-reward-btn');
            const dailyInfo = document.getElementById('daily-reward-info');

            if (dailyBtn) {
                dailyBtn.disabled = !canClaim;
                dailyBtn.textContent = canClaim ? 'Claim Daily Reward' : 'Already Claimed';
            }

            if (dailyInfo) {
                const streak = state.dailyRewards.streak;
                const nextReward = calculateDailyReward(canClaim ? streak + 1 : streak);
                dailyInfo.textContent = `Streak: ${streak} days | Next: ${formatCompact(nextReward)} coins`;
            }
        }

        function updatePlayTimeUI() {
            const playTimeInfo = getPlayTimeInfo();
            const playtimeInfoEl = document.getElementById('playtime-info');
            const nextPlaytimeEl = document.getElementById('next-playtime');

            if (playtimeInfoEl) {
                playtimeInfoEl.textContent = `${playTimeInfo.hours}h ${playTimeInfo.minutes % 60}m played`;
            }

            if (nextPlaytimeEl && playTimeInfo.nextReward) {
                const remainingHours = playTimeInfo.nextReward.hours - playTimeInfo.hours;
                nextPlaytimeEl.textContent = `${remainingHours}h (${formatCompact(playTimeInfo.nextReward.reward)} coins)`;
            } else if (nextPlaytimeEl) {
                nextPlaytimeEl.textContent = 'All claimed!';
            }
        }

        /* --- PLAY TIME REWARDS SYSTEM --- */
        function updatePlayTime() {
            const now = Date.now();
            const timeDiff = Math.floor((now - state.playTime.lastUpdate) / 1000);
            state.playTime.totalSeconds += timeDiff;
            state.playTime.lastUpdate = now;

            checkPlayTimeRewards();
        }

        function checkPlayTimeRewards() {
            const totalHours = Math.floor(state.playTime.totalSeconds / 3600);
            const rewards = [
                { hours: 1, reward: 1000, name: '1 Hour Player' },
                { hours: 5, reward: 5000, name: '5 Hour Veteran' },
                { hours: 10, reward: 10000, name: '10 Hour Expert' },
                { hours: 25, reward: 25000, name: '25 Hour Master' },
                { hours: 50, reward: 50000, name: '50 Hour Legend' },
                { hours: 100, reward: 100000, name: '100 Hour Champion' },
                { hours: 250, reward: 250000, name: '250 Hour Hero' },
                { hours: 500, reward: 500000, name: '500 Hour Titan' },
                { hours: 1000, reward: 1000000, name: '1000 Hour God' }
            ];

            rewards.forEach(reward => {
                if (totalHours >= reward.hours && !state.playTime.rewards.includes(reward.hours)) {
                    state.playTime.rewards.push(reward.hours);
                    addMoney(reward.reward);
                    showToast(`‚è∞ Play Time Reward: ${reward.name}! +${formatCompact(reward.reward)} coins`);
                }
            });
        }

        function getPlayTimeInfo() {
            const totalHours = Math.floor(state.playTime.totalSeconds / 3600);
            const totalMinutes = Math.floor(state.playTime.totalSeconds / 60);
            return {
                hours: totalHours,
                minutes: totalMinutes,
                nextReward: getNextPlayTimeReward(totalHours)
            };
        }

        function getNextPlayTimeReward(currentHours) {
            const rewards = [1, 5, 10, 25, 50, 100, 250, 500, 1000];
            for (let reward of rewards) {
                if (currentHours < reward && !state.playTime.rewards.includes(reward)) {
                    return { hours: reward, reward: calculatePlayTimeReward(reward) };
                }
            }
            return null;
        }

        function calculatePlayTimeReward(hours) {
            const rewards = {
                1: 1000, 5: 5000, 10: 10000, 25: 25000, 50: 50000,
                100: 100000, 250: 250000, 500: 500000, 1000: 1000000
            };
            return rewards[hours] || 0;
        }

        /* --- TRUST SYSTEM --- */
        function checkQuests() {
            if (!state.trust) {
                state.trust = { level: 1, experience: 0, questsCompleted: [] };
            }

            let newQuests = [];
            Object.values(QUESTS).forEach(quest => {
                if (!state.trust.questsCompleted.includes(quest.id) && quest.condition(state)) {
                    state.trust.questsCompleted.push(quest.id);
                    state.trust.experience += quest.reward;
                    newQuests.push(quest);
                }
            });

            // Level up logic
            const expNeeded = state.trust.level * 100;
            while (state.trust.experience >= expNeeded) {
                state.trust.experience -= expNeeded;
                state.trust.level++;
                showToast(`üèÜ Trust Level Up! Now level ${state.trust.level}!`);
            }

            if (newQuests.length > 0) {
                newQuests.forEach(quest => {
                    showToast(`üìú Quest Completed: ${quest.name}! (+${quest.reward} trust)`);
                });
                renderQuests();
                saveGame();
            }
        }

        function getTrustBonus() {
            // Trust increases drop rates for good pets in cosmic/kitchen eggs
            return state.trust.level * 0.05; // 5% per level
        }

        function renderQuests() {
            const container = document.getElementById('quests-container');
            if (!container) return;

            const questsHtml = Object.values(QUESTS).map(quest => {
                const completed = state.trust.questsCompleted.includes(quest.id);
                return `
                    <div class="bg-white rounded-lg p-3 shadow-sm border-2 ${completed ? 'border-green-400' : 'border-gray-200'}">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-bold text-sm ${completed ? 'text-green-600' : 'text-gray-800'}">${quest.name}</h4>
                            <span class="text-xs ${completed ? 'text-green-600' : 'text-gray-500'}">+${quest.reward} trust</span>
                        </div>
                        <p class="text-xs text-gray-600 mb-2">${quest.description}</p>
                        <div class="text-xs ${completed ? 'text-green-600 font-bold' : 'text-gray-400'}">
                            ${completed ? '‚úÖ Completed' : '‚è≥ In Progress'}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = questsHtml;

            // Update trust display
            const trustDisplay = document.getElementById('trust-display');
            if (trustDisplay) {
                trustDisplay.textContent = `Trust Level: ${state.trust.level} (${state.trust.experience}/${state.trust.level * 100} XP)`;
            }
        }

        // --- HATCHING ---
        function startHatchingSequence(egg, count = 1) {
            const overlay = document.getElementById('hatch-overlay');
            const eggContainer = document.getElementById('hatch-egg-display'); 
            const message = document.getElementById('hatch-message');
            document.getElementById('new-pet-card').classList.add('hidden');
            document.getElementById('multi-pet-grid').classList.add('hidden');
            document.getElementById('multi-hatch-close-btn').classList.add('hidden');
            
            eggContainer.classList.remove('hidden', 'pop-in');
            eggContainer.style.transform = 'scale(1)';
            message.innerText = count > 1 ? "Tap to Hatch All!" : "Tap to Hatch!";
            message.classList.remove('hidden');
            document.getElementById('hatch-rays').style.opacity = '0';

            if (count === 1) {
                eggContainer.className = "text-9xl transition-all duration-300 cursor-pointer relative z-10 select-none";
                eggContainer.innerHTML = egg.icon;
            } else {
                eggContainer.className = "grid grid-cols-3 gap-4 transition-all duration-300 cursor-pointer relative z-10 select-none max-w-md mx-auto";
                eggContainer.innerHTML = Array(count).fill(`<div class="text-6xl animate-bounce">${egg.icon}</div>`).join('');
            }
            overlay.classList.remove('hidden');
            eggContainer.onclick = function() {
                if(count === 1) eggContainer.classList.add('shake-animation');
                message.innerText = "Cracking...";
                setTimeout(() => revealBatch(egg, count), 1000);
                eggContainer.onclick = null;
            };
        }

        function revealBatch(egg, count) {
            const results = [];
            let highestRarityScore = 0; 
            const getRarityVal = (r) => ({'Common':1,'Uncommon':2,'Rare':3,'Epic':4,'Legendary':5,'Mythical':6,'Godly':7,'Transcendent':8, 'Eternal':9})[r]||0;

            for(let i=0; i<count; i++) {
                const petId = rollPet(egg.pool, egg.id);
                if(petId && PETS[petId]) {
                    const newPet = { id: petId, uid: Date.now() + i, mutations: [] };
                    state.inventory.push(newPet);
                    if (!state.collection.includes(petId)) state.collection.push(petId);
                    results.push(PETS[petId]);
                    const score = getRarityVal(PETS[petId].rarity);
                    if(score > highestRarityScore) highestRarityScore = score;
                }
            }
            document.getElementById('hatch-egg-display').classList.add('hidden');
            document.getElementById('hatch-message').classList.add('hidden');

            if (results.length === 1) {
                const pet = results[0];
                document.getElementById('reveal-icon').innerText = pet.icon;
                document.getElementById('reveal-name').innerText = pet.name;
                document.getElementById('reveal-rarity').innerText = pet.rarity;
                document.getElementById('reveal-rate').innerText = pet.rate.toLocaleString();
                document.getElementById('reveal-card-bg').className = `bg-white p-6 rounded-2xl shadow-2xl text-center w-64 border-4 rarity-${pet.rarity.toLowerCase()}`;
                document.getElementById('new-pet-card').classList.remove('hidden');
            } else {
                const grid = document.getElementById('multi-pet-grid');
                grid.innerHTML = results.map(pet => `
                    <div class="bg-white p-3 rounded-xl shadow-lg border-2 rarity-${pet.rarity.toLowerCase()} flex flex-col items-center pop-in transform transition hover:scale-105 text-gray-800">
                        <div class="text-[10px] font-bold uppercase mb-1 opacity-70">${pet.rarity}</div>
                        <div class="text-5xl mb-2">${pet.icon}</div>
                        <div class="font-bold text-sm text-center w-full">${pet.name}</div>
                    </div>`).join('');
                grid.classList.remove('hidden');
                document.getElementById('multi-hatch-close-btn').classList.remove('hidden');
            }
            if(highestRarityScore >= 4) document.getElementById('hatch-rays').style.opacity = '0.5';
            saveGame(); renderInventory(); updateUI();
        }

        function rollPet(pool, eggId = null) {
            let adjustedPool = { ...pool };

            // Apply trust bonus to cosmic/kitchen eggs
            if (eggId && (eggId.includes('cosmic') || eggId.includes('celestial') || eggId.includes('ultimate') || eggId.includes('ether') || eggId.includes('eclipse'))) {
                const trustBonus = getTrustBonus();
                const totalChance = Object.values(adjustedPool).reduce((sum, chance) => sum + chance, 0);

                // Boost rare pet chances with trust
                Object.keys(adjustedPool).forEach(petId => {
                    if (PETS[petId] && ['Rare', 'Epic', 'Legendary', 'Mythical', 'Godly', 'Transcendent', 'Cosmic', 'Special'].includes(PETS[petId].rarity)) {
                        adjustedPool[petId] = adjustedPool[petId] * (1 + trustBonus);
                    }
                });

                // Normalize probabilities
                const newTotal = Object.values(adjustedPool).reduce((sum, chance) => sum + chance, 0);
                Object.keys(adjustedPool).forEach(petId => {
                    adjustedPool[petId] = adjustedPool[petId] * (totalChance / newTotal);
                });
            }

            const rand = Math.random();
            let cumulative = 0;
            for (const [petId, chance] of Object.entries(adjustedPool)) {
                cumulative += chance;
                if (rand < cumulative) return petId;
            }
            return Object.keys(adjustedPool)[0];
        }

        function closeHatchModal() { document.getElementById('hatch-overlay').classList.add('hidden'); }

        // --- MERGE ---
        function openMergeModal() {
            const modal = document.getElementById('merge-modal');
            modal.classList.remove('hidden');
            const counts = {};
            state.inventory.forEach(p => counts[p.id] = (counts[p.id] || 0) + 1);
            const mergeable = Object.entries(counts).filter(([id, count]) => count >= 3 && PETS[id] && PETS[id].next).map(([id, count]) => ({ id, count, pet: PETS[id] }));
            const list = document.getElementById('merge-list');
            const msg = document.getElementById('no-merge-msg');
            if (mergeable.length === 0) { list.innerHTML = ''; msg.classList.remove('hidden'); return; }
            msg.classList.add('hidden');
            list.innerHTML = mergeable.map(m => `<div class="bg-white border-2 border-blue-100 p-4 rounded-xl flex items-center justify-between shadow-sm text-gray-800"><div class="flex items-center gap-4"><div class="relative"><div class="text-4xl">${m.pet.icon}</div><div class="absolute -bottom-1 -right-1 bg-blue-600 text-white text-[10px] px-1.5 rounded-full font-bold">x${m.count}</div></div><div><div class="font-bold">${m.pet.name}</div><div class="text-xs text-blue-500">Merge 3 -> ${PETS[m.pet.next].icon} ?</div></div></div><button onclick="performMerge('${m.id}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Merge</button></div>`).join('');
        }
        function closeMergeModal() { document.getElementById('merge-modal').classList.add('hidden'); }
        function performMerge(petId) {
            const eligible = state.inventory.filter(p => p.id === petId);
            if (eligible.length < 3) { showToast("Not enough pets!"); return; }
            const toRemove = eligible.slice(0, 3).map(p => p.uid);
            state.inventory = state.inventory.filter(p => !toRemove.includes(p.uid));
            const nextId = PETS[petId].next;
            if (Math.random() < 0.75) {
                state.inventory.push({ id: nextId, uid: Date.now(), mutations: [] });
                if (!state.collection.includes(nextId)) state.collection.push(nextId);
                showToast("Merge Success!");
            } else { showToast("Merge Failed!"); }
            saveGame(); renderInventory(); updateUI(); openMergeModal();
        }

        // --- UPGRADES ---
        function buyUpgrade(upgradeId) {
            const upgrade = UPGRADES[upgradeId];
            if (!upgrade) return;
            const currentLevel = state.upgrades[upgradeId] || 0;
            if (currentLevel >= upgrade.maxLevel) { showToast("Max level reached!"); return; }
            const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costMultiplier, currentLevel));
            if (state.money >= cost) {
                state.money -= cost;
                state.upgrades[upgradeId] = currentLevel + 1;
                updateUI(); renderUpgrades();
                if (upgradeId === 'autoClicker') updateAutoClicker();
                if (upgradeId === 'eggDiscount' || upgradeId === 'multiHatch') renderShop();
                saveGame();
                showToast(`${upgrade.name} upgraded!`);
            } else { showToast("Not enough money!"); }
        }

        function renderUpgrades() {
            const container = document.getElementById('upgrades-container');
            container.innerHTML = Object.entries(UPGRADES).map(([id, upgrade]) => {
                const currentLevel = state.upgrades[id] || 0;
                const maxed = currentLevel >= upgrade.maxLevel;
                const cost = maxed ? 0 : Math.floor(upgrade.baseCost * Math.pow(upgrade.costMultiplier, currentLevel));
                
                let sliderHTML = '';
                if (id === 'multiHatch' && currentLevel > 0) {
                    const maxHatch = 1 + upgrade.getEffect(currentLevel);
                    if (state.settings.hatchAmount > maxHatch) state.settings.hatchAmount = maxHatch;
                    sliderHTML = `<div class="mt-2 mb-2 p-2 bg-gray-100/80 rounded"><div class="flex justify-between text-xs font-bold mb-1 text-gray-600"><span>Hatch Amount</span><span id="hatch-amount-display">${state.settings.hatchAmount}x</span></div><input type="range" id="hatch-amount-slider" min="1" max="${maxHatch}" value="${state.settings.hatchAmount}" class="w-full accent-blue-500 cursor-pointer" oninput="updateHatchSetting(this.value)"></div>`;
                }

                return `<div class="bg-white/90 backdrop-blur rounded-xl p-3 shadow-md text-gray-800"><div class="flex items-center gap-3 mb-1"><div class="text-2xl">${upgrade.icon}</div><div><div class="font-bold text-md leading-none">${upgrade.name}</div><div class="text-[10px] text-gray-500">${upgrade.description}</div></div></div>${sliderHTML}<div class="flex items-center justify-between"><div class="text-xs text-gray-500">Lvl ${currentLevel}/${upgrade.maxLevel}</div>${maxed ? `<div class="text-green-600 font-bold text-xs">MAX</div>` : `<button onclick="buyUpgrade('${id}')" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-bold py-1 px-3 rounded-lg transition active:scale-95">$${formatCompact(cost)}</button>`}</div></div>`;
            }).join('');
        }

        function updateAutoClicker() {
            if (autoClickerInterval) { clearInterval(autoClickerInterval); autoClickerInterval = null; }
            const clicksPerSecond = UPGRADES.autoClicker.getEffect(state.upgrades.autoClicker || 0);
            if (clicksPerSecond > 0) autoClickerInterval = setInterval(() => manualClick(null, true), 1000 / clicksPerSecond);
        }

        // --- ADMIN & UTILS ---
        function openAdminModal() { document.getElementById('admin-modal').classList.remove('hidden'); document.getElementById('admin-login-view').classList.remove('hidden'); document.getElementById('admin-dashboard-view').classList.add('hidden'); }
        function closeAdminModal() { document.getElementById('admin-modal').classList.add('hidden'); }
        function checkAdminPassword() { if(document.getElementById('admin-password-input').value === '7450') { document.getElementById('admin-login-view').classList.add('hidden'); document.getElementById('admin-dashboard-view').classList.remove('hidden'); populateAdminPetList(); } }
        function populateAdminPetList() { document.getElementById('admin-pet-select').innerHTML = Object.values(PETS).map(p => `<option value="${p.id}">${p.name}</option>`).join(''); }
        function adminAddMoney() { const amt = parseInt(document.getElementById('admin-money-input').value); if(amt>0) addMoney(amt); }
        function adminAddPet() { const id = document.getElementById('admin-pet-select').value; if(id) { state.inventory.push({id:id, uid:Date.now(), mutations:[]}); renderInventory(); } }
        function adminSetRebirth() { state.rebirth.level = parseInt(document.getElementById('admin-rebirth-input').value); saveGame(); location.reload(); }

        // --- UI & OTHER ---
        function renderShop() {
            const currentGalaxy = GALAXIES.find(g => g.id === state.currentGalaxy) || GALAXIES[0];
            if(currentGalaxy.id === 'apocalypse' && !state.stats.radioactiveDiscovery) { state.currentGalaxy = 'origin'; }
            const currentWorld = WORLDS.find(w => w.id === state.currentWorld) || WORLDS[0];
            
            document.getElementById('world-status').innerText = `${currentGalaxy.name} - ${currentWorld.name}`;
            document.getElementById('game-body').className = `h-screen flex flex-col overflow-hidden text-gray-800 ${currentWorld.bgClass}`;

            document.getElementById('galaxy-nav-container').innerHTML = GALAXIES.map(g => {
                if(g.id === 'apocalypse' && !state.stats.radioactiveDiscovery) return '';
                const locked = state.rebirth.level < g.minRebirth && g.id !== 'apocalypse';
                return `<button onclick="switchGalaxy('${g.id}')" class="flex-shrink-0 px-4 py-1.5 rounded-full text-xs font-bold border transition flex items-center gap-1 ${state.currentGalaxy === g.id ? 'bg-purple-600 text-white' : 'bg-white text-gray-600'}"><span>${g.icon}</span> ${locked ? '<i class="fas fa-lock"></i>' : g.name}</button>`;
            }).join('');

            const worldsInGalaxy = WORLDS.filter(w => currentGalaxy.worlds.includes(w.id));
            document.getElementById('world-nav-container').innerHTML = worldsInGalaxy.map(w => {
                const locked = state.rebirth.level < w.minRebirth;
                return `<button onclick="switchWorld('${w.id}')" class="flex-shrink-0 px-4 py-2 rounded-full text-xs font-bold border transition ${state.currentWorld === w.id ? 'bg-blue-600 text-white' : 'bg-white text-gray-600'}">${locked ? '<i class="fas fa-lock"></i>' : ''} ${w.name}</button>`;
            }).join('');

            const eggsToRender = EGGS.filter(egg => currentWorld.eggIds.includes(egg.id));
            const discount = UPGRADES.eggDiscount.getEffect(state.upgrades.eggDiscount || 0);
            const hatchCount = state.settings.hatchAmount || 1;
            
            document.getElementById('egg-shop-container').innerHTML = eggsToRender.map(egg => {
                const cost = Math.floor(egg.cost * (1 - discount)) * hatchCount;
                return `<div class="rounded-xl p-4 shadow-md bg-white/90 backdrop-blur transition-all hover:-translate-y-1 hover:shadow-lg flex flex-col items-center ${egg.colorClass} text-gray-800"><div class="text-4xl mb-2 cursor-pointer" onclick="showEggInfo('${egg.id}')">${egg.icon}</div><div class="font-bold text-lg">${egg.name}</div><button onclick="buyEgg('${egg.id}')" class="bg-white border-2 border-green-500 text-green-600 font-bold py-1.5 px-6 rounded-full hover:bg-green-500 hover:text-white transition w-full shadow-sm z-10">$${formatCompact(cost)}</button></div>`;
            }).join('');
        }

        function renderInventory() {
            const container = document.getElementById('inventory-container');
            let list = [...state.inventory];
            const mode = state.settings.sortMode || 'newest';
            
            if (mode === 'newest') list.reverse();

            if(list.length === 0) {
                 container.innerHTML = ''; document.getElementById('empty-inventory').style.display = 'block';
            } else {
                document.getElementById('empty-inventory').style.display = 'none';
                const petCounts = {};
                state.inventory.forEach(pet => {
                    petCounts[pet.id] = (petCounts[pet.id] || 0) + 1;
                });

                container.innerHTML = list.map(p => {
                    const pet = PETS[p.id];
                    let base = pet.rate;
                    
                    // Logic to display mutations in top right
                    const mutationsHTML = p.mutations && p.mutations.length > 0 
                        ? `<div class="mutation-container">${renderMutationIcons(p.mutations)}</div>` 
                        : '';

                    if(p.mutations && p.mutations.includes('gold')) base *= 2;
                    const count = petCounts[p.id] || 1;
                    
                    return `<div class="rarity-${pet.rarity.toLowerCase()} rounded-lg p-2 flex flex-col items-center justify-center relative shadow-sm aspect-square transition hover:scale-105 select-none pet-card bg-white/90 backdrop-blur text-gray-800"
                         onmouseenter="showPetTooltip('${p.id}', ${count}, event)"
                         onmouseleave="hidePetTooltip()"
                         onclick="selectPetForMerge('${p.id}')">
                        ${mutationsHTML}
                        <div class="text-3xl mb-1">${pet.icon}</div>
                        <div class="text-xs font-bold truncate w-full text-center">${pet.name}</div>
                        <div class="text-[10px] text-gray-500">+$${formatCompact(base)}/s</div>
                    </div>`;
                }).join('');
            }
            document.getElementById('pet-count').innerText = state.inventory.length;
        }

        function updateUI() {
            document.getElementById('money-display').innerText = formatCompact(Math.floor(state.money));
            document.getElementById('income-display').innerText = formatCompact(calculateIncome());
        }
        function createFloatingText(x, y, text) {
            const el = document.createElement('div'); el.className = 'float-text'; el.style.left = x+'px'; el.style.top = y+'px'; el.innerText = text;
            document.body.appendChild(el); setTimeout(()=>el.remove(), 1000);
        }
        function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.style.opacity = '1'; setTimeout(()=>t.style.opacity='0', 3000); }
        
        // SAVE/LOAD
        function openResetModal() { document.getElementById('reset-modal').classList.remove('hidden'); }
        function closeResetModal() { document.getElementById('reset-modal').classList.add('hidden'); }
        function confirmReset() { localStorage.removeItem('gibchick_save'); location.reload(); }
        function saveGame() { localStorage.setItem('gibchick_save', JSON.stringify(state)); }
        function loadGame() {
            const saved = localStorage.getItem('gibchick_save');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    
                    // Default state definition for robustness
                    const defaultState = {
                        money: 0,
                        inventory: [],
                        collection: [],
                        cosmosSlots: [],
                        upgrades: { luck: 0, income: 0, clickPower: 0, autoClicker: 0, criticalClicks: 0, eggDiscount: 0, petBonus: 0, multiHatch: 0, offlineProgress: 0, prestigeBonus: 0, goldenEggs: 0, petEvolution: 0, luckBoost: 0 },
                        rebirth: { level: 0, multiplier: 1 },
                        achievements: [],
                        trust: { level: 1, experience: 0, questsCompleted: [] },
                        dailyRewards: { lastClaim: 0, streak: 0, claimedDays: [] },
                        playTime: { totalSeconds: 0, lastUpdate: Date.now(), rewards: [] },
                        currentWorld: 'home',
                        currentGalaxy: 'origin',
                        settings: { hatchAmount: 1, sortMode: 'rarity_desc' },
                        stats: { totalClicks: 0, totalEggs: 0, totalMerges: 0, totalMoney: 0, radioactiveDiscovery: false },
                        lastSave: Date.now()
                    };

                    // Deep merge objects that might have new keys
                    state = { ...defaultState, ...parsed };
                    
                    // Specifically merge nested objects that change frequently
                    state.upgrades = { ...defaultState.upgrades, ...(parsed.upgrades || {}) };
                    state.stats = { ...defaultState.stats, ...(parsed.stats || {}) };
                    state.trust = { ...defaultState.trust, ...(parsed.trust || {}) };
                    state.playTime = { ...defaultState.playTime, ...(parsed.playTime || {}) };
                    
                    if (state.inventory.length > 0 && typeof state.inventory[0] === 'string') {
                         state.inventory = state.inventory.map((id, i) => ({ id: id, uid: Date.now() + i, mutations: [] }));
                    }
                    if(!state.cosmosSlots) state.cosmosSlots = [];
                } catch(e) { console.error(e); }
            }
        }
    </script>
</body>
</html>
